<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Order Search</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    .header {
      background: #2c2c2c;
      color: #fff;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header h1 {
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .back-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
    }
    .back-btn:hover { background: #0056b3; }
    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 12px 24px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .tab-btn:hover { background: #f8f9fa; }
    .tab-btn.active {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }

    .panel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      display: none;
    }
    .panel.active { display: block; }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    .panel-header h2 {
      font-size: 18px;
      color: #333;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    .btn-primary { background: #007bff; color: white; }
    .btn-primary:hover { background: #0056b3; }
    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-danger:hover { background: #c82333; }
    .btn-warning { background: #ffc107; color: #000; }
    .btn-warning:hover { background: #e0a800; }
    .btn-sm { padding: 6px 12px; font-size: 13px; }

    /* Users Table */
    .users-table {
      width: 100%;
      border-collapse: collapse;
    }
    .users-table th,
    .users-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .users-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
      font-size: 13px;
      text-transform: uppercase;
    }
    .users-table tr:hover { background: #f8f9fa; }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-admin { background: #007bff; color: white; }
    .badge-user { background: #6c757d; color: white; }
    .badge-active { background: #d4edda; color: #155724; }
    .badge-inactive { background: #f8d7da; color: #721c24; }
    .badge-locked { background: #fff3cd; color: #856404; }

    .actions { display: flex; gap: 8px; }

    /* Login Attempts Table */
    .attempts-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .attempts-table th,
    .attempts-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .attempts-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #555;
      font-size: 12px;
      text-transform: uppercase;
    }
    .attempts-table tr:hover { background: #f8f9fa; }
    .attempt-success { color: #28a745; }
    .attempt-failed { color: #dc3545; }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: white;
      border-radius: 8px;
      width: 100%;
      max-width: 450px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 { font-size: 18px; }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    .modal-body { padding: 20px; }
    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
    }
    .form-group input[type="text"],
    .form-group input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 15px;
    }
    .form-group input:focus {
      outline: none;
      border-color: #007bff;
    }
    .form-check {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .form-check input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .form-help {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .refresh-btn {
      background: #f8f9fa;
      border: 1px solid #ddd;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .refresh-btn:hover { background: #e9ecef; }

    .stats-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 6px;
      flex: 1;
    }
    .stat-card h4 {
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
    }
    .stat-card .number {
      font-size: 28px;
      font-weight: 700;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üîß Admin Panel</h1>
    <div class="header-right">
      <a href="/" class="back-btn">‚Üê Back to Orders</a>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab('users')">üë• Users</button>
      <button class="tab-btn" onclick="showTab('attempts')">üìã Login Attempts</button>
      <button class="tab-btn" onclick="showTab('searches')">üîç Search Audit</button>
    </div>

    <!-- Users Panel -->
    <div class="panel active" id="panel-users">
      <div class="panel-header">
        <h2>User Management</h2>
        <button class="btn btn-primary" onclick="showAddUserModal()">+ Add User</button>
      </div>

      <div class="stats-row" id="userStats"></div>

      <table class="users-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Role</th>
            <th>Status</th>
            <th>Last Login</th>
            <th>Failed Attempts</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="usersTableBody">
          <tr><td colspan="6" class="no-data">Loading users...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Login Attempts Panel -->
    <div class="panel" id="panel-attempts">
      <div class="panel-header">
        <h2>Recent Login Attempts</h2>
        <button class="refresh-btn" onclick="loadLoginAttempts()">‚Üª Refresh</button>
      </div>

      <table class="attempts-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Username</th>
            <th>IP Address</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody id="attemptsTableBody">
          <tr><td colspan="4" class="no-data">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <!-- Search Audit Panel -->
    <div class="panel" id="panel-searches">
      <div class="panel-header">
        <h2>Search Audit Log</h2>
        <div style="display:flex; gap:10px; align-items:center;">
          <input type="text" id="auditFilterUser" placeholder="Filter by username..." style="padding:7px 10px; border:1px solid #ddd; border-radius:4px; font-size:14px; width:200px;" onkeypress="if(event.key==='Enter')loadSearchAudit()">
          <button class="btn btn-primary btn-sm" onclick="loadSearchAudit()">Filter</button>
          <button class="refresh-btn" onclick="document.getElementById('auditFilterUser').value=''; loadSearchAudit()">Clear</button>
        </div>
      </div>

      <div id="auditStats" style="display:flex; gap:15px; margin-bottom:15px;"></div>

      <table class="attempts-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>User</th>
            <th>Store</th>
            <th>Type</th>
            <th>Query</th>
            <th>Results</th>
          </tr>
        </thead>
        <tbody id="searchesTableBody">
          <tr><td colspan="6" class="no-data">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Add/Edit User Modal -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Add User</h3>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editUserId">
        <div class="form-group">
          <label for="modalUsername">Username</label>
          <input type="text" id="modalUsername" placeholder="Enter username">
        </div>
        <div class="form-group">
          <label for="modalPassword">Password</label>
          <input type="password" id="modalPassword" placeholder="Enter password">
          <div class="form-help" id="passwordHelp">Minimum 6 characters</div>
        </div>
        <div class="form-group">
          <div class="form-check">
            <input type="checkbox" id="modalIsAdmin">
            <label for="modalIsAdmin">Administrator</label>
          </div>
        </div>
        <div class="form-group" id="activeGroup" style="display: none;">
          <div class="form-check">
            <input type="checkbox" id="modalIsActive" checked>
            <label for="modalIsActive">Active</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" id="saveUserBtn" onclick="saveUser()">Save</button>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div class="modal" id="deleteModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Confirm Delete</h3>
        <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete user <strong id="deleteUsername"></strong>?</p>
        <p style="color: #dc3545; margin-top: 10px;">This action cannot be undone.</p>
        <input type="hidden" id="deleteUserId">
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    let users = [];

    // Check auth on load
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth-check');
        const data = await response.json();

        if (!data.authenticated || !data.isAdmin) {
          window.location.href = '/';
          return;
        }

        loadUsers();
      } catch (err) {
        window.location.href = '/login';
      }
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
      
      document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
      document.getElementById(`panel-${tab}`).classList.add('active');

      if (tab === 'attempts') loadLoginAttempts();
      if (tab === 'searches') loadSearchAudit();
    }

    async function loadUsers() {
      try {
        const response = await fetch('/api/admin/users');
        const data = await response.json();

        if (!response.ok) throw new Error(data.error);

        users = data.users;
        renderUsers();
        renderStats();
      } catch (err) {
        document.getElementById('usersTableBody').innerHTML = 
          `<tr><td colspan="6" class="no-data" style="color: #dc3545;">${err.message}</td></tr>`;
      }
    }

    function renderStats() {
      const total = users.length;
      const active = users.filter(u => u.is_active).length;
      const admins = users.filter(u => u.is_admin).length;
      const locked = users.filter(u => u.locked_until && new Date(u.locked_until) > new Date()).length;

      document.getElementById('userStats').innerHTML = `
        <div class="stat-card">
          <h4>Total Users</h4>
          <div class="number">${total}</div>
        </div>
        <div class="stat-card">
          <h4>Active</h4>
          <div class="number">${active}</div>
        </div>
        <div class="stat-card">
          <h4>Admins</h4>
          <div class="number">${admins}</div>
        </div>
        <div class="stat-card">
          <h4>Locked</h4>
          <div class="number" style="color: ${locked > 0 ? '#dc3545' : '#333'}">${locked}</div>
        </div>
      `;
    }

    function renderUsers() {
      const tbody = document.getElementById('usersTableBody');

      if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No users found</td></tr>';
        return;
      }

      tbody.innerHTML = users.map(user => {
        const isLocked = user.locked_until && new Date(user.locked_until) > new Date();
        const lastLogin = user.last_login 
          ? new Date(user.last_login).toLocaleString()
          : 'Never';

        return `
          <tr>
            <td><strong>${user.username}</strong></td>
            <td>
              <span class="badge ${user.is_admin ? 'badge-admin' : 'badge-user'}">
                ${user.is_admin ? 'Admin' : 'User'}
              </span>
            </td>
            <td>
              ${!user.is_active 
                ? '<span class="badge badge-inactive">Inactive</span>'
                : isLocked 
                  ? '<span class="badge badge-locked">Locked</span>'
                  : '<span class="badge badge-active">Active</span>'
              }
            </td>
            <td>${lastLogin}</td>
            <td>${user.failed_attempts || 0}</td>
            <td class="actions">
              <button class="btn btn-sm btn-primary" onclick="showEditUserModal(${user.id})">Edit</button>
              ${isLocked ? `<button class="btn btn-sm btn-warning" onclick="unlockUser(${user.id})">Unlock</button>` : ''}
              <button class="btn btn-sm btn-danger" onclick="showDeleteModal(${user.id}, '${user.username}')">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function loadLoginAttempts() {
      try {
        const response = await fetch('/api/admin/login-attempts?limit=100');
        const data = await response.json();

        if (!response.ok) throw new Error(data.error);

        const tbody = document.getElementById('attemptsTableBody');

        if (data.attempts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="no-data">No login attempts found</td></tr>';
          return;
        }

        tbody.innerHTML = data.attempts.map(attempt => {
          const time = new Date(attempt.attempted_at).toLocaleString();
          return `
            <tr>
              <td>${time}</td>
              <td>${attempt.username || 'unknown'}</td>
              <td><code>${attempt.ip_address}</code></td>
              <td class="${attempt.success ? 'attempt-success' : 'attempt-failed'}">
                ${attempt.success ? '‚úì Success' : '‚úó Failed'}
              </td>
            </tr>
          `;
        }).join('');
      } catch (err) {
        document.getElementById('attemptsTableBody').innerHTML = 
          `<tr><td colspan="4" class="no-data" style="color: #dc3545;">${err.message}</td></tr>`;
      }
    }

    function showAddUserModal() {
      document.getElementById('modalTitle').textContent = 'Add User';
      document.getElementById('editUserId').value = '';
      document.getElementById('modalUsername').value = '';
      document.getElementById('modalPassword').value = '';
      document.getElementById('modalIsAdmin').checked = false;
      document.getElementById('modalIsActive').checked = true;
      document.getElementById('activeGroup').style.display = 'none';
      document.getElementById('passwordHelp').textContent = 'Minimum 6 characters';
      document.getElementById('userModal').classList.add('active');
    }

    function showEditUserModal(userId) {
      const user = users.find(u => u.id === userId);
      if (!user) return;

      document.getElementById('modalTitle').textContent = 'Edit User';
      document.getElementById('editUserId').value = userId;
      document.getElementById('modalUsername').value = user.username;
      document.getElementById('modalPassword').value = '';
      document.getElementById('modalIsAdmin').checked = user.is_admin;
      document.getElementById('modalIsActive').checked = user.is_active;
      document.getElementById('activeGroup').style.display = 'block';
      document.getElementById('passwordHelp').textContent = 'Leave blank to keep current password';
      document.getElementById('userModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('userModal').classList.remove('active');
    }

    async function saveUser() {
      const userId = document.getElementById('editUserId').value;
      const username = document.getElementById('modalUsername').value.trim();
      const password = document.getElementById('modalPassword').value;
      const isAdmin = document.getElementById('modalIsAdmin').checked;
      const isActive = document.getElementById('modalIsActive').checked;

      if (!username) {
        alert('Username is required');
        return;
      }

      if (!userId && !password) {
        alert('Password is required for new users');
        return;
      }

      if (password && password.length < 6) {
        alert('Password must be at least 6 characters');
        return;
      }

      const btn = document.getElementById('saveUserBtn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const body = { username, isAdmin };
        if (password) body.password = password;
        if (userId) body.isActive = isActive;

        const response = await fetch(
          userId ? `/api/admin/users/${userId}` : '/api/admin/users',
          {
            method: userId ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          }
        );

        const data = await response.json();

        if (!response.ok) throw new Error(data.error);

        closeModal();
        loadUsers();
      } catch (err) {
        alert(err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save';
      }
    }

    function showDeleteModal(userId, username) {
      document.getElementById('deleteUserId').value = userId;
      document.getElementById('deleteUsername').textContent = username;
      document.getElementById('deleteModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('active');
    }

    async function confirmDelete() {
      const userId = document.getElementById('deleteUserId').value;

      try {
        const response = await fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.error);

        closeDeleteModal();
        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    }

    async function unlockUser(userId) {
      try {
        const response = await fetch(`/api/admin/users/${userId}/unlock`, {
          method: 'POST'
        });

        const data = await response.json();

        if (!response.ok) throw new Error(data.error);

        loadUsers();
      } catch (err) {
        alert(err.message);
      }
    }

    async function loadSearchAudit() {
      const filterUser = document.getElementById('auditFilterUser').value.trim();
      const url = filterUser
        ? `/api/admin/search-audit?limit=200&username=${encodeURIComponent(filterUser)}`
        : '/api/admin/search-audit?limit=200';

      try {
        const response = await fetch(url);
        const data = await response.json();
        if (!response.ok) throw new Error(data.error);

        const searches = data.searches || [];
        const tbody = document.getElementById('searchesTableBody');

        // Stats bar
        const uniqueUsers = new Set(searches.map(s => s.username)).size;
        const totalResults = searches.reduce((sum, s) => sum + (s.result_count || 0), 0);
        document.getElementById('auditStats').innerHTML = `
          <div class="stat-card"><h4>Searches Shown</h4><div class="number">${searches.length}</div></div>
          <div class="stat-card"><h4>Unique Users</h4><div class="number">${uniqueUsers}</div></div>
          <div class="stat-card"><h4>Total Results Returned</h4><div class="number">${totalResults.toLocaleString()}</div></div>
        `;

        if (searches.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="no-data">No searches found</td></tr>';
          return;
        }

        const typeLabels = { order: 'Order #', email: 'Email', phone: 'Phone', name: 'Name' };
        const typeColors = { order: '#007bff', email: '#17a2b8', phone: '#6f42c1', name: '#fd7e14' };

        tbody.innerHTML = searches.map(s => {
          const time = new Date(s.searched_at).toLocaleString();
          const typeLabel = typeLabels[s.search_type] || s.search_type;
          const typeColor = typeColors[s.search_type] || '#6c757d';
          const resultColor = s.result_count === 0 ? '#dc3545' : '#28a745';
          return `<tr>
            <td style="white-space:nowrap; font-size:13px;">${time}</td>
            <td><strong>${s.username}</strong></td>
            <td>${s.store}</td>
            <td><span style="background:${typeColor}22; color:${typeColor}; padding:2px 8px; border-radius:10px; font-size:12px; font-weight:600;">${typeLabel}</span></td>
            <td style="font-family:monospace; font-size:13px;">${s.query}</td>
            <td style="font-weight:600; color:${resultColor};">${s.result_count}</td>
          </tr>`;
        }).join('');

      } catch (err) {
        document.getElementById('searchesTableBody').innerHTML =
          `<tr><td colspan="6" class="no-data" style="color:#dc3545;">${err.message}</td></tr>`;
      }
    }

    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = '/login';
    }

    // Initialize
    checkAuth();
  </script>
</body>
</html>
