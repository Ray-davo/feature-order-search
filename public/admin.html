<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin ‚Äî Order Search</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    /* ‚îÄ‚îÄ Admin page layout only ‚Äî all colors/fonts from style.css ‚îÄ‚îÄ */

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 9px 20px;
      background: var(--color-surface);
      border: 1.5px solid var(--color-border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: var(--font-base);
      font-size: 14px;
      font-weight: 600;
      color: var(--color-text-secondary);
      transition: all 0.15s;
    }
    .tab-btn:hover { background: var(--color-surface-hover); color: var(--color-text); }
    .tab-btn.active {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }

    .panel { display: none; }
    .panel.active { display: block; }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--color-border);
    }
    .panel-header h2 {
      font-size: 18px;
      font-weight: 700;
      color: var(--color-text);
    }

    .refresh-btn {
      background: var(--color-surface);
      border: 1.5px solid var(--color-border);
      padding: 8px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: var(--font-base);
      font-size: 14px;
      font-weight: 500;
      color: var(--color-text-secondary);
      transition: background 0.13s;
    }
    .refresh-btn:hover { background: var(--color-surface-hover); }

    .permissions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }
    .permission-category {
      background: var(--color-surface-alt);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: 16px;
    }
    .permission-category h4 {
      font-size: 13px;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--color-border);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .permission-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--color-border-light);
    }
    .permission-item:last-child { border-bottom: none; }
    .permission-item input[type="checkbox"] { margin-top: 3px; flex-shrink: 0; }
    .permission-item label { flex: 1; cursor: pointer; }
    .perm-name { font-weight: 600; font-size: 13px; color: var(--color-text); }
    .perm-desc { font-size: 12px; color: var(--color-text-muted); margin-top: 2px; }

    .risk-indicator {
      font-size: 11px;
      font-weight: 600;
      padding: 2px 7px;
      border-radius: var(--radius-full);
      white-space: nowrap;
      flex-shrink: 0;
    }
    .risk-indicator.low    { background: var(--color-success-bg);  color: var(--color-success-dark); }
    .risk-indicator.medium { background: var(--color-warning-bg);  color: var(--color-warning-dark); }
    .risk-indicator.high   { background: var(--color-danger-bg);   color: var(--color-danger-dark);  }

    .form-check { display: flex; align-items: center; gap: 8px; }
    .form-check input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .attempt-success { color: var(--color-success); font-weight: 600; }
    .attempt-failed  { color: var(--color-danger);  font-weight: 600; }

    /* ‚îÄ‚îÄ Audit filters ‚îÄ‚îÄ */
    .audit-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 12px 0 16px;
      border-bottom: 1px solid var(--color-border);
      margin-bottom: 12px;
    }
    .audit-filters select,
    .audit-filters input[type="date"] {
      height: 34px;
      padding: 0 10px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-family: var(--font-base);
      font-size: 13px;
      color: var(--color-text);
      background: var(--color-surface);
      cursor: pointer;
    }
    .audit-filters .btn-sm {
      height: 34px;
      padding: 0 12px;
      font-size: 12px;
      background: var(--color-surface-hover);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      color: var(--color-text-muted);
    }
    .audit-filters .btn-sm:hover { background: var(--color-border); }

    /* ‚îÄ‚îÄ Audit summary badges ‚îÄ‚îÄ */
    .audit-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .audit-summary > span {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-info    { background: #EFF6FF; color: #1D4ED8; }
    .badge-success { background: var(--color-success-bg); color: var(--color-success); }
    .badge-danger  { background: var(--color-danger-bg);  color: var(--color-danger); }
    .badge-warning { background: var(--color-warning-bg); color: #92400E; }

    /* ‚îÄ‚îÄ Search audit ‚îÄ‚îÄ */
    .search-type-badge {
      display: inline-block;
      padding: 2px 8px;
      background: #F1F5F9;
      color: #475569;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .row-suspicious { background: #FFF7ED !important; }
    .row-suspicious:hover { background: #FFEDD5 !important; }

    /* ‚îÄ‚îÄ Trusted Devices ‚îÄ‚îÄ */
    .devices-panel {
      background: var(--color-body-bg);
      border-top: 1px solid var(--color-border);
      padding: 14px 20px;
    }
    .devices-panel table { width: 100%; font-size: 12px; border-collapse: collapse; }
    .devices-panel th { text-align: left; padding: 6px 10px; color: var(--color-text-muted); font-weight: 600; border-bottom: 1px solid var(--color-border); }
    .devices-panel td { padding: 6px 10px; border-bottom: 1px solid var(--color-border); color: var(--color-text); }
    .devices-panel tr:last-child td { border-bottom: none; }
    .device-row { background: var(--color-body-bg); }
    .devices-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 10px;
    }
    .devices-header strong { font-size: 13px; color: var(--color-text-secondary); }

    /* ‚îÄ‚îÄ IP Allowlist ‚îÄ‚îÄ */
    .ip-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--color-border);
      margin-bottom: 16px;
    }
    .ip-toggle-row strong { font-size: 15px; color: var(--color-text); }
    .toggle-switch { position: relative; display: inline-block; width: 48px; height: 26px; flex-shrink: 0; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute; cursor: pointer; inset: 0;
      background: #CBD5E1; border-radius: 26px;
      transition: background 0.2s;
    }
    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 20px; height: 20px;
      left: 3px; bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .toggle-switch input:checked + .toggle-slider { background: var(--color-primary); }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(22px); }
    .ip-disabled-note {
      background: var(--color-warning-bg);
      border: 1px solid #FDE68A;
      color: #92400E;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      margin-bottom: 16px;
    }
    .ip-add-form {
      background: var(--color-body-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-bottom: 20px;
    }
    .ip-add-form .form-col { display: flex; flex-direction: column; gap: 4px; }
    .ip-add-form label { font-size: 12px; font-weight: 600; color: var(--color-text-muted); }
    .ip-add-form input {
      height: 36px; padding: 0 10px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-family: var(--font-base); font-size: 13px;
      color: var(--color-text); background: var(--color-surface);
    }
    .ip-status-active   { color: var(--color-success); font-weight: 600; font-size: 12px; }
    .ip-status-inactive { color: var(--color-text-muted); font-weight: 600; font-size: 12px; }
    .req-pending  { color: #92400E; font-weight: 600; }
    .req-approved { color: var(--color-success); font-weight: 600; }
    .req-denied   { color: var(--color-danger); font-weight: 600; }

    /* ‚îÄ‚îÄ Grouped search audit ‚îÄ‚îÄ */
    .group-row { cursor: pointer; }
    .group-row:hover { background: var(--color-surface-hover) !important; }
    .expand-arrow { font-size: 11px; color: var(--color-text-muted); margin-left: 6px; }
    .detail-row { background: #F8FAFC; }
    .detail-table { margin: 0; border-radius: 0; box-shadow: none; border: none; }
    .detail-table thead th { background: #EFF4FB; font-size: 11px; padding: 6px 12px; }
    .detail-table tbody td { padding: 6px 12px; border-bottom: 1px solid #E8EDF3; }
    .detail-loading { padding: 16px; color: var(--color-text-muted); font-size: 13px; text-align: center; }

    /* ‚îÄ‚îÄ Settings ‚îÄ‚îÄ */
    .setting-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 24px;
      padding: 16px 0;
    }
    .setting-info { display: flex; flex-direction: column; gap: 3px; }
    .setting-info strong { font-size: 15px; color: var(--color-text); }
    .setting-info span { font-size: 13px; color: var(--color-text-muted); }
    .setting-meta { font-size: 11px; color: var(--color-text-muted); margin-top: 2px; }
    .setting-control { display: flex; gap: 6px; flex-shrink: 0; margin-top: 2px; }
    .retention-btn {
      width: 46px; height: 34px;
      border: 1.5px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: var(--color-surface);
      color: var(--color-text-muted);
      font-size: 13px; font-weight: 600;
      cursor: pointer;
      transition: all 0.12s;
    }
    .retention-btn:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .retention-btn.active {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: #fff;
    }
  </style>
</head>
<body>
<div class="app-shell">

  <!-- Sidebar ‚Äî identical to index.html -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <img src="https://cdn11.bigcommerce.com/s-9u5u1ss/content/banners/1ink-logo-trademark-invoice.png" alt="1ink.com">
      <div class="app-label">Order Support Portal</div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-label">Search</div>
      <a href="/" class="nav-item">
        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35" stroke-linecap="round"/></svg>
        Order Search
      </a>
      <a href="/" class="nav-item" id="bulkImportBtn" style="display:none;">
        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Bulk Tracking
      </a>
    </div>

    <div class="sidebar-section" id="adminLink">
      <div class="sidebar-section-label">Admin</div>
      <a href="/admin" class="nav-item active">
        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Users &amp; Roles
      </a>
    </div>

    <div class="sidebar-footer">
      <div class="sidebar-user">
        <div class="sidebar-avatar" id="userAvatar">R</div>
        <div class="sidebar-user-info">
          <div class="sidebar-username" id="username">Loading...</div>
          <div class="sidebar-role" id="userRole">Administrator</div>
        </div>
      </div>
      <button class="sidebar-logout-link" onclick="logout()">
        <svg width="15" height="15" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sign out
      </button>
    </div>
  </nav>

  <!-- Main content -->
  <div class="main-content">

    <!-- Topbar -->
    <div class="topbar">
      <span class="topbar-title">Admin Panel</span>
    </div>

    <!-- Page content -->
    <div class="page-content">

      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('users')">üë§ Users</button>
        <button class="tab-btn" onclick="showTab('roles')">üîê Roles &amp; Permissions</button>
        <button class="tab-btn" onclick="showTab('attempts')">üìã Login Attempts</button>
        <button class="tab-btn" onclick="showTab('searches')">üîç Search Audit</button>
        <button class="tab-btn" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
        <button class="tab-btn" onclick="showTab('ips')" id="tabIps">üåê IP Allowlist</button>
      </div>

      <!-- Users Panel -->
      <div class="panel active" id="panel-users">
        <div class="card">
          <div class="panel-header">
            <h2>User Management</h2>
            <button class="btn btn-primary requires-manage" onclick="showAddUserModal()">+ Add User</button>
          </div>
          <div class="stats-row" id="userStats"></div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Status</th>
                <th>2FA</th>
                <th>Last Login</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr><td colspan="7" class="no-data">Loading users...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Roles Panel -->
      <div class="panel" id="panel-roles">
        <div class="card">
          <div class="panel-header">
            <h2>Roles &amp; Permissions</h2>
            <button class="btn btn-primary requires-manage" onclick="showAddRoleModal()">+ Create Role</button>
          </div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Role Name</th>
                <th>Description</th>
                <th>Type</th>
                <th>Permissions</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rolesTableBody">
              <tr><td colspan="5" class="no-data">Loading roles...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Login Attempts Panel -->
      <div class="panel" id="panel-attempts">
        <div class="card">
          <div class="panel-header">
            <h2>Login Attempts</h2>
            <button class="refresh-btn" onclick="loadLoginAttempts()">‚Üª Refresh</button>
          </div>
          <!-- Filters -->
          <div class="audit-filters">
            <select id="attemptFilterUser" onchange="loadLoginAttempts()">
              <option value="">All Agents</option>
            </select>
            <select id="attemptFilterResult" onchange="loadLoginAttempts()">
              <option value="">All Results</option>
              <option value="true">‚úì Success</option>
              <option value="false">‚úó Failed</option>
            </select>
            <input type="date" id="attemptFilterFrom" onchange="loadLoginAttempts()" placeholder="From date">
            <input type="date" id="attemptFilterTo"   onchange="loadLoginAttempts()" placeholder="To date">
            <button class="btn btn-sm" onclick="clearAttemptFilters()">‚úï Clear</button>
          </div>
          <div id="attemptsSummary" class="audit-summary"></div>
          <table class="data-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Agent</th>
                <th>IP Address</th>
                <th>Result</th>
              </tr>
            </thead>
            <tbody id="attemptsTableBody">
              <tr><td colspan="4" class="no-data">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Search Audit Panel -->
      <div class="panel" id="panel-searches">
        <div class="card">
          <div class="panel-header">
            <h2>Search Audit</h2>
            <button class="refresh-btn" onclick="loadSearchAudit()">‚Üª Refresh</button>
          </div>
          <div class="audit-filters">
            <select id="searchFilterUser" onchange="loadSearchAudit()">
              <option value="">All Agents</option>
            </select>
            <select id="searchFilterStore" onchange="loadSearchAudit()">
              <option value="">All Stores</option>
              <option value="1ink">1ink.com</option>
              <option value="needink">NeedInk.com</option>
            </select>
            <input type="date" id="searchFilterFrom" onchange="loadSearchAudit()" placeholder="From date">
            <input type="date" id="searchFilterTo"   onchange="loadSearchAudit()" placeholder="To date">
            <button class="btn btn-sm" onclick="clearSearchFilters()">‚úï Clear</button>
          </div>
          <div id="searchSummary" class="audit-summary"></div>
          <!-- Grouped rows ‚Äî each group expands to show detail -->
          <table class="data-table" id="searchGroupTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Agent</th>
                <th>Store</th>
                <th>Searches</th>
                <th>Zero Results</th>
                <th>Active</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="searchesTableBody">
              <tr><td colspan="7" class="no-data">Click Refresh to load search audit</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Settings Panel -->
      <div class="panel" id="panel-settings">
        <div class="card">
          <div class="panel-header">
            <h2>Log Retention Settings</h2>
            <button class="refresh-btn" onclick="loadSettings()">‚Üª Refresh</button>
          </div>
          <p style="color:var(--color-text-muted);font-size:14px;margin-bottom:24px;">
            Control how long audit logs are kept before being automatically deleted. Changes take effect on next server restart.
          </p>
          <div id="settingsBody" style="max-width:520px;">
            <div class="no-data">Loading settings...</div>
          </div>
        </div>
      </div>

      <!-- IP Allowlist Panel -->
      <div class="panel" id="panel-ips">
        <div class="card">
          <div class="panel-header">
            <h2>IP Allowlist</h2>
            <button class="refresh-btn" onclick="loadIpAllowlist()">‚Üª Refresh</button>
          </div>

          <!-- Master toggle -->
          <div class="ip-toggle-row" id="ipToggleRow">
            <div>
              <strong>IP Allowlist</strong>
              <span id="ipEnabledLabel" style="font-size:13px;margin-left:10px;"></span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="ipEnabledToggle" onchange="toggleAllowlist()">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div id="ipDisabledNote" class="ip-disabled-note" style="display:none;">
            ‚ö† Allowlist is currently <strong>disabled</strong> ‚Äî all IPs can access the login page.
          </div>

          <!-- Add new IP -->
          <div class="ip-add-form">
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end;">
              <div class="form-col">
                <label>IP Address or CIDR Range</label>
                <input type="text" id="newIpCidr" placeholder="e.g. 203.0.113.5 or 192.168.1.0/24" style="width:260px;">
              </div>
              <div class="form-col">
                <label>Label</label>
                <input type="text" id="newIpLabel" placeholder="e.g. Office ‚Äî Main" style="width:200px;">
              </div>
              <button class="btn btn-primary" onclick="addIp()">+ Add IP</button>
              <button class="btn" style="background:#EFF6FF;color:#1D4ED8;border:1px solid #BFDBFE;" onclick="detectMyIp()">üìç Use My Current IP</button>
            </div>
            <div id="ipAddMsg" style="margin-top:8px;font-size:13px;"></div>
          </div>

          <!-- IP list -->
          <table class="data-table" id="ipTable">
            <thead>
              <tr>
                <th>IP / Range</th>
                <th>Label</th>
                <th>Added By</th>
                <th>Date Added</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="ipTableBody">
              <tr><td colspan="6" class="no-data">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Access Requests -->
        <div class="card" style="margin-top:20px;">
          <div class="panel-header">
            <h2>Access Requests <span id="pendingBadge"></span></h2>
            <button class="refresh-btn" onclick="loadAccessRequests()">‚Üª Refresh</button>
          </div>
          <p style="font-size:13px;color:var(--color-text-muted);margin-bottom:16px;">
            Agents blocked by the IP allowlist can submit a request from the login page. Approve to automatically add their IP.
          </p>
          <table class="data-table">
            <thead>
              <tr>
                <th>Requested</th>
                <th>Name</th>
                <th>IP Address</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="requestsTableBody">
              <tr><td colspan="6" class="no-data">No access requests</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div><!-- /page-content -->
  </div><!-- /main-content -->
</div><!-- /app-shell -->

<!-- User Modal -->
<div class="modal" id="userModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="userModalTitle">Add User</h3>
      <button class="modal-close" onclick="closeUserModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editUserId">
      <div class="form-group">
        <label for="modalUsername">Username</label>
        <input type="text" id="modalUsername" placeholder="Enter username">
      </div>
      <div class="form-group">
        <label for="modalPassword">Password</label>
        <input type="password" id="modalPassword" placeholder="Enter password">
        <div class="form-help" id="passwordHelp">Minimum 6 characters</div>
      </div>
      <div class="form-group">
        <label for="modalRole">Role</label>
        <select id="modalRole"><option value="">Select a role...</option></select>
      </div>
      <div class="form-group" id="activeGroup" style="display:none;">
        <div class="form-check">
          <input type="checkbox" id="modalIsActive" checked>
          <label for="modalIsActive">Active</label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
      <button class="btn btn-primary" id="saveUserBtn" onclick="saveUser()">Save</button>
    </div>
  </div>
</div>

<!-- Role Modal -->
<div class="modal" id="roleModal">
  <div class="modal-content" style="max-width:800px;">
    <div class="modal-header">
      <h3 id="roleModalTitle">Create Role</h3>
      <button class="modal-close" onclick="closeRoleModal()">&times;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editRoleId">
      <div class="form-group">
        <label for="modalRoleName">Role Name</label>
        <input type="text" id="modalRoleName" placeholder="e.g., Warehouse Staff">
      </div>
      <div class="form-group">
        <label for="modalRoleDesc">Description</label>
        <textarea id="modalRoleDesc" rows="2" placeholder="Describe what this role can do"></textarea>
      </div>
      <div class="form-group">
        <label>Permissions</label>
        <div class="permissions-grid" id="permissionsGrid">Loading permissions...</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeRoleModal()">Cancel</button>
      <button class="btn btn-primary" id="saveRoleBtn" onclick="saveRole()">Save Role</button>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal" id="deleteModal">
  <div class="modal-content" style="max-width:420px;">
    <div class="modal-header">
      <h3>Confirm Delete</h3>
      <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
    </div>
    <div class="modal-body">
      <p id="deleteMessage" style="color:var(--color-text);">Are you sure?</p>
      <p style="color:var(--color-danger);margin-top:10px;font-size:14px;">This action cannot be undone.</p>
      <input type="hidden" id="deleteId">
      <input type="hidden" id="deleteType">
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
  let users = [], roles = [], permissions = [];

  async function checkAuth() {
    try {
      const response = await fetch('/api/auth-check');
      const data = await response.json();
      if (!data.authenticated || !data.permissions.includes('admin.users.view')) {
        window.location.href = '/';
        return;
      }
      // Populate sidebar user info
      const name = capitalize(data.user);
      document.getElementById('username').textContent = name;
      document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('userRole').textContent = data.isAdmin ? 'Administrator' : 'Agent';

      window.userPermissions = data.permissions || [];
      if (!window.userPermissions.includes('admin.users.manage')) {
        document.querySelectorAll('.requires-manage').forEach(el => el.style.display = 'none');
      }
      loadData();
    } catch (err) {
      window.location.href = '/login';
    }
  }

  function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1) : ''; }

  async function loadData() {
    await Promise.all([loadUsers(), loadRoles(), loadPermissions()]);
  }

  function showTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
    document.getElementById(`panel-${tab}`).classList.add('active');
    if (tab === 'attempts') loadLoginAttempts();
    if (tab === 'searches') loadSearchAudit();
    if (tab === 'settings') loadSettings();
    if (tab === 'ips') { loadIpAllowlist(); loadAccessRequests(); }
  }

  async function loadUsers() {
    try {
      const res = await fetch('/api/admin/users');
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      users = data.users;
      renderUsers();
    } catch (err) {
      document.getElementById('usersTableBody').innerHTML = `<tr><td colspan="6" class="no-data" style="color:var(--color-danger)">${err.message}</td></tr>`;
    }
  }

  function renderUsers() {
    const tbody = document.getElementById('usersTableBody');
    const total = users.length, active = users.filter(u => u.is_active).length;
    const locked = users.filter(u => u.locked_until && new Date(u.locked_until) > new Date()).length;

    document.getElementById('userStats').innerHTML = `
      <div class="stat-card"><h4>Total Users</h4><div class="number">${total}</div></div>
      <div class="stat-card"><h4>Active</h4><div class="number">${active}</div></div>
      <div class="stat-card"><h4>Locked</h4><div class="number" style="color:${locked>0?'var(--color-danger)':'inherit'}">${locked}</div></div>
    `;

    if (users.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="no-data">No users found</td></tr>';
      return;
    }

    tbody.innerHTML = users.map(u => {
      const isLocked = u.locked_until && new Date(u.locked_until) > new Date();
      const roleBadge = (u.role_name||'').toLowerCase().includes('admin') ? 'badge-admin' :
                        (u.role_name||'').toLowerCase().includes('manager') ? 'badge-manager' :
                        (u.role_name||'').toLowerCase().includes('supervisor') ? 'badge-supervisor' : 'badge-agent';
      const twoFaBadge = u.totp_enabled  ? '<span class="badge badge-active">üîê On</span>'  :
                         u.totp_pending  ? '<span class="badge badge-locked">‚è≥ Pending</span>' :
                                           '<span class="badge badge-inactive">Off</span>';
      const twoFaBtn = u.totp_enabled || u.totp_pending
        ? `<button class="btn btn-sm btn-warning requires-manage" onclick="disable2fa(${u.id}, '${u.username}')">Disable 2FA</button>`
        : `<button class="btn btn-sm requires-manage" style="background:#EFF6FF;color:#1D4ED8;border:1px solid #BFDBFE;" onclick="enroll2fa(${u.id}, '${u.username}')">Enable 2FA</button>`;
      return `<tr>
        <td><strong>${u.username}</strong></td>
        <td><span class="badge ${roleBadge}">${u.role_name||'No Role'}</span></td>
        <td>${!u.is_active ? '<span class="badge badge-inactive">Inactive</span>' : isLocked ? '<span class="badge badge-locked">Locked</span>' : '<span class="badge badge-active">Active</span>'}</td>
        <td>${twoFaBadge}</td>
        <td>${u.last_login ? new Date(u.last_login).toLocaleString() : 'Never'}</td>
        <td class="actions">
          <button class="btn btn-sm btn-primary requires-manage" onclick="showEditUserModal(${u.id})">Edit</button>
          ${isLocked ? `<button class="btn btn-sm btn-warning requires-manage" onclick="unlockUser(${u.id})">Unlock</button>` : ''}
          ${twoFaBtn}
          ${(u.totp_enabled || u.totp_pending) ? `<button class="btn btn-sm" style="background:#F5F3FF;color:#6D28D9;border:1px solid #DDD6FE;" onclick="toggleDevices(${u.id})">üñ• Devices</button>` : ''}
          <button class="btn btn-sm btn-danger requires-manage" onclick="showDeleteModal('user',${u.id},'${u.username}')">Delete</button>
        </td>
      </tr>
      <tr class="device-row" id="devices-${u.id}" style="display:none;">
        <td colspan="7" style="padding:0;">
          <div class="devices-panel" id="devices-panel-${u.id}">
            <div class="no-data" style="padding:12px;">Loading devices...</div>
          </div>
        </td>
      </tr>`;
    }).join('');
  }

  // ‚îÄ‚îÄ Trusted Devices ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const _devicesOpen = new Set();

  async function toggleDevices(userId) {
    const row   = document.getElementById(`devices-${userId}`);
    const panel = document.getElementById(`devices-panel-${userId}`);
    if (_devicesOpen.has(userId)) {
      row.style.display = 'none';
      _devicesOpen.delete(userId);
    } else {
      row.style.display = 'table-row';
      _devicesOpen.add(userId);
      await loadDevices(userId);
    }
  }

  async function loadDevices(userId) {
    const panel = document.getElementById(`devices-panel-${userId}`);
    panel.innerHTML = '<div class="no-data" style="padding:12px;">Loading...</div>';
    try {
      const res  = await fetch(`/api/admin/users/${userId}/trusted-devices`);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      if (data.devices.length === 0) {
        panel.innerHTML = `
          <div class="devices-header">
            <strong>üñ• Trusted Devices</strong>
          </div>
          <div class="no-data" style="padding:8px 0;">No trusted devices ‚Äî agent hasn't used "Remember this device" yet.</div>`;
        return;
      }

      const now = Date.now();
      panel.innerHTML = `
        <div class="devices-header">
          <strong>üñ• Trusted Devices (${data.devices.length})</strong>
          <button class="btn btn-sm btn-danger" onclick="revokeAllDevices(${userId})">Revoke All</button>
        </div>
        <table>
          <thead><tr>
            <th>Browser</th><th>IP Address</th><th>Added</th><th>Last Used</th><th>Expires</th><th></th>
          </tr></thead>
          <tbody>
            ${data.devices.map(d => {
              const expired  = new Date(d.expires_at) < new Date();
              const expLabel = expired
                ? '<span style="color:var(--color-danger)">Expired</span>'
                : new Date(d.expires_at).toLocaleDateString();
              return `<tr>
                <td>${d.browser_hint || 'Unknown'}</td>
                <td><code>${d.ip_address || '‚Äî'}</code></td>
                <td>${new Date(d.created_at).toLocaleDateString()}</td>
                <td>${new Date(d.last_used_at).toLocaleDateString()}</td>
                <td>${expLabel}</td>
                <td><button class="btn btn-sm btn-danger" onclick="revokeDevice(${d.id}, ${userId})">Revoke</button></td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>`;
    } catch (err) {
      panel.innerHTML = `<div style="color:var(--color-danger);padding:12px;">${err.message}</div>`;
    }
  }

  async function revokeDevice(deviceId, userId) {
    if (!confirm('Revoke this trusted device? The agent will need to enter their 2FA code on next login from this browser.')) return;
    try {
      const res = await fetch(`/api/admin/trusted-devices/${deviceId}`, { method: 'DELETE' });
      if (!res.ok) throw new Error((await res.json()).error);
      loadDevices(userId);
    } catch (err) { alert('Failed: ' + err.message); }
  }

  async function revokeAllDevices(userId) {
    if (!confirm('Revoke ALL trusted devices for this user? They will need to re-enter their 2FA code from every browser next login.')) return;
    try {
      const res  = await fetch(`/api/admin/users/${userId}/trusted-devices`, { method: 'DELETE' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      loadDevices(userId);
    } catch (err) { alert('Failed: ' + err.message); }
  }

  // ‚îÄ‚îÄ 2FA admin functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function enroll2fa(userId, username) {
    if (!confirm(`Enable 2FA for ${username}?\n\nThey will be prompted to scan a QR code on their next login.`)) return;
    try {
      const res  = await fetch(`/api/admin/users/${userId}/2fa/enroll`, { method: 'POST' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      // Show QR modal
      show2faQrModal(username, data.qrDataUrl, data.secret);
      await loadUsers();
    } catch (err) {
      alert('Failed to enable 2FA: ' + err.message);
    }
  }

  async function disable2fa(userId, username) {
    if (!confirm(`Disable 2FA for ${username}?\n\nThey will be able to log in with password only.`)) return;
    try {
      const res  = await fetch(`/api/admin/users/${userId}/2fa/disable`, { method: 'POST' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      await loadUsers();
    } catch (err) {
      alert('Failed to disable 2FA: ' + err.message);
    }
  }

  function show2faQrModal(username, qrDataUrl, secret) {
    const modal = document.getElementById('twoFaModal');
    document.getElementById('twoFaUsername').textContent = username;
    document.getElementById('twoFaQrImg').src = qrDataUrl;
    document.getElementById('twoFaSecret').textContent = secret;
    modal.style.display = 'flex';
  }

  document.getElementById('twoFaModal')?.addEventListener('click', function(e) {
    if (e.target === this) this.style.display = 'none';
  });

  async function loadRoles() {
    try {
      const res = await fetch('/api/admin/roles');
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      roles = data.roles;
      renderRoles();
    } catch (err) {
      document.getElementById('rolesTableBody').innerHTML = `<tr><td colspan="5" class="no-data" style="color:var(--color-danger)">${err.message}</td></tr>`;
    }
  }

  function renderRoles() {
    const tbody = document.getElementById('rolesTableBody');
    if (roles.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="no-data">No roles found</td></tr>';
      return;
    }
    tbody.innerHTML = roles.map(r => `<tr>
      <td><strong>${r.name}</strong></td>
      <td>${r.description||'‚Äî'}</td>
      <td><span class="badge ${r.is_system?'badge-system':'badge-custom'}">${r.is_system?'System':'Custom'}</span></td>
      <td>${r.permission_count} permissions</td>
      <td class="actions">
        <button class="btn btn-sm btn-primary requires-manage" onclick="showEditRoleModal(${r.id})">Edit</button>
        ${!r.is_system ? `<button class="btn btn-sm btn-danger requires-manage" onclick="showDeleteModal('role',${r.id},'${r.name}')">Delete</button>` : ''}
      </td>
    </tr>`).join('');
  }

  async function loadPermissions() {
    try {
      const res = await fetch('/api/admin/permissions');
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      permissions = data.permissions;
    } catch (err) { console.error('Failed to load permissions:', err); }
  }

  // Agent lists cached so filtering never collapses the dropdown
  const _agentCache = {};

  function populateAgentFilter(selectId, rows, field = 'username') {
    const sel = document.getElementById(selectId);
    if (!sel) return;
    const current = sel.value;

    // Merge new names into cached list ‚Äî never shrink it
    if (!_agentCache[selectId]) _agentCache[selectId] = new Set();
    rows.forEach(r => { if (r[field]) _agentCache[selectId].add(r[field]); });

    const names = [..._agentCache[selectId]].sort();
    sel.innerHTML = '<option value="">All Agents</option>' +
      names.map(n => `<option value="${n}" ${n===current?'selected':''}>${n}</option>`).join('');
  }

  async function loadLoginAttempts() {
    const tbody = document.getElementById('attemptsTableBody');
    tbody.innerHTML = '<tr><td colspan="4" class="no-data">Loading...</td></tr>';
    try {
      const params = new URLSearchParams({ limit: 500 });
      const user   = document.getElementById('attemptFilterUser')?.value;
      const result = document.getElementById('attemptFilterResult')?.value;
      const from   = document.getElementById('attemptFilterFrom')?.value;
      const to     = document.getElementById('attemptFilterTo')?.value;
      if (user)   params.set('username', user);
      if (result) params.set('success',  result);
      if (from)   params.set('date_from', from);
      if (to)     params.set('date_to',   to);

      const res  = await fetch('/api/admin/login-attempts?' + params);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      populateAgentFilter('attemptFilterUser', data.attempts);

      const failed  = data.attempts.filter(a => !a.success).length;
      const success = data.attempts.filter(a =>  a.success).length;
      document.getElementById('attemptsSummary').innerHTML =
        `<span class="badge-info">${data.attempts.length} total</span>` +
        `<span class="badge-success">‚úì ${success} success</span>` +
        `<span class="badge-danger">‚úó ${failed} failed</span>`;

      if (data.attempts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="no-data">No login attempts match the filters</td></tr>';
        return;
      }
      tbody.innerHTML = data.attempts.map(a => `<tr>
        <td style="white-space:nowrap">${new Date(a.attempted_at).toLocaleString()}</td>
        <td>${a.username||'<em>unknown</em>'}</td>
        <td><code>${a.ip_address}</code></td>
        <td class="${a.success?'attempt-success':'attempt-failed'}">${a.success?'‚úì Success':'‚úó Failed'}</td>
      </tr>`).join('');
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="4" class="no-data" style="color:var(--color-danger)">${err.message}</td></tr>`;
    }
  }

  function clearAttemptFilters() {
    delete _agentCache['attemptFilterUser'];
    ['attemptFilterUser','attemptFilterResult','attemptFilterFrom','attemptFilterTo']
      .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    loadLoginAttempts();
  }

  // Holds expanded detail rows by group key
  const expandedGroups = new Set();

  async function loadSearchAudit() {
    const tbody = document.getElementById('searchesTableBody');
    tbody.innerHTML = '<tr><td colspan="7" class="no-data">Loading...</td></tr>';
    try {
      const params = new URLSearchParams();
      const user  = document.getElementById('searchFilterUser')?.value;
      const store = document.getElementById('searchFilterStore')?.value;
      const from  = document.getElementById('searchFilterFrom')?.value;
      const to    = document.getElementById('searchFilterTo')?.value;
      if (user)  params.set('username',  user);
      if (store) params.set('store',     store);
      if (from)  params.set('date_from', from);
      if (to)    params.set('date_to',   to);

      const res  = await fetch('/api/admin/search-audit/grouped?' + params);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      // Populate agent filter from groups
      populateAgentFilter('searchFilterUser', data.groups);

      const suspicious   = data.suspiciousUsers || [];
      const totalSearches = data.groups.reduce((s, g) => s + g.total_searches, 0);
      const totalZero     = data.groups.reduce((s, g) => s + g.zero_results, 0);

      document.getElementById('searchSummary').innerHTML =
        `<span class="badge-info">${totalSearches.toLocaleString()} total searches</span>` +
        `<span class="badge-info">${data.groups.length} groups</span>` +
        `<span class="badge-warning">${totalZero} zero-result</span>` +
        (suspicious.length ? `<span class="badge-danger">‚ö† Suspicious: ${suspicious.join(', ')}</span>` : '');

      if (data.groups.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">No searches match the filters</td></tr>';
        return;
      }

      renderGroupedRows(data.groups, suspicious);
    } catch (err) {
      document.getElementById('searchSummary').innerHTML = '';
      tbody.innerHTML = `<tr><td colspan="7" class="no-data" style="color:var(--color-danger)">‚ö† ${err.message}</td></tr>`;
    }
  }

  function renderGroupedRows(groups, suspicious) {
    const tbody = document.getElementById('searchesTableBody');
    let html = '';
    groups.forEach((g, idx) => {
      // pg returns DATE as a JS Date object ‚Äî extract YYYY-MM-DD string safely
      const dayStr = g.day instanceof Date
        ? g.day.toISOString().slice(0, 10)
        : String(g.day).slice(0, 10);
      const key = `${g.username}|${g.store}|${dayStr}`;
      const isExpanded  = expandedGroups.has(key);
      const isSuspicious = suspicious.includes(g.username);
      const dateLabel   = new Date(dayStr + 'T12:00:00').toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
      const firstTime   = new Date(g.first_search).toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });
      const lastTime    = new Date(g.last_search).toLocaleTimeString('en-US',  { hour:'numeric', minute:'2-digit' });
      const types       = (g.search_types || []).map(t => `<span class="search-type-badge">${t}</span>`).join(' ');

      html += `<tr class="group-row ${isSuspicious ? 'row-suspicious' : ''}" onclick="toggleGroup('${key.replace(/'/g,"\'")}', '${g.username}', '${g.store}', '${dayStr}')">
        <td><strong>${dateLabel}</strong></td>
        <td>${isSuspicious ? '‚ö† ' : ''}<strong>${g.username}</strong></td>
        <td>${g.store}</td>
        <td><strong>${g.total_searches}</strong></td>
        <td class="${g.zero_results > 0 ? 'attempt-failed' : ''}">${g.zero_results}</td>
        <td style="font-size:12px;color:var(--color-text-muted)">${firstTime} ‚Äì ${lastTime}</td>
        <td style="text-align:right">${types} <span class="expand-arrow">${isExpanded ? '‚ñ≤' : '‚ñº'}</span></td>
      </tr>`;

      if (isExpanded) {
        html += `<tr class="detail-row" id="detail-${idx}">
          <td colspan="7" style="padding:0">
            <div class="detail-loading" id="detail-inner-${idx}">Loading...</div>
          </td>
        </tr>`;
      }
    });
    tbody.innerHTML = html;

    // Load detail for already-expanded groups
    groups.forEach((g, idx) => {
      const ds = g.day instanceof Date ? g.day.toISOString().slice(0, 10) : String(g.day).slice(0, 10);
      const key = `${g.username}|${g.store}|${ds}`;
      if (expandedGroups.has(key)) {
        fetchGroupDetail(g.username, g.store, ds, `detail-inner-${idx}`);
      }
    });
  }

  async function toggleGroup(key, username, store, day) {
    if (expandedGroups.has(key)) {
      expandedGroups.delete(key);
    } else {
      expandedGroups.add(key);
    }
    loadSearchAudit();
  }

  async function fetchGroupDetail(username, store, day, containerId) {
    const el = document.getElementById(containerId);
    if (!el) return;
    try {
      const params = new URLSearchParams({ username, store, date_from: day, date_to: day, limit: 500 });
      const res  = await fetch('/api/admin/search-audit?' + params);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      if (!data.searches || data.searches.length === 0) {
        el.innerHTML = '<div style="padding:12px;color:var(--color-text-muted);font-size:13px;">No detail found</div>';
        return;
      }

      el.innerHTML = `<table class="data-table detail-table">
        <thead><tr>
          <th>Time</th><th>Type</th><th>Query</th><th>Results</th>
        </tr></thead>
        <tbody>
          ${data.searches.map(s => `<tr>
            <td style="white-space:nowrap;font-size:12px;">${new Date(s.searched_at).toLocaleTimeString()}</td>
            <td><span class="search-type-badge">${s.search_type}</span></td>
            <td><code style="font-size:12px;">${s.query}</code></td>
            <td class="${s.result_count === 0 ? 'attempt-failed' : ''}" style="font-size:13px;">${s.result_count}</td>
          </tr>`).join('')}
        </tbody>
      </table>`;
    } catch (err) {
      el.innerHTML = `<div style="padding:12px;color:var(--color-danger);font-size:13px;">${err.message}</div>`;
    }
  }

  function clearSearchFilters() {
    delete _agentCache['searchFilterUser'];
    ['searchFilterUser','searchFilterStore','searchFilterFrom','searchFilterTo']
      .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    expandedGroups.clear();
    loadSearchAudit();
  }

  // ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadSettings() {
    const body = document.getElementById('settingsBody');
    body.innerHTML = '<div class="no-data">Loading...</div>';
    try {
      const res  = await fetch('/api/admin/settings');
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      const s = data.settings;
      const options = [30, 60, 90, 120, 180];

      const renderSetting = (key, label, desc, customOptions) => {
        const opts = customOptions || [30, 60, 90, 120, 180];
        const current = parseInt(s[key]?.value || opts[1]);
        const updatedBy = s[key]?.updated_by ? `Last changed by ${s[key].updated_by}` : '';
        return `
        <div class="setting-row">
          <div class="setting-info">
            <strong>${label}</strong>
            <span>${desc}</span>
            <span class="setting-meta">${updatedBy}</span>
          </div>
          <div class="setting-control">
            ${opts.map(v => `<button
              class="retention-btn ${v === current ? 'active' : ''}"
              onclick="saveSetting('${key}', ${v}, this)"
            >${v}d</button>`).join('')}
          </div>
        </div>`;
      };

      body.innerHTML = `
        <div id="settingsMsg"></div>
        ${renderSetting('login_retention_days',  'Login Attempts Log', 'How long to keep login attempt records')}
        ${renderSetting('device_trust_days', 'Trusted Device Duration', 'How long a remembered device skips 2FA', [15,30,60,90])}
        <div style="height:1px;background:var(--color-border);margin:20px 0"></div>
        ${renderSetting('search_retention_days', 'Search Audit Log',   'How long to keep agent search records')}
        <p style="margin-top:24px;font-size:13px;color:var(--color-text-muted);">
          ‚ö† Changes apply on next server restart. Records older than the selected window are deleted automatically.
        </p>`;
    } catch (err) {
      body.innerHTML = `<div class="no-data" style="color:var(--color-danger)">${err.message}</div>`;
    }
  }

  async function saveSetting(key, value, btn) {
    const msg = document.getElementById('settingsMsg');
    try {
      const res  = await fetch('/api/admin/settings', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key, value })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      // Update button states
      btn.closest('.setting-control').querySelectorAll('.retention-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      msg.innerHTML = `<span class="badge-success" style="display:inline-block;margin-bottom:12px;">‚úì Saved ‚Äî takes effect on next restart</span>`;
    } catch (err) {
      msg.innerHTML = `<span class="badge-danger" style="display:inline-block;margin-bottom:12px;">‚úó ${err.message}</span>`;
    }
  }

  function showAddUserModal() {
    document.getElementById('userModalTitle').textContent = 'Add User';
    document.getElementById('editUserId').value = '';
    document.getElementById('modalUsername').value = '';
    document.getElementById('modalPassword').value = '';
    document.getElementById('modalRole').value = '';
    document.getElementById('modalIsActive').checked = true;
    document.getElementById('activeGroup').style.display = 'none';
    document.getElementById('passwordHelp').textContent = 'Minimum 6 characters';
    populateRoleDropdown();
    document.getElementById('userModal').classList.add('active');
  }

  function showEditUserModal(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;
    document.getElementById('userModalTitle').textContent = 'Edit User';
    document.getElementById('editUserId').value = userId;
    document.getElementById('modalUsername').value = user.username;
    document.getElementById('modalPassword').value = '';
    document.getElementById('modalIsActive').checked = user.is_active;
    document.getElementById('activeGroup').style.display = 'block';
    document.getElementById('passwordHelp').textContent = 'Leave blank to keep current password';
    populateRoleDropdown(user.role_id);
    document.getElementById('userModal').classList.add('active');
  }

  function populateRoleDropdown(selectedId = null) {
    document.getElementById('modalRole').innerHTML = '<option value="">Select a role...</option>' +
      roles.map(r => `<option value="${r.id}" ${r.id===selectedId?'selected':''}>${r.name}</option>`).join('');
  }

  function closeUserModal() { document.getElementById('userModal').classList.remove('active'); }

  async function saveUser() {
    const userId = document.getElementById('editUserId').value;
    const username = document.getElementById('modalUsername').value.trim();
    const password = document.getElementById('modalPassword').value;
    const roleId = document.getElementById('modalRole').value;
    const isActive = document.getElementById('modalIsActive').checked;

    if (!username) { alert('Username is required'); return; }
    if (!userId && !password) { alert('Password is required for new users'); return; }
    if (password && password.length < 6) { alert('Password must be at least 6 characters'); return; }
    if (!roleId) { alert('Please select a role'); return; }

    const btn = document.getElementById('saveUserBtn');
    btn.disabled = true; btn.textContent = 'Saving...';

    try {
      const body = { username, roleId: parseInt(roleId) };
      if (password) body.password = password;
      if (userId) body.isActive = isActive;

      const res = await fetch(userId ? `/api/admin/users/${userId}` : '/api/admin/users', {
        method: userId ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      closeUserModal();
      loadUsers();
    } catch (err) { alert(err.message); }
    finally { btn.disabled = false; btn.textContent = 'Save'; }
  }

  async function unlockUser(userId) {
    try {
      const res = await fetch(`/api/admin/users/${userId}/unlock`, { method: 'POST' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      loadUsers();
    } catch (err) { alert(err.message); }
  }

  function showAddRoleModal() {
    document.getElementById('roleModalTitle').textContent = 'Create Role';
    document.getElementById('editRoleId').value = '';
    document.getElementById('modalRoleName').value = '';
    document.getElementById('modalRoleDesc').value = '';
    renderPermissionsGrid([]);
    document.getElementById('roleModal').classList.add('active');
  }

  async function showEditRoleModal(roleId) {
    try {
      const res = await fetch(`/api/admin/roles/${roleId}`);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      document.getElementById('roleModalTitle').textContent = 'Edit Role';
      document.getElementById('editRoleId').value = roleId;
      document.getElementById('modalRoleName').value = data.role.name;
      document.getElementById('modalRoleDesc').value = data.role.description || '';
      renderPermissionsGrid(data.permissions);
      document.getElementById('roleModal').classList.add('active');
    } catch (err) { alert(err.message); }
  }

  function renderPermissionsGrid(selected) {
    const categories = {};
    permissions.forEach(p => {
      if (!categories[p.category]) categories[p.category] = [];
      categories[p.category].push(p);
    });
    const riskLabels  = { 1: 'Low', 2: 'Medium', 3: 'High' };
    const riskClasses = { 1: 'low', 2: 'medium', 3: 'high' };

    document.getElementById('permissionsGrid').innerHTML = Object.entries(categories).map(([cat, perms]) => `
      <div class="permission-category">
        <h4>${cat}</h4>
        ${perms.map(p => `
          <div class="permission-item">
            <input type="checkbox" id="perm_${p.code}" value="${p.code}" ${selected.includes(p.code)?'checked':''}>
            <label for="perm_${p.code}">
              <div class="perm-name">${p.name}</div>
              <div class="perm-desc">${p.description}</div>
            </label>
            <span class="risk-indicator ${riskClasses[p.risk_level]}">${riskLabels[p.risk_level]}</span>
          </div>
        `).join('')}
      </div>
    `).join('');
  }

  function closeRoleModal() { document.getElementById('roleModal').classList.remove('active'); }

  async function saveRole() {
    const roleId = document.getElementById('editRoleId').value;
    const name = document.getElementById('modalRoleName').value.trim();
    const description = document.getElementById('modalRoleDesc').value.trim();
    const selected = [];
    document.querySelectorAll('#permissionsGrid input:checked').forEach(cb => selected.push(cb.value));

    if (!name) { alert('Role name is required'); return; }

    const btn = document.getElementById('saveRoleBtn');
    btn.disabled = true; btn.textContent = 'Saving...';

    try {
      const res = await fetch(roleId ? `/api/admin/roles/${roleId}` : '/api/admin/roles', {
        method: roleId ? 'PUT' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description, permissions: selected })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      closeRoleModal();
      loadRoles();
    } catch (err) { alert(err.message); }
    finally { btn.disabled = false; btn.textContent = 'Save Role'; }
  }

  function showDeleteModal(type, id, name) {
    document.getElementById('deleteId').value = id;
    document.getElementById('deleteType').value = type;
    document.getElementById('deleteMessage').textContent = `Are you sure you want to delete ${type} "${name}"?`;
    document.getElementById('deleteModal').classList.add('active');
  }

  function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('active'); }

  async function confirmDelete() {
    const id = document.getElementById('deleteId').value;
    const type = document.getElementById('deleteType').value;
    try {
      const res = await fetch(`/api/admin/${type}s/${id}`, { method: 'DELETE' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      closeDeleteModal();
      if (type === 'user') loadUsers();
      else if (type === 'role') loadRoles();
    } catch (err) { alert(err.message); }
  }

  async function logout() {
    await fetch('/api/logout', { method: 'POST' });
    window.location.href = '/login';
  }

  checkAuth();

  // ‚îÄ‚îÄ IP Allowlist ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadIpAllowlist() {
    const tbody = document.getElementById('ipTableBody');
    tbody.innerHTML = '<tr><td colspan="6" class="no-data">Loading...</td></tr>';
    try {
      const res  = await fetch('/api/admin/ip-allowlist');
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      // Update toggle
      const toggle = document.getElementById('ipEnabledToggle');
      const label  = document.getElementById('ipEnabledLabel');
      const note   = document.getElementById('ipDisabledNote');
      toggle.checked   = data.enabled;
      label.textContent = data.enabled ? '‚Äî Active' : '‚Äî Disabled';
      label.style.color = data.enabled ? 'var(--color-success)' : 'var(--color-text-muted)';
      note.style.display = data.enabled ? 'none' : 'block';

      if (data.entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No IPs added yet. Add your first IP above.</td></tr>';
        return;
      }
      tbody.innerHTML = data.entries.map(e => `<tr>
        <td><code>${e.ip_cidr}</code></td>
        <td>${e.label || '<em style="color:var(--color-text-muted)">No label</em>'}</td>
        <td>${e.created_by || '‚Äî'}</td>
        <td style="font-size:12px;">${new Date(e.created_at).toLocaleDateString()}</td>
        <td>
          <span class="${e.is_active ? 'ip-status-active' : 'ip-status-inactive'}">
            ${e.is_active ? '‚óè Active' : '‚óã Inactive'}
          </span>
        </td>
        <td class="actions">
          <button class="btn btn-sm" onclick="toggleIp(${e.id})" style="${e.is_active ? '' : 'background:#F0FDF4;color:var(--color-success);border:1px solid #BBF7D0;'}">
            ${e.is_active ? 'Deactivate' : 'Activate'}
          </button>
          <button class="btn btn-sm btn-danger" onclick="deleteIp(${e.id}, '${e.ip_cidr.replace(/'/g,"\'")}')">Delete</button>
        </td>
      </tr>`).join('');
    } catch (err) {
      document.getElementById('ipTableBody').innerHTML = `<tr><td colspan="6" class="no-data" style="color:var(--color-danger)">${err.message}</td></tr>`;
    }
  }

  async function toggleAllowlist() {
    try {
      const res  = await fetch('/api/admin/ip-allowlist/toggle-enabled', { method: 'PUT' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      loadIpAllowlist();
    } catch (err) {
      alert('Failed to toggle allowlist: ' + err.message);
      loadIpAllowlist(); // revert toggle visual
    }
  }

  async function detectMyIp() {
    const input = document.getElementById('newIpCidr');
    const msg   = document.getElementById('ipAddMsg');
    try {
      // Use the session endpoint to get server-side IP (most accurate through proxies)
      const res  = await fetch('/api/my-ip');
      const data = await res.json();
      input.value = data.ip;
      msg.innerHTML = `<span style="color:var(--color-success)">‚úì Your current IP: <strong>${data.ip}</strong></span>`;
    } catch {
      msg.innerHTML = '<span style="color:var(--color-danger)">Could not detect IP automatically</span>';
    }
  }

  async function addIp() {
    const cidr  = document.getElementById('newIpCidr').value.trim();
    const label = document.getElementById('newIpLabel').value.trim();
    const msg   = document.getElementById('ipAddMsg');
    if (!cidr) { msg.innerHTML = '<span style="color:var(--color-danger)">Please enter an IP address</span>'; return; }
    try {
      const res  = await fetch('/api/admin/ip-allowlist', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ip_cidr: cidr, label })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);
      msg.innerHTML = `<span style="color:var(--color-success)">‚úì Added ${cidr}</span>`;
      document.getElementById('newIpCidr').value  = '';
      document.getElementById('newIpLabel').value = '';
      loadIpAllowlist();
    } catch (err) {
      msg.innerHTML = `<span style="color:var(--color-danger)">‚úó ${err.message}</span>`;
    }
  }

  async function toggleIp(id) {
    try {
      const res = await fetch(`/api/admin/ip-allowlist/${id}/toggle`, { method: 'PUT' });
      if (!res.ok) throw new Error((await res.json()).error);
      loadIpAllowlist();
    } catch (err) { alert('Failed: ' + err.message); }
  }

  async function deleteIp(id, cidr) {
    if (!confirm(`Remove ${cidr} from the allowlist?`)) return;
    try {
      const res = await fetch(`/api/admin/ip-allowlist/${id}`, { method: 'DELETE' });
      if (!res.ok) throw new Error((await res.json()).error);
      loadIpAllowlist();
    } catch (err) { alert('Failed: ' + err.message); }
  }

  // ‚îÄ‚îÄ Access Requests ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadAccessRequests() {
    const tbody = document.getElementById('requestsTableBody');
    try {
      const res  = await fetch('/api/admin/ip-access-requests');
      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      const pending = data.requests.filter(r => r.status === 'pending').length;
      const badge   = document.getElementById('pendingBadge');
      badge.innerHTML = pending > 0
        ? `<span class="badge-danger" style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:12px;background:var(--color-danger-bg);color:var(--color-danger);margin-left:6px;">${pending} pending</span>`
        : '';

      // Also update tab button
      const tabBtn = document.getElementById('tabIps');
      if (tabBtn) tabBtn.textContent = pending > 0 ? `üåê IP Allowlist (${pending})` : 'üåê IP Allowlist';

      if (data.requests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No access requests yet</td></tr>';
        return;
      }
      tbody.innerHTML = data.requests.map(r => `<tr>
        <td style="font-size:12px;white-space:nowrap">${new Date(r.created_at).toLocaleString()}</td>
        <td><strong>${r.requester}</strong></td>
        <td><code>${r.ip_address}</code></td>
        <td style="font-size:13px;">${r.reason || '‚Äî'}</td>
        <td class="req-${r.status}">${r.status.charAt(0).toUpperCase() + r.status.slice(1)}${r.reviewed_by ? `<br><span style="font-size:11px;font-weight:400;color:var(--color-text-muted)">by ${r.reviewed_by}</span>` : ''}</td>
        <td class="actions">
          ${r.status === 'pending' ? `
            <button class="btn btn-sm btn-primary" onclick="approveRequest(${r.id}, '${r.requester.replace(/'/g,"\'")}', '${r.ip_address}')">Approve</button>
            <button class="btn btn-sm btn-danger"  onclick="denyRequest(${r.id})">Deny</button>
          ` : '‚Äî'}
        </td>
      </tr>`).join('');
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="6" class="no-data" style="color:var(--color-danger)">${err.message}</td></tr>`;
    }
  }

  async function approveRequest(id, requester, ip) {
    const label = prompt(`Add label for ${ip}:`, `${requester} ‚Äî approved`);
    if (label === null) return; // cancelled
    try {
      const res = await fetch(`/api/admin/ip-access-requests/${id}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ label })
      });
      if (!res.ok) throw new Error((await res.json()).error);
      loadIpAllowlist();
      loadAccessRequests();
    } catch (err) { alert('Failed: ' + err.message); }
  }

  async function denyRequest(id) {
    if (!confirm('Deny this access request?')) return;
    try {
      const res = await fetch(`/api/admin/ip-access-requests/${id}/deny`, { method: 'POST' });
      if (!res.ok) throw new Error((await res.json()).error);
      loadAccessRequests();
    } catch (err) { alert('Failed: ' + err.message); }
  }

  // Poll for pending requests every 2 minutes when admin is logged in
  setInterval(() => {
    if (document.getElementById('requestsTableBody')) loadAccessRequests();
  }, 2 * 60 * 1000);

</script>
<!-- 2FA QR Modal -->
<div class="modal" id="twoFaModal" style="display:none;">
  <div class="modal-content" style="max-width:420px;">
    <div class="modal-header">
      <h3>2FA Enabled ‚Äî Share QR with Agent</h3>
      <button class="modal-close" onclick="document.getElementById('twoFaModal').style.display='none'">&times;</button>
    </div>
    <div style="text-align:center;padding:20px 0 8px;">
      <img id="twoFaQrImg" src="" alt="QR Code" style="width:180px;height:180px;border:3px solid var(--color-border);border-radius:8px;margin-bottom:16px;">
      <p style="font-size:14px;color:var(--color-text-muted);margin-bottom:8px;">
        Share this QR code with <strong id="twoFaUsername"></strong>.<br>
        They will scan it on their next login.
      </p>
      <div style="background:var(--color-body-bg);border:1px solid var(--color-border);border-radius:6px;padding:10px;margin-top:12px;">
        <div style="font-size:11px;color:var(--color-text-muted);margin-bottom:4px;">Manual entry key (if QR won't scan)</div>
        <code id="twoFaSecret" style="font-size:13px;letter-spacing:0.1em;color:var(--color-text);word-break:break-all;"></code>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="document.getElementById('twoFaModal').style.display='none'">Done</button>
    </div>
  </div>
</div>

</body>
</html>
