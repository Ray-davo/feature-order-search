<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Search</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
.header {
  background: #333;
  color: #fff;
  padding: 8px 20px;
  position: relative;

  display: flex;
  align-items: flex-start;
  min-height: 84px;
}

.header-left {
  width: 210px; /* reserves space so center title stays centered */
}

.logo {
  width: 210px;
  height: 84px;
  object-fit: contain;
  display: block;
}

.header-title {
  position: absolute;
  top: 14px;
  left: 50%;
  transform: translateX(-50%);
  margin: 0;
  font-size: 24px;
  white-space: nowrap;
}

.header-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 15px;
  padding-top: 10px;
}
    .user-info { color: #aaa; }
    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .search-box {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .search-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .search-row select,
    .search-row input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    .search-row select { width: 150px; }
    .search-row input { flex: 1; min-width: 200px; }
    .search-row button {
      padding: 12px 30px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    .search-row button:hover { background: #0056b3; }
    .search-row button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .db-stats {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      font-size: 13px;
      color: #666;
    }
    .results {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .results-header {
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      font-weight: 600;
    }
    .no-results {
      padding: 40px;
      text-align: center;
      color: #666;
    }
    .order-row {
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .order-row:hover { background: #f8f9fa; }
    
    /* Expand button - NEW */
    .expand-btn {
      width: 28px;
      height: 28px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
      margin-right: 15px;
    }
    .expand-btn:hover {
      background: #007bff;
      border-color: #007bff;
      color: #fff;
    }
    .expand-btn.expanded {
      background: #007bff;
      border-color: #007bff;
      color: #fff;
    }
    
    .order-info { 
      flex: 1; 
      cursor: pointer;
    }
    .order-id { font-weight: 600; color: #007bff; }
    .order-customer { color: #333; margin-top: 3px; }
    .order-email { color: #666; font-size: 14px; }
    .order-meta { 
      text-align: right; 
      cursor: pointer;
    }
    .order-total { font-weight: 600; font-size: 18px; }
    .order-status { 
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 12px;
      margin-top: 5px;
    }
    .status-completed { background: #d4edda; color: #155724; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-shipped { background: #cce5ff; color: #004085; }
    .status-refunded { background: #f8d7da; color: #721c24; }
    
    /* Preview Panel - NEW */
    .preview-panel {
      display: none;
      background: #f8fafc;
      border-bottom: 1px solid #eee;
    }
    .preview-panel.show {
      display: block;
    }
    .preview-content {
      padding: 15px 20px 15px 60px;
      border-left: 3px solid #007bff;
      margin-left: 20px;
    }
    .preview-loading {
      padding: 15px;
      color: #666;
      font-style: italic;
    }
    .preview-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 2fr;
      gap: 20px;
      margin-bottom: 15px;
    }
    .preview-address-box {
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      font-size: 13px;
      line-height: 1.5;
    }
    .preview-address-box h5 {
      margin: 0 0 8px 0;
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .preview-address-box p {
      margin: 0;
    }
    .preview-address-box .contact {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #eee;
      font-size: 12px;
      color: #555;
    }
    .preview-items-box {
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    .preview-items-box h5 {
      margin: 0 0 8px 0;
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .preview-items-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    .preview-items-table th {
      text-align: left;
      padding: 8px 10px;
      background: #e9ecef;
      font-weight: 600;
      color: #555;
      font-size: 12px;
      text-transform: uppercase;
    }
    .preview-items-table td {
      padding: 8px 10px;
      border-bottom: 1px solid #eee;
    }
    .preview-items-table .sku {
      font-family: monospace;
      font-size: 13px;
      color: #666;
    }
    .preview-items-table .qty {
      text-align: center;
    }
    .preview-items-table .price {
      text-align: right;
    }
    .preview-total {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
      text-align: right;
      font-weight: 600;
      font-size: 15px;
    }
    .view-full-btn {
      display: inline-block;
      margin-top: 12px;
      padding: 6px 14px;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .view-full-btn:hover {
      background: #218838;
    }
    
    /* Order Detail Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }
    .modal.active { display: block; }
    .modal-content {
      background: white;
      margin: 30px auto;
      max-width: 800px;
      border-radius: 8px;
      max-height: calc(100vh - 60px);
      overflow-y: auto;
    }
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }
    .modal-header h2 { margin: 0; }
    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #666;
    }
    .modal-body { padding: 20px; }
    
    /* Clean Order Detail Styles */
    .order-detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .order-detail-box {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
    }
    .order-detail-box h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .order-detail-box p {
      margin: 0;
      line-height: 1.5;
    }
    .order-status-bar {
      display: flex;
      gap: 20px;
      padding: 15px;
      background: #e9ecef;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    .status-item {
      flex: 1;
    }
    .status-item label {
      display: block;
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 3px;
    }
    .status-item span {
      font-weight: 600;
      font-size: 14px;
    }
    
    /* Products Table */
    .product-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .product-table th {
      background: #f8f9fa;
      padding: 10px;
      text-align: left;
      font-size: 12px;
      text-transform: uppercase;
      color: #666;
      border-bottom: 2px solid #dee2e6;
    }
    .product-table td {
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }
    .product-table .product-name {
      max-width: 300px;
    }
    .product-table .text-right {
      text-align: right;
    }
    
    /* Order Totals */
    .order-totals {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      max-width: 300px;
      margin-left: auto;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    .total-row.discount {
      color: #28a745;
    }
    .total-row.grand-total {
      border-top: 2px solid #dee2e6;
      margin-top: 10px;
      padding-top: 10px;
      font-weight: bold;
      font-size: 18px;
    }
    .total-row.refund {
      color: #dc3545;
    }
    
    /* Tracking Section */
    .tracking-box {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
    }
    .tracking-box h4 {
      margin: 0 0 10px 0;
      color: #004085;
    }
    .tracking-link {
      color: #007bff;
      text-decoration: none;
      font-weight: 600;
    }
    .tracking-link:hover { text-decoration: underline; }
    
    /* Notes Section */
    .notes-box {
      background: #fff3cd;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
    }
    .notes-box h4 {
      margin: 0 0 10px 0;
      color: #856404;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
  <div class="header-left">
    <img
      src="https://cdn11.bigcommerce.com/s-9u5u1ss/images/stencil/250x100/1ink-logo_1769641248__97578.original.jpg"
      alt="1ink"
      class="logo"
    >
  </div>

  <h1 class="header-title">Order Search</h1>

  <div class="header-right">
    <span class="user-info">Logged in as: <strong id="username"></strong></span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>
</div>
  
  <div class="container">
    <div class="search-box">
      <div class="search-row">
        <select id="store">
          <option value="1ink">1ink.com</option>
          <option value="needink">needink.com</option>
        </select>
        <input type="text" id="searchQuery" placeholder="Order #, email, phone, or name..." onkeypress="if(event.key==='Enter')search()">
        <button onclick="search()" id="searchBtn">Search</button>
      </div>
      <div class="db-stats" id="dbStats"></div>
    </div>
    
    <div class="results" id="results">
      <div class="no-results">Enter a search term above to find orders</div>
    </div>
  </div>
  
  <!-- Order Detail Modal -->
  <div class="modal" id="orderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Order #<span id="modalOrderId"></span></h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div class="loading">Loading order details...</div>
      </div>
    </div>
  </div>
  
  <script>
    let currentStore = '1ink';
    let expandedOrders = {};    // Track which orders are expanded
    let orderDetailsCache = {}; // Cache loaded order details
    
    // Check authentication on page load
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth-check');
        const data = await response.json();
        
        if (!data.authenticated) {
          window.location.href = '/login';
          return;
        }
        
        document.getElementById('username').textContent = data.user;
        loadDbStats();
      } catch (err) {
        window.location.href = '/login';
      }
    }
    
    // Load database stats
    async function loadDbStats() {
      try {
        const response = await fetch('/api/db-stats');
        const stats = await response.json();
        
        const store = document.getElementById('store').value;
        const storeStats = stats[store];
        
        if (storeStats && storeStats.count > 0) {
          const oldest = new Date(storeStats.oldest).toLocaleDateString();
          const newest = new Date(storeStats.newest).toLocaleDateString();
          document.getElementById('dbStats').innerHTML = 
            `<strong>${store}:</strong> ${storeStats.count.toLocaleString()} orders indexed (${oldest} to ${newest})`;
        } else {
          document.getElementById('dbStats').innerHTML = 
            `<strong>${store}:</strong> No orders indexed yet. Run sync to populate.`;
        }
      } catch (err) {
        document.getElementById('dbStats').textContent = '';
      }
    }
    
    // Update stats when store changes
    document.getElementById('store').addEventListener('change', function() {
      loadDbStats();
      // Clear cache when switching stores
      expandedOrders = {};
      orderDetailsCache = {};
    });
    
    // Detect search type based on input
    function detectSearchType(query, store) {
      const trimmed = query.trim();
      
      // Email: contains @
      if (trimmed.includes('@')) {
        return { type: 'email', label: 'Email' };
      }
      
      // Order number: check patterns
      const digitsOnly = trimmed.replace(/\D/g, '');
      
      // 1ink: 7 digits starting with 7
      if (store === '1ink' && /^7\d{6}$/.test(digitsOnly)) {
        return { type: 'order', label: 'Order #' };
      }
      
      // needink: 6 digits starting with 89 or 90
      if (store === 'needink' && /^(89|90)\d{4}$/.test(digitsOnly)) {
        return { type: 'order', label: 'Order #' };
      }
      
      // Phone: 10-11 digits (after removing formatting)
      if (/^\d{10,11}$/.test(digitsOnly)) {
        return { type: 'phone', label: 'Phone' };
      }
      
      // Default: name search
      return { type: 'name', label: 'Name' };
    }
    
    // Search orders (POST)
    async function search() {
      const store = document.getElementById('store').value;
      const query = document.getElementById('searchQuery').value.trim();
      
      if (!query) {
        alert('Please enter a search term');
        return;
      }
      
      // Auto-detect search type
      const detected = detectSearchType(query, store);
      const searchType = detected.type;
      
      const btn = document.getElementById('searchBtn');
      const resultsDiv = document.getElementById('results');
      
      btn.disabled = true;
      btn.textContent = 'Searching...';
      resultsDiv.innerHTML = `<div class="loading">Searching by ${detected.label}...</div>`;
      
      // Clear expanded state on new search
      expandedOrders = {};
      orderDetailsCache = {};
      
      try {
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ store, searchType, query })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Search failed');
        }
        
        currentStore = store;
        displayResults(data.orders, detected.label);
        
      } catch (err) {
        resultsDiv.innerHTML = `<div class="no-results" style="color: #dc3545;">${err.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Search';
      }
    }
    
    // Display search results with expand buttons
    function displayResults(orders, searchedBy) {
      const resultsDiv = document.getElementById('results');
      
      if (!orders || orders.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No orders found</div>';
        return;
      }
      
      let html = `<div class="results-header">${orders.length} order${orders.length !== 1 ? 's' : ''} found <span style="color: #888; font-weight: normal; font-size: 13px;">(searched by ${searchedBy})</span></div>`;
      
      for (const order of orders) {
        const date = new Date(order.date_created).toLocaleDateString();
        const statusClass = getStatusClass(order.status);
        const customerName = order.billing_address 
          ? `${order.billing_address.first_name || ''} ${order.billing_address.last_name || ''}`.trim()
          : 'Guest';
        const customerEmail = order.billing_address?.email || '';
        
        html += `
          <div class="order-row" id="order-row-${order.id}">
            <button class="expand-btn" onclick="togglePreview(event, ${order.id})" title="Preview items">+</button>
            <div class="order-info" onclick="viewOrder(${order.id})">
              <div class="order-id">#${order.id}</div>
              <div class="order-customer">${customerName}</div>
              <div class="order-email">${customerEmail}</div>
            </div>
            <div class="order-meta" onclick="viewOrder(${order.id})">
              <div class="order-total">$${parseFloat(order.total_inc_tax || 0).toFixed(2)}</div>
              <div class="order-status ${statusClass}">${order.status}</div>
              <div style="color: #666; font-size: 13px; margin-top: 5px;">${date}</div>
            </div>
          </div>
          <div class="preview-panel" id="preview-${order.id}">
            <div class="preview-content" id="preview-content-${order.id}">
              <div class="preview-loading">Loading items...</div>
            </div>
          </div>
        `;
      }
      
      resultsDiv.innerHTML = html;
    }
    
    // Toggle preview panel
    async function togglePreview(event, orderId) {
      event.stopPropagation();
      
      const previewPanel = document.getElementById(`preview-${orderId}`);
      const expandBtn = document.querySelector(`#order-row-${orderId} .expand-btn`);
      const previewContent = document.getElementById(`preview-content-${orderId}`);
      
      if (expandedOrders[orderId]) {
        // Collapse
        previewPanel.classList.remove('show');
        expandBtn.classList.remove('expanded');
        expandBtn.textContent = '+';
        delete expandedOrders[orderId];
      } else {
        // Expand
        previewPanel.classList.add('show');
        expandBtn.classList.add('expanded');
        expandBtn.textContent = 'âˆ’';
        expandedOrders[orderId] = true;
        
        // Load items if not cached
        if (!orderDetailsCache[orderId]) {
          previewContent.innerHTML = '<div class="preview-loading">Loading items...</div>';
          
          try {
            const response = await fetch(`/api/order/${currentStore}/${orderId}`);
            const data = await response.json();
            
            if (!response.ok) {
              throw new Error(data.error || 'Failed to load');
            }
            
            orderDetailsCache[orderId] = data;
            renderPreviewItems(orderId, data);
          } catch (err) {
            previewContent.innerHTML = `<div class="preview-loading" style="color: #dc3545;">Failed to load items</div>`;
          }
        } else {
          renderPreviewItems(orderId, orderDetailsCache[orderId]);
        }
      }
    }
    
    // Render preview items
    function renderPreviewItems(orderId, data) {
      const previewContent = document.getElementById(`preview-content-${orderId}`);
      const products = data.products || [];
      const order = data.order || {};
      const shippingAddresses = data.shippingAddresses || [];
      
      const billing = order.billing_address || {};
      const shipping = shippingAddresses[0] || billing;
      
      if (products.length === 0) {
        previewContent.innerHTML = '<div class="preview-loading">No items in this order</div>';
        return;
      }
      
      let html = `
        <div class="preview-grid">
          <div class="preview-address-box">
            <h5>Billing</h5>
            <p>
              <strong>${billing.first_name || ''} ${billing.last_name || ''}</strong><br>
              ${billing.street_1 || ''}${billing.street_2 ? ', ' + billing.street_2 : ''}<br>
              ${billing.city || ''}, ${billing.state || ''} ${billing.zip || ''}<br>
              ${billing.country || ''}
            </p>
            <div class="contact">
              ðŸ“§ ${billing.email || 'N/A'}<br>
              ðŸ“ž ${billing.phone || 'N/A'}
            </div>
          </div>
          
          <div class="preview-address-box">
            <h5>Shipping</h5>
            <p>
              <strong>${shipping.first_name || ''} ${shipping.last_name || ''}</strong><br>
              ${shipping.street_1 || ''}${shipping.street_2 ? ', ' + shipping.street_2 : ''}<br>
              ${shipping.city || ''}, ${shipping.state || ''} ${shipping.zip || ''}<br>
              ${shipping.country || ''}
            </p>
          </div>
          
          <div class="preview-items-box">
            <h5>Items (${products.length})</h5>
            <table class="preview-items-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Product</th>
                  <th class="qty">Qty</th>
                  <th class="price">Price</th>
                </tr>
              </thead>
              <tbody>
      `;
      
      for (const p of products) {
        html += `
                <tr>
                  <td class="sku">${p.sku || '-'}</td>
                  <td>${p.name}</td>
                  <td class="qty">${p.quantity}</td>
                  <td class="price">$${parseFloat(p.total_inc_tax || 0).toFixed(2)}</td>
                </tr>
        `;
      }
      
      html += `
              </tbody>
            </table>
            <div class="preview-total">
              Order Total: $${parseFloat(order.total_inc_tax || 0).toFixed(2)}
            </div>
          </div>
        </div>
        <button class="view-full-btn" onclick="viewOrder(${orderId})">View Full Order</button>
      `;
      
      previewContent.innerHTML = html;
    }
    
    // Get status class
    function getStatusClass(status) {
      status = (status || '').toLowerCase();
      if (status.includes('complete')) return 'status-completed';
      if (status.includes('ship')) return 'status-shipped';
      if (status.includes('refund')) return 'status-refunded';
      return 'status-pending';
    }
    
    // View order details
    async function viewOrder(orderId) {
      const modal = document.getElementById('orderModal');
      const modalBody = document.getElementById('modalBody');
      
      document.getElementById('modalOrderId').textContent = orderId;
      modal.classList.add('active');
      
      // Use cache if available
      if (orderDetailsCache[orderId]) {
        displayOrderDetail(orderDetailsCache[orderId]);
        return;
      }
      
      modalBody.innerHTML = '<div class="loading">Loading order details...</div>';
      
      try {
        const response = await fetch(`/api/order/${currentStore}/${orderId}`);
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Failed to load order');
        }
        
        orderDetailsCache[orderId] = data;
        displayOrderDetail(data);
        
      } catch (err) {
        modalBody.innerHTML = `<div class="no-results" style="color: #dc3545;">${err.message}</div>`;
      }
    }
    
    // Display order detail - Clean Layout
    function displayOrderDetail(data) {
      const order = data.order;
      const products = data.products || [];
      const shippingAddresses = data.shippingAddresses || [];
      const shipments = data.shipments || [];
      
      const billing = order.billing_address || {};
      const shipping = shippingAddresses[0] || billing;
      
      // Format date
      const orderDate = new Date(order.date_created).toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
      });
      
      let html = `
        <!-- Status Bar -->
        <div class="order-status-bar">
          <div class="status-item">
            <label>Order Date</label>
            <span>${orderDate}</span>
          </div>
          <div class="status-item">
            <label>Status</label>
            <span>${order.status}</span>
          </div>
          <div class="status-item">
            <label>Payment</label>
            <span>${order.payment_status || 'N/A'}</span>
          </div>
          <div class="status-item">
            <label>Method</label>
            <span>${order.payment_method || 'N/A'}</span>
          </div>
        </div>
        
        <!-- Billing & Shipping -->
        <div class="order-detail-grid">
          <div class="order-detail-box">
            <h4>Billing Details</h4>
            <p>
              <strong>${billing.first_name || ''} ${billing.last_name || ''}</strong><br>
              ${billing.street_1 || ''}${billing.street_2 ? ' ' + billing.street_2 : ''}<br>
              ${billing.city || ''}, ${billing.state || ''} ${billing.zip || ''}<br>
              ${billing.country || ''}
            </p>
            <p style="margin-top: 10px;">
              <strong>Email:</strong> ${billing.email || 'N/A'}<br>
              <strong>Phone:</strong> ${billing.phone || 'N/A'}
            </p>
          </div>
          <div class="order-detail-box">
            <h4>Shipping Details</h4>
            <p>
              <strong>${shipping.first_name || ''} ${shipping.last_name || ''}</strong><br>
              ${shipping.street_1 || ''}${shipping.street_2 ? ' ' + shipping.street_2 : ''}<br>
              ${shipping.city || ''}, ${shipping.state || ''} ${shipping.zip || ''}<br>
              ${shipping.country || ''}
            </p>
          </div>
        </div>
        
        <!-- Products -->
        <table class="product-table">
          <thead>
            <tr>
              <th>SKU</th>
              <th class="product-name">Product</th>
              <th class="text-right">Qty</th>
              <th class="text-right">Price</th>
              <th class="text-right">Total</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      for (const product of products) {
        html += `
          <tr>
            <td>${product.sku || 'N/A'}</td>
            <td class="product-name">${product.name}</td>
            <td class="text-right">${product.quantity}</td>
            <td class="text-right">$${parseFloat(product.base_price || product.price_inc_tax || 0).toFixed(2)}</td>
            <td class="text-right">$${parseFloat(product.total_inc_tax || 0).toFixed(2)}</td>
          </tr>
        `;
      }
      
      html += `
          </tbody>
        </table>
        
        <!-- Order Totals -->
        <div class="order-totals">
          <div class="total-row">
            <span>Subtotal:</span>
            <span>$${parseFloat(order.subtotal_ex_tax || order.subtotal_inc_tax || 0).toFixed(2)}</span>
          </div>
      `;
      
      // Show coupon discount if exists
      const couponDiscount = parseFloat(order.coupon_discount || 0);
      if (couponDiscount > 0) {
        html += `
          <div class="total-row discount">
            <span>Coupon${order.coupon_code ? ` (${order.coupon_code})` : ''}:</span>
            <span>-$${couponDiscount.toFixed(2)}</span>
          </div>
        `;
      }
      
      // Show other discount if exists
      const discountAmount = parseFloat(order.discount_amount || 0);
      if (discountAmount > 0 && discountAmount !== couponDiscount) {
        html += `
          <div class="total-row discount">
            <span>Discount:</span>
            <span>-$${discountAmount.toFixed(2)}</span>
          </div>
        `;
      }
      
      html += `
          <div class="total-row">
            <span>Shipping:</span>
            <span>$${parseFloat(order.shipping_cost_inc_tax || 0).toFixed(2)}</span>
          </div>
          <div class="total-row">
            <span>Tax:</span>
            <span>$${parseFloat(order.total_tax || 0).toFixed(2)}</span>
          </div>
          <div class="total-row grand-total">
            <span>Total:</span>
            <span>$${parseFloat(order.total_inc_tax || 0).toFixed(2)}</span>
          </div>
      `;
      
      // Show refund if exists
      const refundedAmount = parseFloat(order.refunded_amount || 0);
      if (refundedAmount > 0) {
        html += `
          <div class="total-row refund">
            <span>Refunded:</span>
            <span>-$${refundedAmount.toFixed(2)}</span>
          </div>
        `;
      }
      
      html += `</div>`;
      
      // Tracking info
      if (shipments && shipments.length > 0) {
        html += `<div class="tracking-box"><h4>Tracking Information</h4>`;
        for (const shipment of shipments) {
          const trackingUrl = getTrackingUrl(shipment.tracking_carrier, shipment.tracking_number);
          html += `
            <p>
              <strong>${shipment.shipping_method || 'Shipment'}</strong><br>
              ${trackingUrl 
                ? `<a href="${trackingUrl}" target="_blank" class="tracking-link">${shipment.tracking_number}</a>`
                : shipment.tracking_number || 'No tracking number'
              }
              ${shipment.tracking_carrier ? `<span style="color: #666;"> (${shipment.tracking_carrier})</span>` : ''}
            </p>
          `;
        }
        html += `</div>`;
      }
      
      // Notes
      if (order.customer_message || order.staff_notes) {
        html += `<div class="notes-box"><h4>Notes</h4>`;
        if (order.customer_message) {
          html += `<p><strong>Customer:</strong> ${order.customer_message}</p>`;
        }
        if (order.staff_notes) {
          html += `<p><strong>Staff:</strong> ${order.staff_notes}</p>`;
        }
        html += `</div>`;
      }
      
      document.getElementById('modalBody').innerHTML = html;
    }
    
    // Get tracking URL
    function getTrackingUrl(carrier, number) {
      if (!number) return null;
      carrier = (carrier || '').toLowerCase();
      
      if (carrier.includes('usps')) {
        return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${number}`;
      } else if (carrier.includes('ups')) {
        return `https://www.ups.com/track?tracknum=${number}`;
      } else if (carrier.includes('fedex')) {
        return `https://www.fedex.com/fedextrack/?trknbr=${number}`;
      } else if (carrier.includes('dhl')) {
        return `https://www.dhl.com/en/express/tracking.html?AWB=${number}`;
      }
      return null;
    }
    
    // Close modal
    function closeModal() {
      document.getElementById('orderModal').classList.remove('active');
    }
    
    // Close modal on outside click
    document.getElementById('orderModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
    
    // Logout
    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = '/login';
    }
    
    // Initialize
    checkAuth();
  </script>
</body>
</html>
