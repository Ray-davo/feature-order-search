<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Search</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }

    .header {
      background: #2c2c2c;
      color: #fff;
      padding: 8px 20px;
      position: relative;
      display: flex;
      align-items: flex-start;
      min-height: 84px;
    }
    .header-left { width: 210px; }
    .logo { width: 210px; height: 84px; object-fit: contain; display: block; }
    .header-title {
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
      font-size: 24px;
      white-space: nowrap;
    }
    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 15px;
      padding-top: 10px;
    }
    .user-info { color: #aaa; }
    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    .admin-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
    }
    .admin-btn:hover { background: #5a6268; }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .search-box {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .search-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .search-row select,
    .search-row input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    .search-row select { width: 150px; }
    .search-row input { flex: 1; min-width: 200px; }
    .search-row button {
      padding: 12px 30px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    .search-row button:hover { background: #0056b3; }
    .search-row button:disabled { background: #ccc; cursor: not-allowed; }

    .db-stats {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      font-size: 13px;
      color: #666;
    }

    .results {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .results-header {
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .expand-all-btn {
      padding: 6px 14px;
      background: #f0f4ff;
      border: 1px solid #007bff;
      color: #007bff;
      border-radius: 5px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
    }
    .expand-all-btn:hover { background: #007bff; color: #fff; }
    .expand-all-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .no-results {
      padding: 40px;
      text-align: center;
      color: #666;
    }
    .order-row {
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .order-row:hover { background: #f8f9fa; }

    /* Expand button */
    .expand-btn {
      width: 60px;
      height: 60px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 50px;
      font-weight: normal;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
      margin-right: 15px;
    }
    .expand-btn:hover { background: #007bff; border-color: #007bff; color: #fff; }
    .expand-btn.expanded { background: #007bff; border-color: #007bff; color: #fff; }

    .order-info { flex: 1; cursor: pointer; }
    .order-id { font-weight: 600; color: #007bff; }
    .order-customer { color: #333; margin-top: 3px; }
    .order-email { color: #666; font-size: 14px; }

    .order-meta { text-align: right; cursor: pointer; }
    .order-total { font-weight: 600; font-size: 18px; }
    .order-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 12px;
      margin-top: 5px;
    }
    .status-completed { background: #d4edda; color: #155724; font-size: 13px; }
    .status-pending { background: #fff3cd; color: #856404; font-size: 13px;}
    .status-shipped { background: #cce5ff; color: #004085; font-size: 13px;}
    .status-refunded { background: #f8d7da; color: #721c24; font-size: 13px;}

    /* Preview Panel */
    .preview-panel { display: none; background: #f8fafc; border-bottom: 1px solid #eee; }
    .preview-panel.show { display: block; }
    .preview-content {
      padding: 12px 20px;
    }
    .preview-loading { padding: 15px; color: #666; font-style: italic; }
    .preview-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 10px;
    }
    .preview-address-box {
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      font-size: 16px;
      line-height: 1.7;
    }
    .preview-address-box h5 {
      margin: 0 0 6px 0;
      font-size: 18px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .preview-address-box p { margin: 0; }
    .preview-address-box .contact {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid #eee;
      font-size: 16px;
      color: #555;
    }

    .preview-address-box .contact.contact-inline{
      display: flex;
      align-items: center;
      gap: 40px;
      flex-wrap: wrap;
    }
    .preview-address-box .contact.contact-inline span{
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .tracking-inline {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid #eee;
      font-size: 16px;
      color: #555;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .tracking-inline .tracking-label{
      font-weight: 600;
      color: #555;
      white-space: nowrap;
    }
    .tracking-inline .tracking-numbers{
      display: inline-flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .tracking-inline .tracking-sep{
      color: #999;
      font-weight: 400;
    }
    .tracking-inline .tracking-link {
      color: #007bff;
      text-decoration: none;
      font-weight: 600;
      word-break: normal;
      overflow-wrap: anywhere;
    }
    .tracking-inline .tracking-link:hover { text-decoration: underline; }

    /* Plain labels + easy copy (no emoji/icons) */
    .field-label{
      font-weight: 600;
      color: #555;
      margin-right: 4px;
      white-space: nowrap;
    }
    .copyable{
      user-select: text;
    }

    .meta-line{
      margin-top: 4px;
      font-size: 16px;
      color: #555;
      display: flex;
      align-items: baseline;
      gap: 6px;
      flex-wrap: wrap;
    }

    /* Carrier badge in tracking line */
    .carrier-badge{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid #d9d9d9;
      background: #f1f3f5;
      color: #333;
      white-space: nowrap;
      line-height: 1.2;
    }

    .preview-items-box {
      grid-column: 1 / -1;
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }
    .preview-items-box h5 {
      margin: 0 0 8px 0;
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .preview-items-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 16px;
    }
    .preview-items-table th {
      text-align: left;
      padding: 8px 10px;
      background: #e9ecef;
      font-weight: 600;
      color: #555;
      font-size: 14px;
      text-transform: uppercase;
    }
    .preview-items-table td { padding: 8px 10px; border-bottom: 1px solid #eee; }
    .preview-items-table .sku { font-family: monospace; font-size: 16px; color: #666; }
    .preview-items-table .qty { text-align: center; }
    .preview-items-table .price { text-align: right; }

    .preview-total {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
      text-align: right;
      font-weight: 600;
      font-size: 16px;
      line-height: 1.8;

    }

    
    /* Shipping header row inside preview box (keeps button top-right without adding a line) */
    .preview-box-header{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin: 0 0 6px 0;
    }
    .preview-box-header h5{
      margin: 0;
      font-size: 18px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* View Full Order button (compact + secondary) */
    .view-full-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: #2e9e45;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      line-height: 1;
    }
    .view-full-btn:hover { background: #278a3c; }

    /* Totals block: keep it right-aligned like an invoice */
    .preview-total{
      max-width: 320px;
      margin-left: auto;
    }
    .preview-total .coupon-label{ color:#000; font-weight: 600; }
    .preview-total .coupon-value{ color:#d32f2f; font-weight: 700; }

    /* Notes Section (Preview only) */
    .notes-section {
      margin-top: 15px;
      background: #eaf4ff;
      border: 1px solid #c3ddf7;
      border-left: 4px solid #007bff;
      border-radius: 6px;
      padding: 14px 16px;
    }
    .notes-section h5 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: #0056b3;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .notes-list { max-height: 200px; overflow-y: auto; margin-bottom: 10px; }
    .note-item {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      font-size: 13px;
    }
    .note-item:last-child { margin-bottom: 0; }
    .note-meta { font-size: 16px; color: #888; margin-bottom: 5px;}
    .note-meta strong { color: #555; }
    .note-text { color: #333; line-height: 1.4; white-space: pre-wrap; font-size: 16px; }
    .note-form { display: flex; flex-direction: column; gap: 8px; }
    .note-textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
    }
    .note-textarea:focus { outline: none; border-color: #007bff; }
    .note-form-footer { display: flex; justify-content: space-between; align-items: center; }
    .char-counter { font-size: 11px; color: #888; }
    .char-counter.warning { color: #dc3545; }
    .add-note-btn {
      padding: 6px 14px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    .add-note-btn:hover { background: #0056b3; }
    .add-note-btn:disabled { background: #ccc; cursor: not-allowed; }
    .no-notes { color: #888; font-size: 13px; font-style: italic; }

    /* Order Detail Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }
    .modal.active { display: block; }
    .modal-content {
      background: white;
      margin: 30px auto;
      max-width: 900px;
      border-radius: 8px;
      max-height: calc(100vh - 60px);
      overflow-y: auto;
    }
    .modal-header {
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 10px;
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
    }
    .modal-header h2 { margin: 0; font-size: 18px; }
    .print-btn {
      margin-left: auto;
      background: #007bff;
      color: #fff;
      border: 0;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    .print-btn:hover { background: #0056b3; }
    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #666;
      line-height: 1;
    }
    .modal-body { padding: 0; }

    .loading { text-align: center; padding: 40px; color: #666; }

    /* Invoice layout (View Full Order) */
    .invoice-wrap { background:#fff; padding:20px; }
    .invoice-top { display:flex; justify-content:space-between; gap:20px; align-items:flex-start; }
    .invoice-brand img { height:60px; width:auto; display:block; margin-bottom:8px; }
    .invoice-brand .addr { font-size:12px; color:#333; line-height:1.4; }
    .invoice-meta { text-align:right; font-size:12px; color:#333; line-height:1.6; }
    .invoice-meta .inv-title { font-size:16px; font-weight:700; margin-bottom:6px; }
    .invoice-two { display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:18px; }
    .invoice-box { border:1px solid #e6e6e6; border-radius:6px; padding:12px; }
    .invoice-box h4 { font-size:12px; text-transform:uppercase; letter-spacing:.04em; margin-bottom:8px; color:#444; }
    .invoice-box p { font-size:13px; color:#222; line-height:1.4; margin:0; }
    .invoice-table { width:100%; border-collapse:collapse; margin-top:18px; font-size:13px; }
    .invoice-table th { text-align:left; border-bottom:1px solid #e6e6e6; padding:10px 8px; font-size:12px; color:#444; }
    .invoice-table td { border-bottom:1px solid #f0f0f0; padding:10px 8px; vertical-align:top; }
    .invoice-table .num { text-align:right; white-space:nowrap; }
    .invoice-table .sku { white-space:nowrap; color:#333; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .invoice-totals { margin-top:14px; width:320px; margin-left:auto; }
    .invoice-totals .row { display:flex; justify-content:space-between; padding:6px 0; font-size:13px; }
    .invoice-totals .row strong { font-size:14px; }
    .invoice-totals .grand { border-top:1px solid #e6e6e6; margin-top:6px; padding-top:10px; font-weight:700; }
    .tracking-link { color:#007bff; text-decoration:none; font-weight:600; }
    .tracking-link:hover { text-decoration: underline; }

    @media print {
  @page {
    margin: 0.5in;
    size: letter;
  }

  /* FORCE CONSISTENT SIZING - Override any browser zoom/scale settings */
  html {
    zoom: 1 !important;
    -webkit-transform: scale(1) !important;
    transform: scale(1) !important;
    -webkit-text-size-adjust: 100% !important;
    text-size-adjust: 100% !important;
  }

  /* IMPORTANT:
     Use PT units for print so Chrome/Edge PDF matches "real-world" text sizing.
     14pt prints much closer to what people expect as "14" than 14px (which is ~10.5pt). */
  html, body {
    font-size: 12pt !important;
    line-height: 1.4 !important;
    background: #fff !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    width: 100% !important;
    height: auto !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Reset any transforms that might affect sizing */
  *, *::before, *::after {
    -webkit-transform: none !important;
    transform: none !important;
    zoom: 1 !important;
  }

  .invoice-totals .grand,
  .invoice-totals .grand span,
  .invoice-totals .grand strong {
    font-size: 14pt !important;
    font-weight: 600 !important;
    line-height: 1.4 !important;
  }

  .header, .container { display: none !important; }

  .modal { 
    position: static !important; 
    background: transparent !important;
    display: block !important;
    width: 100% !important;
    height: auto !important;
    overflow: visible !important;
  }
  .modal-content {
    box-shadow: none !important;
    max-width: 7.5in !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    border-radius: 0 !important;
    max-height: none !important;
    overflow: visible !important;
    position: static !important;
  }

  .modal-body {
    max-height: none !important;
    overflow: visible !important;
    padding: 0 !important;
  }

  .modal-header { 
    position: static !important; 
    padding: 0 0 10pt 0 !important;
    border-bottom: 1px solid #ccc !important;
    margin-bottom: 10pt !important;
  }
  .modal-header h2 { font-size: 14pt !important; font-weight: 700 !important; }
  .close-btn, .print-btn { display: none !important; }

  /* Invoice wrapper - constrain width */
  .invoice-wrap {
    max-width: 7.5in !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* Force invoice area to inherit the baseline */
  .invoice-wrap,
  .invoice-brand .addr,
  .invoice-brand .addr div,
  .invoice-meta,
  .invoice-meta div,
  .invoice-box,
  .invoice-box p,
  .invoice-box p strong,
  .invoice-box div,
  .invoice-table,
  .invoice-table tbody,
  .invoice-table tr,
  .invoice-table td,
  .invoice-totals,
  .invoice-totals .row,
  .invoice-totals .row span,
  .tracking-link {
    font-size: 11pt !important;
    line-height: 1.4 !important;
  }

  /* Header section with logo */
  .invoice-brand {
    display: flex !important;
    justify-content: space-between !important;
    margin-bottom: 15pt !important;
  }

  .invoice-brand .addr {
    font-size: 10pt !important;
    line-height: 1.3 !important;
  }

  /* Keep hierarchy without making body text small */
  .invoice-meta .inv-title { font-size: 14pt !important; font-weight: 700 !important; }
  .invoice-box h4 { font-size: 10pt !important; font-weight: 600 !important; margin-bottom: 5pt !important; }

  /* Address boxes */
  .invoice-addresses {
    display: flex !important;
    gap: 20pt !important;
    margin-bottom: 15pt !important;
  }
  .invoice-box {
    flex: 1 !important;
    padding: 10pt !important;
    border: 1px solid #ddd !important;
  }
  .invoice-box p {
    margin: 2pt 0 !important;
    font-size: 10pt !important;
  }

  /* Table styling */
  .invoice-table { 
    width: 100% !important;
    border-collapse: collapse !important;
    margin-bottom: 15pt !important;
  }
  .invoice-table th { 
    font-size: 9pt !important; 
    padding: 6pt 5pt !important; 
    background: #f5f5f5 !important;
    border-bottom: 1px solid #ccc !important;
    text-align: left !important;
  }
  .invoice-table td { 
    padding: 6pt 5pt !important;
    font-size: 10pt !important;
    border-bottom: 1px solid #eee !important;
    vertical-align: top !important;
  }

  /* Totals section */
  .invoice-totals {
    max-width: 250pt !important;
    margin-left: auto !important;
  }
  .invoice-totals .row {
    display: flex !important;
    justify-content: space-between !important;
    padding: 3pt 0 !important;
    font-size: 10pt !important;
  }
  .invoice-totals .grand {
    border-top: 1px solid #333 !important;
    margin-top: 5pt !important;
    padding-top: 5pt !important;
  }

  /* Logo sizing for print */
  .invoice-brand img {
    height: 35pt !important;
    width: auto !important;
    max-width: 150pt !important;
    object-fit: contain !important;
  }

  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  /* Hide session warning if visible */
  .session-warning { display: none !important; }
}
      /* ===== Collapsed row (before + preview) ===== */
    .order-row{
      display: grid !important;
      grid-template-columns: 26px 90px minmax(100px, 1fr) minmax(140px, 1.3fr) 65px minmax(130px, 160px) 70px;
      gap: 10px;
      align-items: center;
      justify-content: initial !important;
      padding: 10px 16px !important;
    }
    .order-row > * { min-width: 0; } /* allow ellipsis */
    .order-col{
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.2;
    }
    .order-col.order-id{
      font-weight: 600;
      color: #007bff;
      cursor: pointer;
    }
    .order-col.order-customer{ color:#333; }
    .order-col.order-email{ color:#333; font-size: 16px; }
    .order-col.order-date{ color:#333; font-size: 16px; text-align:right; }
    .order-col.order-total{
      text-align: right;
      font-weight: 700;
      font-size: 18px;
      color:#111;
    }
    /* Make the status pill align nicely in the grid */
    .order-row .order-status{
      justify-self: end;
      margin-top: 0 !important;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Smaller + / - button (collapsed row) */
    .expand-btn{
      width: 22px !important;
      height: 22px !important;
      font-size: 16px !important;
      border-radius: 4px;
      margin-right: 0 !important;
    }

    /* Responsive: keep one line, but shrink columns a bit */
    @media (max-width: 900px){
      .order-row{
        grid-template-columns: 26px 80px minmax(90px, 1fr) minmax(120px, 1.3fr) 60px minmax(110px, 140px) 65px;
        gap: 8px;
      }
    }

    /* Session timeout warning modal */
    .session-warning {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    .session-warning.show {
      display: flex;
    }
    .session-warning-content {
      background: white;
      padding: 30px 40px;
      border-radius: 12px;
      text-align: center;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .session-warning-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .session-warning h3 {
      margin: 0 0 10px 0;
      font-size: 20px;
      color: #333;
    }
    .session-warning p {
      margin: 0 0 20px 0;
      color: #666;
      font-size: 15px;
      line-height: 1.5;
    }
    .session-warning .countdown {
      font-size: 32px;
      font-weight: 700;
      color: #dc3545;
      margin-bottom: 20px;
      font-family: monospace;
    }
    .session-warning-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
    }
    .session-warning-buttons button {
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: background 0.2s;
    }
    .btn-stay {
      background: #28a745;
      color: white;
    }
    .btn-stay:hover {
      background: #218838;
    }
    .btn-logout {
      background: #6c757d;
      color: white;
    }
    .btn-logout:hover {
      background: #5a6268;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-left">
      <img
        src="https://cdn11.bigcommerce.com/s-9u5u1ss/images/stencil/250x100/1ink-logo_1769641248__97578.original.jpg"
        alt="1ink"
        class="logo"
      >
    </div>

    <h1 class="header-title">Order Search</h1>

    <div class="header-right">
      <span class="user-info">Logged in as: <strong id="username"></strong></span>
      <a href="/admin" class="admin-btn" id="adminLink" style="display: none;">Admin</a>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="search-box">
      <div class="search-row">
        <select id="store">
          <option value="1ink">1ink.com</option>
          <option value="needink">needink.com</option>
        </select>
        <input type="text" id="searchQuery" placeholder="Order #, email, phone, or name..." onkeypress="if(event.key==='Enter')search()">
        <button onclick="search()" id="searchBtn">Search</button>
      </div>     
    </div>

    <div class="results" id="results">
      <div class="no-results">Enter a search term above to find orders</div>
    </div>
  </div>

  <!-- Order Detail Modal -->
  <div class="modal" id="orderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Order #<span id="modalOrderId"></span></h2>
        <button class="print-btn" onclick="window.print()">Print</button>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div class="loading">Loading order details...</div>
      </div>
    </div>
  </div>

  <!-- Session Timeout Warning Modal -->
  <div class="session-warning" id="sessionWarning">
    <div class="session-warning-content">
      <div class="session-warning-icon">â°</div>
      <h3>Session Expiring Soon</h3>
      <p>Your session will expire due to inactivity.<br>Do you want to stay logged in?</p>
      <div class="countdown" id="sessionCountdown">2:00</div>
      <div class="session-warning-buttons">
        <button class="btn-stay" onclick="extendSession()">Stay Logged In</button>
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <script>
    let currentStore = '1ink';
    let expandedOrders = {};
    let orderDetailsCache = {};
    let currentOrders = [];

    // Session monitoring
    let sessionCheckInterval = null;
    let countdownInterval = null;
    let sessionWarningShown = false;

    function startSessionMonitor() {
      // Check session status every 30 seconds
      sessionCheckInterval = setInterval(checkSessionStatus, 30000);
    }

    async function checkSessionStatus() {
      try {
        const response = await fetch('/api/session-check');
        const data = await response.json();

        if (!data.valid) {
          // Session expired, redirect to login
          window.location.href = '/login';
          return;
        }

        if (data.showWarning && !sessionWarningShown) {
          showSessionWarning(data.remainingSec);
        }
      } catch (err) {
        console.error('Session check failed:', err);
      }
    }

    function showSessionWarning(remainingSec) {
      sessionWarningShown = true;
      const modal = document.getElementById('sessionWarning');
      const countdown = document.getElementById('sessionCountdown');
      
      modal.classList.add('show');
      
      let seconds = remainingSec;
      
      function updateCountdown() {
        const min = Math.floor(seconds / 60);
        const sec = seconds % 60;
        countdown.textContent = `${min}:${sec.toString().padStart(2, '0')}`;
        
        if (seconds <= 0) {
          clearInterval(countdownInterval);
          window.location.href = '/login';
          return;
        }
        seconds--;
      }
      
      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    function hideSessionWarning() {
      sessionWarningShown = false;
      const modal = document.getElementById('sessionWarning');
      modal.classList.remove('show');
      
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }

    async function extendSession() {
      try {
        const response = await fetch('/api/session-extend', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          hideSessionWarning();
        }
      } catch (err) {
        console.error('Failed to extend session:', err);
      }
    }

    function capitalize(str) {
      return str ? (str.charAt(0).toUpperCase() + str.slice(1).toLowerCase()) : '';
    }

    async function checkAuth() {
      try {
        const response = await fetch('/api/auth-check');
        const data = await response.json();

        if (!data.authenticated) {
          window.location.href = '/login';
          return;
        }

        document.getElementById('username').textContent = capitalize(data.user);
        
        // Show admin link if user is admin
        if (data.isAdmin) {
          document.getElementById('adminLink').style.display = 'inline-block';
        }
        
        loadDbStats();
        startSessionMonitor(); // Start monitoring session timeout
      } catch (err) {
        window.location.href = '/login';
      }
    }

    async function loadDbStats() {
      try {
        const response = await fetch('/api/db-stats');
        const stats = await response.json();

        const store = document.getElementById('store').value;
        const storeStats = stats[store];
        const el = document.getElementById('dbStats');
        if (!el) return;

        if (storeStats && storeStats.count > 0) {
          const oldest = new Date(storeStats.oldest).toLocaleDateString();
          const newest = new Date(storeStats.newest).toLocaleDateString();
          el.innerHTML = `<strong>${store}:</strong> ${storeStats.count.toLocaleString()} orders indexed (${oldest} to ${newest})`;
        } else {
          el.innerHTML = `<strong>${store}:</strong> No orders indexed yet. Run sync to populate.`;
        }
      } catch (err) {
        const el = document.getElementById('dbStats');
        if (el) el.textContent = '';
      }
    }

    document.getElementById('store').addEventListener('change', function() {
      loadDbStats();
      expandedOrders = {};
      orderDetailsCache = {};
      currentOrders = [];
    });

    function detectSearchType(query, store) {
      const trimmed = query.trim();

      if (trimmed.includes('@')) return { type: 'email', label: 'Email' };

      const digitsOnly = trimmed.replace(/\D/g, '');

      if (store === '1ink' && /^7\d{6}$/.test(digitsOnly)) return { type: 'order', label: 'Order #' };
      if (store === 'needink' && /^(89|90)\d{4}$/.test(digitsOnly)) return { type: 'order', label: 'Order #' };

      if (/^\d{10,11}$/.test(digitsOnly)) return { type: 'phone', label: 'Phone' };

      return { type: 'name', label: 'Name' };
    }

    async function search() {
      const store = document.getElementById('store').value;
      const query = document.getElementById('searchQuery').value.trim();

      if (!query) {
        alert('Please enter a search term');
        return;
      }

      const detected = detectSearchType(query, store);
      const searchType = detected.type;

      const btn = document.getElementById('searchBtn');
      const resultsDiv = document.getElementById('results');

      btn.disabled = true;
      btn.textContent = 'Searching...';
      resultsDiv.innerHTML = `<div class="loading">Searching by ${detected.label}...</div>`;

      expandedOrders = {};
      orderDetailsCache = {};

      try {
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ store, searchType, query })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Search failed');

        currentStore = store;
        displayResults(data.orders, detected.label);

      } catch (err) {
        resultsDiv.innerHTML = `<div class="no-results" style="color: #dc3545;">${err.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Search';
      }
    }

    function displayResults(orders, searchedBy) {
      const resultsDiv = document.getElementById('results');

      // Filter out Incomplete orders (abandoned checkouts - nothing for support to act on)
      orders = (orders || []).filter(o => (o.status || '').toLowerCase() !== 'incomplete');

      if (!orders || orders.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No orders found</div>';
        return;
      }

      currentOrders = orders;

      const expandAllBtn = orders.length > 1
        ? `<button class="expand-all-btn" id="expandAllBtn" onclick="expandAllOrders()">Expand All</button>`
        : '';

      let html = `<div class="results-header">${orders.length} order${orders.length !== 1 ? 's' : ''} found <span style="color: #888; font-weight: normal; font-size: 13px;">(searched by ${searchedBy})</span>${expandAllBtn}</div>`;

      for (const order of orders) {
        const date = new Date(order.date_created).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
        const statusClass = getStatusClass(order.status);
        const customerName = order.billing_address
          ? `${order.billing_address.first_name || ''} ${order.billing_address.last_name || ''}`.trim()
          : 'Guest';
        const customerEmail = order.billing_address?.email || '';

        html += `          <div class="order-row" id="order-row-${order.id}" onclick="togglePreview(null, ${order.id})">
            <button class="expand-btn" onclick="togglePreview(event, ${order.id})" title="Preview items">+</button>

            <div class="order-col order-id">#${order.id}</div>

            <div class="order-col order-customer" title="${customerName}">${customerName}</div>

            <div class="order-col order-email" title="${customerEmail}">${customerEmail}</div>

            <div class="order-col order-date">${date}</div>

            <div class="order-col order-status ${statusClass}">${order.status}</div>

            <div class="order-col order-total">$${parseFloat(order.total_inc_tax || 0).toFixed(2)}</div>
          </div>
          </div>
          <div class="preview-panel" id="preview-${order.id}">
            <div class="preview-content" id="preview-content-${order.id}">
              <div class="preview-loading">Loading items...</div>
            </div>
          </div>
        `;
      }

      resultsDiv.innerHTML = html;
    }

    async function expandAllOrders() {
      const btn = document.getElementById('expandAllBtn');
      const allExpanded = currentOrders.every(o => expandedOrders[o.id]);

      if (allExpanded) {
        // Collapse all
        for (const order of currentOrders) {
          const previewPanel = document.getElementById(`preview-${order.id}`);
          const expandBtn = document.querySelector(`#order-row-${order.id} .expand-btn`);
          if (previewPanel) previewPanel.classList.remove('show');
          if (expandBtn) { expandBtn.classList.remove('expanded'); expandBtn.innerHTML = '+'; }
          delete expandedOrders[order.id];
        }
        if (btn) btn.textContent = 'Expand All';
      } else {
        // Expand all
        if (btn) { btn.textContent = 'Loading...'; btn.disabled = true; }

        for (const order of currentOrders) {
          const previewPanel = document.getElementById(`preview-${order.id}`);
          const expandBtn = document.querySelector(`#order-row-${order.id} .expand-btn`);
          const previewContent = document.getElementById(`preview-content-${order.id}`);

          if (!previewPanel) continue;

          previewPanel.classList.add('show');
          if (expandBtn) { expandBtn.classList.add('expanded'); expandBtn.innerHTML = '&minus;'; }
          expandedOrders[order.id] = true;

          if (!orderDetailsCache[order.id]) {
            try {
              const response = await fetch(`/api/order/${currentStore}/${order.id}`);
              const data = await response.json();
              if (response.ok) {
                orderDetailsCache[order.id] = data;
                renderPreviewItems(order.id, data);
              }
            } catch (err) {
              if (previewContent) previewContent.innerHTML = `<div class="preview-loading" style="color:#dc3545;">Failed to load</div>`;
            }
          } else {
            renderPreviewItems(order.id, orderDetailsCache[order.id]);
          }
        }

        if (btn) { btn.textContent = 'Collapse All'; btn.disabled = false; }
      }
    }

    async function togglePreview(event, orderId) {
      if (event) event.stopPropagation();

      const previewPanel = document.getElementById(`preview-${orderId}`);
      const expandBtn = document.querySelector(`#order-row-${orderId} .expand-btn`);
      const previewContent = document.getElementById(`preview-content-${orderId}`);

      if (expandedOrders[orderId]) {
        previewPanel.classList.remove('show');
        expandBtn.classList.remove('expanded');
        expandBtn.innerHTML = '+';
        delete expandedOrders[orderId];
      } else {
        previewPanel.classList.add('show');
        expandBtn.classList.add('expanded');
        expandBtn.innerHTML = '&minus;';
        expandedOrders[orderId] = true;

        if (!orderDetailsCache[orderId]) {
          previewContent.innerHTML = '<div class="preview-loading">Loading items...</div>';

          try {
            const response = await fetch(`/api/order/${currentStore}/${orderId}`);
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || 'Failed to load');

            orderDetailsCache[orderId] = data;
            renderPreviewItems(orderId, data);
          } catch (err) {
            previewContent.innerHTML = `<div class="preview-loading" style="color: #dc3545;">Failed to load items</div>`;
          }
        } else {
          renderPreviewItems(orderId, orderDetailsCache[orderId]);
        }
      }

      // Sync the Expand All button label
      const allBtn = document.getElementById('expandAllBtn');
      if (allBtn && currentOrders.length > 1) {
        const allExpanded = currentOrders.every(o => expandedOrders[o.id]);
        allBtn.textContent = allExpanded ? 'Collapse All' : 'Expand All';
      }
    }

    // Detect carrier label from a tracking number (fallback if BigCommerce doesn't provide tracking_carrier)
    function detectCarrierLabel(number, carrierHint) {
      const hint = String(carrierHint || '').toLowerCase();
      const n = String(number || '').trim().replace(/\s+/g, '');

      if (!n) return '';

      const isUps = hint.includes('ups') || /^1Z[0-9A-Z]{16}$/i.test(n);
      const isUsps =
        hint.includes('usps') ||
        /^(94|93|92|95)\d{18,20}$/.test(n) ||
        /^420\d{5,}\d+$/.test(n);
      const isFedex =
        hint.includes('fedex') ||
        (/^\d+$/.test(n) && (n.length === 12 || n.length === 15)) ||
        (/^\d+$/.test(n) && (n.length === 20 || n.length === 22) && !/^(94|93|92|95)/.test(n));
      const isDhl = hint.includes('dhl') || /^JD\d+/i.test(n);

      if (isUps) return 'UPS';
      if (isUsps) return 'USPS';
      if (isFedex) return 'FedEx';
      if (isDhl) return 'DHL';
      return '';
    }

    // Build tracking HTML with clickable links + carrier badge (UPS/USPS/FedEx/DHL)
    function buildTrackingHtml(shipments) {
      if (!shipments || shipments.length === 0) return '';

      const nums = shipments
        .map(s => (s && s.tracking_number != null) ? String(s.tracking_number).trim() : '')
        .map(n => n.replace(/\s+/g, ''))
        .filter(Boolean);

      if (nums.length === 0) return '';

      // Determine carrier(s)
      const carriers = shipments.map((s, idx) => detectCarrierLabel(nums[idx], s && s.tracking_carrier)).filter(Boolean);
      const unique = Array.from(new Set(carriers));
      const carrierLabel = unique.length === 0 ? '' : (unique.length === 1 ? unique[0] : 'Mixed');

      // Build links
      const links = shipments.map((s) => {
        const carrierHint = String(s.tracking_carrier || '').toLowerCase();
        const rawNum = s.tracking_number;
        const num = rawNum ? String(rawNum).trim().replace(/\s+/g, '') : '';
        if (!num) return '';

        const url =
          getTrackingUrl(carrierHint, num) ||
          ('https://www.fedex.com/fedextrack/?trknbr=' + encodeURIComponent(num));

        return '<a href="' + url + '" target="_blank" rel="noopener noreferrer" class="tracking-link">' + num + '</a>';
      }).filter(Boolean);

      if (links.length === 0) return '';

      const badge = carrierLabel ? ('<span class="carrier-badge">' + carrierLabel + '</span>') : '';

      return '<div class="tracking-inline">' +
        '<strong class="tracking-label">Tracking:</strong>' +
        badge +
        '<span class="tracking-numbers">' + links.join('<span class="tracking-sep">, </span>') + '</span>' +
      '</div>';
    }


    // Format Order Date with time + timezone (America/Los_Angeles)
    function formatOrderDateTime(iso) {
      if (!iso) return '&mdash;';
      try {
        return new Date(iso).toLocaleString('en-US', {
          month: 'short',
          day: '2-digit',
          year: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          timeZone: 'America/Los_Angeles',
          timeZoneName: 'short'
        }).replace(',', '');
      } catch (e) {
        return '&mdash;';
      }
    }

    // Format Shipped date as date-only (America/Los_Angeles)
    function formatShippedDateOnly(shipments, order) {
      const pick = (v) => v ? new Date(v) : null;
      let dt = null;

      // Prefer an explicit shipped date if present (varies by API shape)
      if (shipments && shipments.length) {
        const s0 = shipments[0] || {};
        dt = pick(s0.date_shipped) || pick(s0.shipped_at) || pick(s0.date_created) || pick(s0.created_at) || null;
      }
      if (!dt && order) {
        dt = pick(order.date_shipped) || pick(order.shipped_at) || null;
      }
      if (!dt) return '&mdash;';

      try {
        return dt.toLocaleDateString('en-US', {
          month: 'short',
          day: '2-digit',
          year: 'numeric',
          timeZone: 'America/Los_Angeles'
        }).replace(',', '');
      } catch (e) {
        return '&mdash;';
      }
    }

    function renderPreviewItems(orderId, data) {
      const previewContent = document.getElementById(`preview-content-${orderId}`);
      const products = data.products || [];
      const order = data.order || {};
      const shippingAddresses = data.shippingAddresses || [];
      const shipments = data.shipments || [];

      const billing = order.billing_address || {};
      const shipping = shippingAddresses[0] || billing;

      const trackingHtml = buildTrackingHtml(shipments);

      const countryShort = (c) => {
        const v = (c || '').toString().trim().toLowerCase();
        if (!v) return '';
        if (v === 'united states' || v === 'united states of america' || v === 'usa' || v === 'us' || v === 'u.s.' ) return '';
        return c;
      };

      const formatCityLine = (a) => {
        const city = (a.city || '').trim();
        const state = (a.state || '').trim();
        const zip = (a.zip || '').trim();
        const c = countryShort(a.country);
        const left = [city, state].filter(Boolean).join(', ');
        const mid = [left, zip].filter(Boolean).join(' ');
        return [mid, c].filter(Boolean).join(', ');
      };

      const orderDateTime = formatOrderDateTime(order.date_created);
      const shippedDateOnly = formatShippedDateOnly(shipments, order);

      if (products.length === 0) {
        previewContent.innerHTML = '<div class="preview-loading">No items in this order</div>';
        return;
      }

      let html = `
        <div class="preview-grid">
          <div class="preview-address-box">
            <div class="preview-box-header">
              <h5>Billing</h5>
              <span style="font-size:14px; font-weight:700; color:#555;">Order #${order.id}</span>
            </div>
            <p>
              <strong>${billing.first_name || ''} ${billing.last_name || ''}</strong><br>
              ${billing.street_1 || ''}${billing.street_2 ? ', ' + billing.street_2 : ''}<br>
              ${formatCityLine(billing)}
            </p>
            <div class="contact contact-inline">
              <span class="contact-phone"><span class="field-label">Phone:</span> <span class="copyable">${billing.phone || 'N/A'}</span></span>
              <span class="contact-email"><span class="field-label">Email:</span> <span class="copyable">${billing.email || 'N/A'}</span></span>
            </div>
            <div class="meta-line"><span class="field-label">Order Date:</span> <span class="copyable">${orderDateTime}</span></div>
          </div>

          <div class="preview-address-box">
            <div class="preview-box-header">
              <h5>Shipping</h5>
              <button class="view-full-btn" onclick="viewOrder(${orderId})">View Full Order</button>
            </div>
            <p>
              <strong>${shipping.first_name || ''} ${shipping.last_name || ''}</strong><br>
              ${shipping.street_1 || ''}${shipping.street_2 ? ', ' + shipping.street_2 : ''}<br>
              ${formatCityLine(shipping)}
            </p>
            ${trackingHtml}
            <div class="meta-line"><span class="field-label">Shipped:</span> <span class="copyable">${shippedDateOnly}</span></div>
          </div>

          <div class="preview-items-box">
            <h5>Items (${products.length})</h5>
            <table class="preview-items-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Product</th>
                  <th class="qty">Qty</th>
                  <th class="price">Unit Price</th>
                  <th class="price">Total</th>
                </tr>
              </thead>
              <tbody>
      `;

      for (const p of products) {
        const qty = parseFloat(p.quantity || 0);
        const unit = parseFloat((p.price_ex_tax ?? p.base_price ?? 0) || 0);
        const lineTotal = parseFloat((p.total_ex_tax ?? (unit * qty)) || 0);

        html += `
                <tr>
                  <td class="sku">${p.sku || '-'}</td>
                  <td>${p.name}</td>
                  <td class="qty">${qty}</td>
                  <td class="price">$${unit.toFixed(2)}</td>
                  <td class="price">$${lineTotal.toFixed(2)}</td>
                </tr>
        `;
      }

      html += `
              </tbody>
            </table>
            <div class="preview-total">
              <div style="display: flex; justify-content: space-between;"><span>Subtotal:</span> <span>$${parseFloat(order.subtotal_ex_tax || 0).toFixed(2)}</span></div>
              ${parseFloat(order.coupon_discount || 0) > 0 ? `<div style="display:flex; justify-content: space-between;"><span class="coupon-label">Coupon${order.coupon_code ? ` (${order.coupon_code})` : ''}:</span> <span class="coupon-value">-$${Math.abs(parseFloat(order.coupon_discount || 0)).toFixed(2)}</span></div>` : ''}
              ${parseFloat(order.discount_amount || 0) > 0 && parseFloat(order.discount_amount) !== parseFloat(order.coupon_discount || 0) ? `<div style="display: flex; justify-content: space-between; color: #28a745;"><span>Discount:</span> <span>-$${parseFloat(order.discount_amount).toFixed(2)}</span></div>` : ''}
              <div style="display: flex; justify-content: space-between;"><span>Shipping:</span> <span>$${parseFloat(order.shipping_cost_ex_tax || 0).toFixed(2)}</span></div>
              <div style="display: flex; justify-content: space-between;"><span>Tax:</span> <span>$${parseFloat(order.total_tax || 0).toFixed(2)}</span></div>
              <div style="display: flex; justify-content: space-between; font-weight: bold; border-top: 1px solid #ccc; padding-top: 5px; margin-top: 5px;"><span>Total:</span> <span>$${parseFloat(order.total_inc_tax || 0).toFixed(2)}</span></div>
            </div>
          </div>
        </div>

        <div class="notes-section">
          <h5>Support Notes</h5>
          <div class="notes-list" id="preview-notes-${orderId}">
            ${renderNotesList(data.notes || [])}
          </div>
          <div class="note-form">
            <textarea class="note-textarea" id="preview-note-input-${orderId}"
              placeholder="Add a note about this order..."
              maxlength="500"
              oninput="updateCharCounter(this, 'preview-char-counter-${orderId}')"></textarea>
            <div class="note-form-footer">
              <span class="char-counter" id="preview-char-counter-${orderId}">0 / 500</span>
              <button class="add-note-btn" onclick="addNote(${orderId}, 'preview')">Add Note</button>
            </div>
          </div>
        </div>

      `;

      previewContent.innerHTML = html;
    }

    function renderNotesList(notes) {
      if (!notes || notes.length === 0) return '<div class="no-notes">No notes yet</div>';

      return notes.map(note => {
        const date = new Date(note.created_at).toLocaleString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric',
          hour: 'numeric', minute: '2-digit'
        });
        return `
          <div class="note-item">
            <div class="note-meta"><strong>${capitalize(note.username)}</strong> &middot; ${date}</div>
            <div class="note-text">${escapeHtml(note.note_text)}</div>
          </div>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateCharCounter(textarea, counterId) {
      const counter = document.getElementById(counterId);
      if (!counter) return;
      const length = textarea.value.length;
      counter.textContent = `${length} / 500`;
      counter.classList.toggle('warning', length > 450);
    }

    async function addNote(orderId, context) {
      const inputId = context === 'preview' ? `preview-note-input-${orderId}` : `modal-note-input-${orderId}`;
      const textarea = document.getElementById(inputId);
      const note = (textarea ? textarea.value.trim() : '');

      if (!note) {
        alert('Please enter a note');
        return;
      }

      const btn = textarea.parentElement.querySelector('.add-note-btn');
      btn.disabled = true;
      btn.textContent = 'Adding...';

      try {
        const response = await fetch(`/api/order/${currentStore}/${orderId}/notes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ note })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to add note');

        if (orderDetailsCache[orderId]) {
          if (!orderDetailsCache[orderId].notes) orderDetailsCache[orderId].notes = [];
          orderDetailsCache[orderId].notes.unshift(data.note);
        }

        const previewNotesList = document.getElementById(`preview-notes-${orderId}`);
        const notesHtml = renderNotesList(orderDetailsCache[orderId]?.notes || [data.note]);
        if (previewNotesList) previewNotesList.innerHTML = notesHtml;

        textarea.value = '';
        updateCharCounter(textarea, `preview-char-counter-${orderId}`);

      } catch (err) {
        alert(err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Add Note';
      }
    }

    function getStatusClass(status) {
      status = (status || '').toLowerCase();
      if (status.includes('complete')) return 'status-completed';
      if (status.includes('ship')) return 'status-shipped';
      if (status.includes('refund')) return 'status-refunded';
      return 'status-pending';
    }

    async function viewOrder(orderId) {
      const modal = document.getElementById('orderModal');
      const modalBody = document.getElementById('modalBody');

      document.getElementById('modalOrderId').textContent = orderId;
      modal.classList.add('active');

      if (orderDetailsCache[orderId]) {
        displayOrderDetail(orderDetailsCache[orderId]);
        return;
      }

      modalBody.innerHTML = '<div class="loading">Loading order details...</div>';

      try {
        const response = await fetch(`/api/order/${currentStore}/${orderId}`);
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Failed to load order');

        orderDetailsCache[orderId] = data;
        displayOrderDetail(data);

      } catch (err) {
        modalBody.innerHTML = `<div class="no-results" style="color: #dc3545; padding: 20px;">${err.message}</div>`;
      }
    }

    // View Full Order (Invoice-style, correct EX-TAX math, no notes)
    function displayOrderDetail(data) {
      const order = data.order || {};
      const products = data.products || [];
      const shippingAddresses = data.shippingAddresses || [];
      const shipments = data.shipments || [];

      const billing = order.billing_address || {};
      const shipping = shippingAddresses[0] || billing;

      const logoUrl = "https://cdn11.bigcommerce.com/s-9u5u1ss/content/banners/1ink-logo-trademark-invoice.png";

      const safe = (v) => (v == null ? '' : String(v));
      const fullName = (a) => `${safe(a.first_name)} ${safe(a.last_name)}`.trim();
      const money = (v) => `$${(parseFloat(v || 0)).toFixed(2)}`;

      const orderDate = order.date_created
        ? new Date(order.date_created).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'2-digit' })
        : 'N/A';

      // Correct totals (match preview and BC invoice style)
      const subtotal = parseFloat(order.subtotal_ex_tax || 0);
      const shippingCost = parseFloat(order.shipping_cost_ex_tax || 0);
      const tax = parseFloat(order.total_tax || 0);
      const grandTotal = parseFloat(order.total_inc_tax || 0);

      // Best-effort shipping method label
      const shippingMethod =
        (shipments[0] && (shipments[0].shipping_method || shipments[0].tracking_carrier)) ||
        order.shipping_method ||
        'Shipping';

      let rows = '';
      for (const p of products) {
        const qty = parseFloat(p.quantity || 0);

        const unit = parseFloat((p.price_ex_tax ?? p.base_price ?? 0));
        const lineTotal = parseFloat((p.total_ex_tax ?? (unit * qty)));

        rows += `
          <tr>
            <td class="sku">${safe(p.sku) || 'N/A'}</td>
            <td>${safe(p.name) || ''}</td>
            <td class="num">${qty || 0}</td>
            <td class="num">${money(unit)}</td>
            <td class="num">${money(lineTotal)}</td>
          </tr>
        `;
      }

      // Build tracking HTML for shipping box
      let trackingHtml = '';
      if (shipments && shipments.length) {
        trackingHtml = `<div style="margin-top:12px; padding-top:12px; border-top:1px solid #e6e6e6;">
          <strong>Tracking:</strong><br>
          ${shipments.map(sh => {
            const num = sh.tracking_number ? String(sh.tracking_number).trim() : '';
            if (!num) return 'No tracking';
            const url = getTrackingUrl(sh.tracking_carrier, num) || '';
            return url 
              ? `<a href="${url}" target="_blank" rel="noopener noreferrer" class="tracking-link">${num}</a>`
              : num;
          }).join('<br>')}
        </div>`;
      }

      const html = `
        <div class="invoice-wrap">
          <div class="invoice-top">
            <div class="invoice-brand">
              <img src="${logoUrl}" alt="1ink.com">
              <div class="addr">
                <div><strong>1ink.com</strong></div>
                <div>21200 Oxnard St. #969</div>
                <div>Woodland Hills, CA 91367-0969</div>
                <div>Tel: 1-818-534-2660</div>
              </div>
            </div>

            <div class="invoice-meta">
              <div class="inv-title">Invoice for Order #${safe(order.id)}</div>
              <div><strong>Payment Method:</strong> ${safe(order.payment_method) || 'N/A'} (${money(grandTotal)})</div>
              <div><strong>Order Date:</strong> ${orderDate}</div>
              <div><strong>Shipping Method:</strong> ${safe(shippingMethod)}</div>
              <div><strong>Status:</strong> ${safe(order.status) || 'N/A'}</div>
            </div>
          </div>

          <div class="invoice-two">
            <div class="invoice-box">
              <h4>Billing Details</h4>
              <p>
                <strong>${fullName(billing) || 'N/A'}</strong><br>
                ${safe(billing.street_1)}${billing.street_2 ? ' ' + safe(billing.street_2) : ''}<br>
                ${safe(billing.city)}, ${safe(billing.state)} ${safe(billing.zip)}<br>
                ${safe(billing.country)}<br><br>
                <strong>Email:</strong> ${safe(billing.email) || 'N/A'}<br>
                <strong>Phone:</strong> ${safe(billing.phone) || 'N/A'}
              </p>
            </div>

            <div class="invoice-box">
              <h4>Shipping Details</h4>
              <p>
                <strong>${fullName(shipping) || 'N/A'}</strong><br>
                ${safe(shipping.street_1)}${shipping.street_2 ? ' ' + safe(shipping.street_2) : ''}<br>
                ${safe(shipping.city)}, ${safe(shipping.state)} ${safe(shipping.zip)}<br>
                ${safe(shipping.country)}
              </p>
              ${trackingHtml}
            </div>
          </div>

          <table class="invoice-table">
            <thead>
              <tr>
                <th>Code/SKU</th>
                <th>Product Name</th>
                <th class="num">Qty</th>
                <th class="num">Price</th>
                <th class="num">Total</th>
              </tr>
            </thead>
            <tbody>
              ${rows || `<tr><td colspan="5">No items</td></tr>`}
            </tbody>
          </table>

          <div class="invoice-totals">
            <div class="row"><span>Subtotal:</span><span>${money(subtotal)}</span></div>
            <div class="row"><span>Shipping:</span><span>${money(shippingCost)}</span></div>
            <div class="row"><span>Tax:</span><span>${money(tax)}</span></div>
            <div class="row grand"><span><strong>Grand total:</strong></span><span><strong>${money(grandTotal)}</strong></span></div>
          </div>
        </div>
      `;

      document.getElementById('modalBody').innerHTML = html;
    }

    // Get tracking URL (USPS/UPS/FedEx/DHL) with pattern detection fallback
    function getTrackingUrl(carrier, number) {
      if (!number) return null;

      const carrierHint = String(carrier || '').toLowerCase();
      const n = String(number).trim().replace(/\s+/g, '');
      const digitsOnly = /^\d+$/.test(n);

      const looksUps = carrierHint.includes('ups') || /^1Z[0-9A-Z]{16}$/i.test(n);

      const looksUsps =
        carrierHint.includes('usps') ||
        /^(94|93|92|95)\d{18,20}$/.test(n) ||
        /^420\d{5,}\d+$/.test(n);

      const looksFedex =
        carrierHint.includes('fedex') ||
        (digitsOnly && (n.length === 12 || n.length === 15)) ||
        (digitsOnly && (n.length === 20 || n.length === 22) && !/^(94|93|92|95)/.test(n));

      const looksDhl = carrierHint.includes('dhl') || /^JD\d+/i.test(n);

      if (looksUps) return 'https://www.ups.com/track?tracknum=' + encodeURIComponent(n);
      if (looksUsps) return 'https://tools.usps.com/go/TrackConfirmAction?tLabels=' + encodeURIComponent(n);
      if (looksFedex) return 'https://www.fedex.com/fedextrack/?trknbr=' + encodeURIComponent(n);
      if (looksDhl) return 'https://www.dhl.com/en/express/tracking.html?AWB=' + encodeURIComponent(n);

      return null;
    }

    function closeModal() {
      document.getElementById('orderModal').classList.remove('active');
    }

    document.getElementById('orderModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = '/login';
    }

    checkAuth();
  </script>
</body>
</html>