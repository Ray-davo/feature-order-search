<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Search</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div class="app-shell">

  <!-- ═══════════════════════════════════════════════
       SIDEBAR
  ════════════════════════════════════════════════ -->
  <aside class="sidebar">

    <div class="sidebar-logo">
      <img src="https://cdn11.bigcommerce.com/s-9u5u1ss/content/banners/1ink-logo-trademark-invoice.png" alt="1ink.com">
      <div class="app-label">Order Support Portal</div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-label">Search</div>

      <button class="nav-item active">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
        </svg>
        Order Search
      </button>

      <button class="nav-item" id="bulkImportBtn" style="display:none;" onclick="openBulkImportModal()">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
        </svg>
        Bulk Tracking
      </button>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-section-label">Admin</div>

      <a href="/admin" class="nav-item" id="adminLink" style="display:none;">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
        </svg>
        Users & Roles
      </a>

    </div>

    <div class="sidebar-footer">
      <div class="sidebar-user">
        <div class="sidebar-avatar" id="userAvatar">?</div>
        <div class="sidebar-user-info">
          <div class="sidebar-username" id="username">Loading...</div>
          <div class="sidebar-role" id="userRole">Agent</div>
        </div>
      </div>
      <button class="sidebar-logout-link" onclick="logout()">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="flex-shrink:0;">
          <path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
        </svg>
        Sign out
      </button>
    </div>

  </aside>

  <!-- ═══════════════════════════════════════════════
       MAIN CONTENT
  ════════════════════════════════════════════════ -->
  <div class="main-content">

    <!-- Top Bar -->
    <div class="topbar">
      <span class="topbar-title">Order Search</span>
    </div>

    <!-- Page Content -->
    <div class="page-content">

      <!-- DB Stats -->
      <div class="db-stats-bar" id="dbStatsBar" style="display:none;">
        <span class="dot"></span>
        <span id="dbStats">Loading database stats...</span>
      </div>

      <!-- Search Box -->
      <div class="search-box">
        <div class="search-store-row">
          <label class="search-store-label">Store</label>
          <select id="store" class="search-store-select">
            <option value="1ink">1ink.com</option>
            <option value="needink">needink.com</option>
          </select>
        </div>
        <div class="search-row">
          <input type="text" id="searchQuery" placeholder="Search by order #, name, phone, or email…" onkeypress="if(event.key==='Enter')search()">
          <button onclick="search()" id="searchBtn">Search</button>
        </div>
      </div>

      <!-- Results -->
      <div class="results" id="results">
        <div class="no-results">Enter a search term above to find orders</div>
      </div>

    </div><!-- /page-content -->
  </div><!-- /main-content -->
</div><!-- /app-shell -->

  <!-- Order Detail Modal -->
  <div class="modal" id="orderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Order #<span id="modalOrderId"></span></h2>
        <button class="print-btn" onclick="printInvoice()">Print</button>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <div class="loading">Loading order details...</div>
      </div>
    </div>
  </div>

  <!-- Session Timeout Warning Modal -->
  <div class="session-warning" id="sessionWarning">
    <div class="session-warning-content">
      <div class="session-warning-icon">â°</div>
      <h3>Session Expiring Soon</h3>
      <p>Your session will expire due to inactivity.<br>Do you want to stay logged in?</p>
      <div class="countdown" id="sessionCountdown">2:00</div>
      <div class="session-warning-buttons">
        <button class="btn-stay" onclick="extendSession()">Stay Logged In</button>
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <script>
    let currentStore = '1ink';
    let currentUserPermissions = [];
    let expandedOrders = {};
    let orderDetailsCache = {};
    let currentOrders = [];
    let currentUser = '';
    let currentUserIsAdmin = false;

    // Session monitoring
    let sessionCheckInterval = null;
    let countdownInterval = null;
    let sessionWarningShown = false;

    function startSessionMonitor() {
      // Check session status every 30 seconds
      sessionCheckInterval = setInterval(checkSessionStatus, 30000);
    }

    async function checkSessionStatus() {
      try {
        const response = await fetch('/api/session-check');
        const data = await response.json();

        if (!data.valid) {
          // Session expired, redirect to login
          window.location.href = '/login';
          return;
        }

        if (data.showWarning && !sessionWarningShown) {
          showSessionWarning(data.remainingSec);
        }
      } catch (err) {
        console.error('Session check failed:', err);
      }
    }

    function showSessionWarning(remainingSec) {
      sessionWarningShown = true;
      const modal = document.getElementById('sessionWarning');
      const countdown = document.getElementById('sessionCountdown');
      
      modal.classList.add('show');
      
      let seconds = remainingSec;
      
      function updateCountdown() {
        const min = Math.floor(seconds / 60);
        const sec = seconds % 60;
        countdown.textContent = `${min}:${sec.toString().padStart(2, '0')}`;
        
        if (seconds <= 0) {
          clearInterval(countdownInterval);
          window.location.href = '/login';
          return;
        }
        seconds--;
      }
      
      updateCountdown();
      countdownInterval = setInterval(updateCountdown, 1000);
    }

    function hideSessionWarning() {
      sessionWarningShown = false;
      const modal = document.getElementById('sessionWarning');
      modal.classList.remove('show');
      
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }

    async function extendSession() {
      try {
        const response = await fetch('/api/session-extend', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          hideSessionWarning();
        }
      } catch (err) {
        console.error('Failed to extend session:', err);
      }
    }

    function capitalize(str) {
      return str ? (str.charAt(0).toUpperCase() + str.slice(1).toLowerCase()) : '';
    }

    async function checkAuth() {
      try {
        const response = await fetch('/api/auth-check');
        const data = await response.json();

        if (!data.authenticated) {
          window.location.href = '/login';
          return;
        }

        const displayName = capitalize(data.user);
        document.getElementById('username').textContent = displayName;
        const topbarEl = document.getElementById('topbarUsername');
        if (topbarEl) topbarEl.textContent = displayName;
        // Sidebar avatar initials
        const avatarEl = document.getElementById('userAvatar');
        if (avatarEl) avatarEl.textContent = displayName.charAt(0).toUpperCase();
        // Role label
        const roleEl = document.getElementById('userRole');
        if (roleEl) roleEl.textContent = data.isAdmin ? 'Administrator' : 'Agent';

        currentUser = data.user;
        currentUserIsAdmin = data.isAdmin || false;
        if (data.isAdmin) { const bar = document.getElementById('dbStatsBar'); if (bar) bar.style.display = 'flex'; }
        currentUserPermissions = data.permissions || [];
        if (data.isAdmin || (data.permissions && data.permissions.includes('admin.users.view'))) {
          document.getElementById('adminLink').style.display = 'flex';
        }
        if (data.permissions && data.permissions.includes('orders.tracking.add')) {
          document.getElementById('bulkImportBtn').style.display = 'flex';
        }
        
        loadDbStats();
        startSessionMonitor(); // Start monitoring session timeout
      } catch (err) {
        window.location.href = '/login';
      }
    }

    async function loadDbStats() {
      try {
        const response = await fetch('/api/db-stats');
        const stats = await response.json();

        const store = document.getElementById('store').value;
        const storeStats = stats[store];
        const el = document.getElementById('dbStats');
        if (!el) return;

        if (storeStats && storeStats.count > 0) {
          const oldest = new Date(storeStats.oldest).toLocaleDateString();
          const newest = new Date(storeStats.newest).toLocaleDateString();
          el.innerHTML = `<strong>${store}:</strong> ${storeStats.count.toLocaleString()} orders indexed (${oldest} to ${newest})`;
        } else {
          el.innerHTML = `<strong>${store}:</strong> No orders indexed yet. Run sync to populate.`;
        }
      } catch (err) {
        const el = document.getElementById('dbStats');
        if (el) el.textContent = '';
      }
    }

    document.getElementById('store').addEventListener('change', function() {
      currentStore = this.value;
      loadDbStats();
      expandedOrders = {};
      orderDetailsCache = {};
      currentOrders = [];
      document.getElementById('results').innerHTML = '<div class="no-results">Enter a search term above to find orders</div>';
    });

    function detectSearchType(query, store) {
      const trimmed = query.trim();

      if (trimmed.includes('@')) return { type: 'email', label: 'Email' };

      const digitsOnly = trimmed.replace(/\D/g, '');

      if (store === '1ink' && /^7\d{6}$/.test(digitsOnly)) return { type: 'order', label: 'Order #' };
      if (store === 'needink' && /^(89|90)\d{4}$/.test(digitsOnly)) return { type: 'order', label: 'Order #' };

      if (/^\d{10,11}$/.test(digitsOnly)) return { type: 'phone', label: 'Phone' };

      return { type: 'name', label: 'Name' };
    }

    async function search() {
      const store = document.getElementById('store').value;
      const query = document.getElementById('searchQuery').value.trim();

      if (!query) {
        alert('Please enter a search term');
        return;
      }

      const detected = detectSearchType(query, store);
      const searchType = detected.type;

      const btn = document.getElementById('searchBtn');
      const resultsDiv = document.getElementById('results');

      btn.disabled = true;
      btn.textContent = 'Searching...';
      resultsDiv.innerHTML = `<div class="loading">Searching by ${detected.label}...</div>`;

      expandedOrders = {};
      orderDetailsCache = {};

      try {
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ store, searchType, query })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Search failed');

        currentStore = store;
        displayResults(data.orders, detected.label);

      } catch (err) {
        resultsDiv.innerHTML = `<div class="no-results error">${err.message}</div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Search';
      }
    }

    function displayResults(orders, searchedBy) {
      const resultsDiv = document.getElementById('results');

      // Filter out Incomplete orders (abandoned checkouts - nothing for support to act on)
      orders = (orders || []).filter(o => (o.status || '').toLowerCase() !== 'incomplete');

      if (!orders || orders.length === 0) {
        resultsDiv.innerHTML = '<div class="no-results">No orders found</div>';
        return;
      }

      currentOrders = orders;

      const expandAllBtn = orders.length > 1
        ? `<button class="expand-all-btn" id="expandAllBtn" onclick="expandAllOrders()">Expand All</button>`
        : '';

      let html = `
        <div class="results-header">
          ${orders.length} order${orders.length !== 1 ? 's' : ''} found
          <span class="search-meta-label">&nbsp;· searched by ${searchedBy}</span>
          ${expandAllBtn}
        </div>
        <div class="order-col-headers">
          <div></div>
          <div>Order ID</div>
          <div>Customer</div>
          <div>Email</div>
          <div class="col-right">Date</div>
          <div class="col-right">Status</div>
          <div class="col-right">Total</div>
        </div>`;

      for (const order of orders) {
        const date = new Date(order.date_created).toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: '2-digit' });
        const statusClass = getStatusClass(order.status);
        const customerName = order.billing_address
          ? `${order.billing_address.first_name || ''} ${order.billing_address.last_name || ''}`.trim()
          : 'Guest';
        const customerEmail = order.billing_address?.email || '';

        html += `
          <div class="order-row" id="order-row-${order.id}" onclick="togglePreview(null, ${order.id})">
            <button class="expand-btn" onclick="togglePreview(event, ${order.id})" title="Preview items">+</button>
            <div class="order-col order-id">#${order.id}</div>
            <div class="order-col order-customer" title="${customerName}">${customerName}</div>
            <div class="order-col order-email" title="${customerEmail}"><span id="note-badge-${order.id}"></span>${customerEmail}</div>
            <div class="order-col order-date">${date}</div>
            <div class="order-col order-status ${statusClass}">${order.status}</div>
            <div class="order-col order-total">$${parseFloat(order.total_inc_tax || 0).toFixed(2)}</div>
          </div>
          <div class="preview-panel" id="preview-${order.id}">
            <div class="preview-content" id="preview-content-${order.id}">
              <div class="preview-loading">Loading items...</div>
            </div>
          </div>`;
      }

      resultsDiv.innerHTML = html;

      // Fetch note counts and show badges on any orders that have notes
      fetchNoteCounts(currentStore, orders.map(o => o.id));
    }

    async function fetchNoteCounts(store, orderIds) {
      if (!orderIds || orderIds.length === 0) return;
      try {
        const response = await fetch('/api/note-counts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ store, orderIds })
        });
        const data = await response.json();
        if (!response.ok || !data.counts) return;

        for (const [orderId, count] of Object.entries(data.counts)) {
          if (count > 0) {
            const badge = document.getElementById(`note-badge-${orderId}`);
            if (badge) {
              badge.innerHTML = `<span class="note-badge" title="${count} note${count > 1 ? 's' : ''} — click to view" onclick="event.stopPropagation(); openPreviewToNotes(${orderId})">Note${count > 1 ? ' ' + count : ''}</span>`;
            }
          }
        }
      } catch (err) {
        // Silent fail — badge is just a nice-to-have
        console.error('Note counts fetch failed:', err);
      }
    }

    // Update note badge after adding (+1) or deleting (-1) a note
    function updateNoteBadge(orderId, delta = 1) {
      const badge = document.getElementById(`note-badge-${orderId}`);
      if (!badge) return;

      const existing = badge.querySelector('.note-badge');
      if (existing) {
        const countText = existing.textContent.replace(/\D/g, '');
        const newCount = Math.max(0, (parseInt(countText) || 0) + delta);
        if (newCount === 0) {
          badge.innerHTML = '';
        } else {
          existing.title = `${newCount} note${newCount > 1 ? 's' : ''} — click to view`;
          existing.innerHTML = `Note${newCount > 1 ? ' ' + newCount : ''}`;
        }
      } else if (delta > 0) {
        badge.innerHTML = `<span class="note-badge" title="1 note — click to view" onclick="event.stopPropagation(); openPreviewToNotes(${orderId})">Note</span>`;
      }
    }

    // Open the preview panel and scroll to the notes section
    async function openPreviewToNotes(orderId) {
      const isExpanded = expandedOrders[orderId];
      if (!isExpanded) {
        await togglePreview(null, orderId);
      }
      // Small delay to let the panel render, then scroll to notes
      setTimeout(() => {
        const notesSection = document.querySelector(`#preview-content-${orderId} .notes-section`);
        if (notesSection) notesSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 200);
    }

    async function expandAllOrders() {
      const btn = document.getElementById('expandAllBtn');
      const allExpanded = currentOrders.every(o => expandedOrders[o.id]);

      if (allExpanded) {
        // Collapse all
        for (const order of currentOrders) {
          const previewPanel = document.getElementById(`preview-${order.id}`);
          const expandBtn = document.querySelector(`#order-row-${order.id} .expand-btn`);
          if (previewPanel) previewPanel.classList.remove('show');
          if (expandBtn) { expandBtn.classList.remove('expanded'); expandBtn.innerHTML = '+'; }
          delete expandedOrders[order.id];
        }
        if (btn) btn.textContent = 'Expand All';
      } else {
        // Expand all
        if (btn) { btn.textContent = 'Loading...'; btn.disabled = true; }

        for (const order of currentOrders) {
          const previewPanel = document.getElementById(`preview-${order.id}`);
          const expandBtn = document.querySelector(`#order-row-${order.id} .expand-btn`);
          const previewContent = document.getElementById(`preview-content-${order.id}`);

          if (!previewPanel) continue;

          previewPanel.classList.add('show');
          if (expandBtn) { expandBtn.classList.add('expanded'); expandBtn.innerHTML = '&minus;'; }
          expandedOrders[order.id] = true;

          if (!orderDetailsCache[order.id]) {
            try {
              const response = await fetch(`/api/order/${currentStore}/${order.id}`);
              const data = await response.json();
              if (response.ok) {
                orderDetailsCache[order.id] = data;
                renderPreviewItems(order.id, data);
              }
            } catch (err) {
              if (previewContent) previewContent.innerHTML = `<div class="preview-loading error">Failed to load</div>`;
            }
          } else {
            renderPreviewItems(order.id, orderDetailsCache[order.id]);
          }
        }

        if (btn) { btn.textContent = 'Collapse All'; btn.disabled = false; }
      }
    }

    async function togglePreview(event, orderId) {
      if (event) event.stopPropagation();

      const previewPanel = document.getElementById(`preview-${orderId}`);
      const expandBtn = document.querySelector(`#order-row-${orderId} .expand-btn`);
      const previewContent = document.getElementById(`preview-content-${orderId}`);

      if (expandedOrders[orderId]) {
        previewPanel.classList.remove('show');
        expandBtn.classList.remove('expanded');
        expandBtn.innerHTML = '+';
        delete expandedOrders[orderId];
      } else {
        previewPanel.classList.add('show');
        expandBtn.classList.add('expanded');
        expandBtn.innerHTML = '&minus;';
        expandedOrders[orderId] = true;

        if (!orderDetailsCache[orderId]) {
          previewContent.innerHTML = '<div class="preview-loading">Loading items...</div>';

          try {
            const response = await fetch(`/api/order/${currentStore}/${orderId}`);
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || 'Failed to load');

            orderDetailsCache[orderId] = data;
            renderPreviewItems(orderId, data);
          } catch (err) {
            previewContent.innerHTML = `<div class="preview-loading error">Failed to load items</div>`;
          }
        } else {
          renderPreviewItems(orderId, orderDetailsCache[orderId]);
        }
      }

      // Sync the Expand All button label
      const allBtn = document.getElementById('expandAllBtn');
      if (allBtn && currentOrders.length > 1) {
        const allExpanded = currentOrders.every(o => expandedOrders[o.id]);
        allBtn.textContent = allExpanded ? 'Collapse All' : 'Expand All';
      }
    }

    // Detect carrier label from a tracking number (fallback if BigCommerce doesn't provide tracking_carrier)
    function detectCarrierLabel(number, carrierHint) {
      const hint = String(carrierHint || '').toLowerCase();
      const n = String(number || '').trim().replace(/\s+/g, '');

      if (!n) return '';

      const isUps = hint.includes('ups') || /^1Z[0-9A-Z]{16}$/i.test(n);
      const isUsps =
        hint.includes('usps') ||
        /^(94|93|92|95)\d{18,20}$/.test(n) ||
        /^420\d{5,}\d+$/.test(n);
      const isFedex =
        hint.includes('fedex') ||
        (/^\d+$/.test(n) && (n.length === 12 || n.length === 15)) ||
        (/^\d+$/.test(n) && (n.length === 20 || n.length === 22) && !/^(94|93|92|95)/.test(n));
      const isDhl = hint.includes('dhl') || /^JD\d+/i.test(n);

      if (isUps) return 'UPS';
      if (isUsps) return 'USPS';
      if (isFedex) return 'FedEx';
      if (isDhl) return 'DHL';
      return '';
    }

    // Build tracking HTML with clickable links + carrier badge (UPS/USPS/FedEx/DHL)
    function buildTrackingHtml(shipments) {
      if (!shipments || shipments.length === 0) return '';

      const nums = shipments
        .map(s => (s && s.tracking_number != null) ? String(s.tracking_number).trim() : '')
        .map(n => n.replace(/\s+/g, ''))
        .filter(Boolean);

      if (nums.length === 0) return '';

      // Determine carrier(s)
      const carriers = shipments.map((s, idx) => detectCarrierLabel(nums[idx], s && s.tracking_carrier)).filter(Boolean);
      const unique = Array.from(new Set(carriers));
      const carrierLabel = unique.length === 0 ? '' : (unique.length === 1 ? unique[0] : 'Mixed');

      // Build links
      const links = shipments.map((s) => {
        const carrierHint = String(s.tracking_carrier || '').toLowerCase();
        const rawNum = s.tracking_number;
        const num = rawNum ? String(rawNum).trim().replace(/\s+/g, '') : '';
        if (!num) return '';

        const url =
          getTrackingUrl(carrierHint, num) ||
          ('https://www.fedex.com/fedextrack/?trknbr=' + encodeURIComponent(num));

        return '<a href="' + url + '" target="_blank" rel="noopener noreferrer" class="tracking-link">' + num + '</a>';
      }).filter(Boolean);

      if (links.length === 0) return '';

      const badge = carrierLabel ? ('<span class="carrier-badge">' + carrierLabel + '</span>') : '';

      return '<div class="tracking-inline">' +
        '<strong class="tracking-label">Tracking:</strong>' +
        badge +
        '<span class="tracking-numbers">' + links.join('<span class="tracking-sep">, </span>') + '</span>' +
      '</div>';
    }


    // Format Order Date with time + timezone (America/Los_Angeles)
    function formatOrderDateTime(iso) {
      if (!iso) return '&mdash;';
      try {
        return new Date(iso).toLocaleString('en-US', {
          month: 'short',
          day: '2-digit',
          year: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          timeZone: 'America/Los_Angeles',
          timeZoneName: 'short'
        }).replace(',', '');
      } catch (e) {
        return '&mdash;';
      }
    }

    // Format Shipped date as date-only (America/Los_Angeles)
    function formatShippedDateOnly(shipments, order) {
      const pick = (v) => v ? new Date(v) : null;
      let dt = null;

      // Prefer an explicit shipped date if present (varies by API shape)
      if (shipments && shipments.length) {
        const s0 = shipments[0] || {};
        dt = pick(s0.date_shipped) || pick(s0.shipped_at) || pick(s0.date_created) || pick(s0.created_at) || null;
      }
      if (!dt && order) {
        dt = pick(order.date_shipped) || pick(order.shipped_at) || null;
      }
      if (!dt) return '&mdash;';

      try {
        return dt.toLocaleDateString('en-US', {
          month: 'short',
          day: '2-digit',
          year: 'numeric',
          timeZone: 'America/Los_Angeles'
        }).replace(',', '');
      } catch (e) {
        return '&mdash;';
      }
    }

    function renderPreviewItems(orderId, data) {
      const previewContent = document.getElementById(`preview-content-${orderId}`);
      const products = data.products || [];
      const order = data.order || {};
      const shippingAddresses = data.shippingAddresses || [];
      const shipments = data.shipments || [];

      const billing = order.billing_address || {};
      const shipping = shippingAddresses[0] || billing;

      const trackingHtml = buildTrackingHtml(shipments);

      const countryShort = (c) => {
        const v = (c || '').toString().trim().toLowerCase();
        if (!v) return '';
        if (v === 'united states' || v === 'united states of america' || v === 'usa' || v === 'us' || v === 'u.s.' ) return '';
        return c;
      };

      const formatCityLine = (a) => {
        const city = (a.city || '').trim();
        const state = (a.state || '').trim();
        const zip = (a.zip || '').trim();
        const c = countryShort(a.country);
        const left = [city, state].filter(Boolean).join(', ');
        const mid = [left, zip].filter(Boolean).join(' ');
        return [mid, c].filter(Boolean).join(', ');
      };

      const orderDateTime = formatOrderDateTime(order.date_created);
      const shippedDateOnly = formatShippedDateOnly(shipments, order);

      if (products.length === 0) {
        previewContent.innerHTML = '<div class="preview-loading">No items in this order</div>';
        return;
      }

      let html = `
        <div class="preview-grid">
          <div class="preview-address-box">
            <div class="preview-box-header">
              <h5>Billing</h5>
              <span style="display:flex;align-items:center;gap:8px;">
                <span class="order-ref-label">Order #${order.id}</span>
                ${currentUserPermissions.includes('orders.address.edit') ? `<button class="view-full-btn" onclick='openEditAddress("billing",${orderId},"${store}",0,${JSON.stringify(billing)})'>&#9998; Edit</button>` : ''}
              </span>
            </div>
            <p>
              <strong>${billing.first_name || ''} ${billing.last_name || ''}</strong><br>
              ${billing.street_1 || ''}${billing.street_2 ? ', ' + billing.street_2 : ''}<br>
              ${formatCityLine(billing)}
            </p>
            <div class="contact contact-inline">
              <span class="contact-phone"><span class="field-label">Phone:</span> <span class="copyable">${billing.phone || 'N/A'}</span></span>
              <span class="contact-email"><span class="field-label">Email:</span> <span class="copyable">${billing.email || 'N/A'}</span></span>
            </div>
            <div class="meta-line"><span class="field-label">Order Date:</span> <span class="copyable">${orderDateTime}</span></div>
          </div>

          <div class="preview-address-box">
            <div class="preview-box-header">
              <h5>Shipping</h5>
              <span style="display:flex;align-items:center;gap:8px;">
                ${currentUserPermissions.includes('orders.address.edit') ? `<button class="view-full-btn" onclick='openEditAddress("shipping",${orderId},"${store}",${shippingAddresses[0]?.id||0},${JSON.stringify(shipping)})'>&#9998; Edit</button>` : ''}
                <button class="view-full-btn" onclick="viewOrder(${orderId})">View Full Order</button>
              </span>
            </div>
            <p>
              <strong>${shipping.first_name || ''} ${shipping.last_name || ''}</strong><br>
              ${shipping.street_1 || ''}${shipping.street_2 ? ', ' + shipping.street_2 : ''}<br>
              ${formatCityLine(shipping)}
            </p>
            ${trackingHtml}
            <div class="meta-line"><span class="field-label">Shipped:</span> <span class="copyable">${shippedDateOnly}</span></div>
          </div>

          <div class="preview-items-box">
            <h5>Items (${products.length})</h5>
            <table class="preview-items-table">
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>Product</th>
                  <th class="qty">Qty</th>
                  <th class="price">Unit Price</th>
                  <th class="price">Total</th>
                </tr>
              </thead>
              <tbody>
      `;

      for (const p of products) {
        const qty = parseFloat(p.quantity || 0);
        const unit = parseFloat((p.price_ex_tax ?? p.base_price ?? 0) || 0);
        const lineTotal = parseFloat((p.total_ex_tax ?? (unit * qty)) || 0);

        html += `
                <tr>
                  <td class="sku">${p.sku || '-'}</td>
                  <td>${p.product_url ? `<a href="${p.product_url}" target="_blank" rel="noopener noreferrer" class="product-link">${p.name}</a>` : p.name}</td>
                  <td class="qty">${qty}</td>
                  <td class="price">$${unit.toFixed(2)}</td>
                  <td class="price">$${lineTotal.toFixed(2)}</td>
                </tr>
        `;
      }

      html += `
              </tbody>
            </table>
            <div class="preview-total">
              <div class="preview-total-row"><span>Subtotal:</span> <span>$${parseFloat(order.subtotal_ex_tax || 0).toFixed(2)}</span></div>
              ${parseFloat(order.coupon_discount || 0) > 0 ? `<div class="preview-total-row"><span class="coupon-label">Coupon${order.coupon_code ? ` (${order.coupon_code})` : ''}:</span> <span class="coupon-value">-$${Math.abs(parseFloat(order.coupon_discount || 0)).toFixed(2)}</span></div>` : ''}
              ${parseFloat(order.discount_amount || 0) > 0 && parseFloat(order.discount_amount) !== parseFloat(order.coupon_discount || 0) ? `<div class="preview-total-row discount"><span>Discount:</span> <span>-$${parseFloat(order.discount_amount).toFixed(2)}</span></div>` : ''}
              <div class="preview-total-row"><span>Shipping:</span> <span>$${parseFloat(order.shipping_cost_ex_tax || 0).toFixed(2)}</span></div>
              <div class="preview-total-row"><span>Tax:</span> <span>$${parseFloat(order.total_tax || 0).toFixed(2)}</span></div>
              <div class="preview-total-row preview-grand-total"><span>Total:</span> <span>$${parseFloat(order.total_inc_tax || 0).toFixed(2)}</span></div>
              ${parseFloat(order.refunded_amount || 0) > 0 ? `<div class="preview-total-row" style="color:var(--color-danger);font-weight:700;border-top:1px solid var(--color-danger-border);padding-top:6px;margin-top:4px;"><span>Refunded:</span> <span>-$${parseFloat(order.refunded_amount).toFixed(2)}</span></div>` : ''}
            </div>
          </div>
        </div>

        <div class="email-actions">
          <button class="email-action-btn email-btn-confirmation" id="btn-confirm-${orderId}" onclick="resendEmail(${orderId}, 'confirmation')">
            &#9993; Resend Order Confirmation
          </button>
          ${shipments.length > 0 ? `
          <button class="email-action-btn email-btn-tracking" id="btn-tracking-${orderId}" onclick="resendEmail(${orderId}, 'tracking')">
            &#128230; Resend Tracking Email
          </button>` : ''}
        </div>

        <div class="email-log-section" id="email-log-section-${orderId}" style="display:none;">
          <h5>&#9993; Emails Sent</h5>
          <div id="email-log-list-${orderId}"><span class="no-emails">No emails sent yet</span></div>
        </div>

        <div class="notes-section">
          <h5>Support Notes</h5>
          <div class="notes-list" id="preview-notes-${orderId}">
            ${renderNotesList(data.notes || [], orderId)}
          </div>
          <div class="note-form">
            <textarea class="note-textarea" id="preview-note-input-${orderId}"
              placeholder="Add a note about this order..."
              maxlength="500"
              oninput="updateCharCounter(this, 'preview-char-counter-${orderId}')"></textarea>
            <div class="note-form-footer">
              <span class="char-counter" id="preview-char-counter-${orderId}">0 / 500</span>
              <button class="add-note-btn" onclick="addNote(${orderId}, 'preview')">Add Note</button>
            </div>
          </div>
        </div>

      `;

      previewContent.innerHTML = html;
      injectOrderActionsBar(orderId, order, data);
    }

    function renderNotesList(notes, orderId) {
      if (!notes || notes.length === 0) return '<div class="no-notes">No notes yet</div>';

      const DELETE_WINDOW_MS = 15 * 60 * 1000; // 15 minutes

      return notes.map(note => {
        const date = new Date(note.created_at).toLocaleString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric',
          hour: 'numeric', minute: '2-digit'
        });

        const noteAge = Date.now() - new Date(note.created_at).getTime();
        const withinWindow = noteAge <= DELETE_WINDOW_MS;
        const canDelete = (currentUserIsAdmin || note.username === currentUser) &&
                          (currentUserIsAdmin || withinWindow);

        const trashIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>`;

        const deleteBtn = canDelete
          ? `<button class="note-delete-btn" title="Delete note (within 15 min)" onclick="deleteNote(${orderId}, ${note.id}, this)">${trashIcon}</button>`
          : '';

        return `
          <div class="note-item" id="note-item-${note.id}">
            <div class="note-item-body">
              <div class="note-meta"><strong>${capitalize(note.username)}</strong> &middot; ${date}</div>
              <div class="note-text">${escapeHtml(note.note_text)}</div>
            </div>
            ${deleteBtn}
          </div>
        `;
      }).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateCharCounter(textarea, counterId) {
      const counter = document.getElementById(counterId);
      if (!counter) return;
      const length = textarea.value.length;
      counter.textContent = `${length} / 500`;
      counter.classList.toggle('warning', length > 450);
    }

    async function addNote(orderId, context) {
      const inputId = context === 'preview' ? `preview-note-input-${orderId}` : `modal-note-input-${orderId}`;
      const textarea = document.getElementById(inputId);
      const note = (textarea ? textarea.value.trim() : '');

      if (!note) {
        alert('Please enter a note');
        return;
      }

      const btn = textarea.parentElement.querySelector('.add-note-btn');
      btn.disabled = true;
      btn.textContent = 'Adding...';

      try {
        const response = await fetch(`/api/order/${currentStore}/${orderId}/notes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ note })
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to add note');

        if (orderDetailsCache[orderId]) {
          if (!orderDetailsCache[orderId].notes) orderDetailsCache[orderId].notes = [];
          orderDetailsCache[orderId].notes.unshift(data.note);
        }

        const previewNotesList = document.getElementById(`preview-notes-${orderId}`);
        const notesHtml = renderNotesList(orderDetailsCache[orderId]?.notes || [data.note], orderId);
        if (previewNotesList) previewNotesList.innerHTML = notesHtml;

        textarea.value = '';
        updateCharCounter(textarea, `preview-char-counter-${orderId}`);
        updateNoteBadge(orderId);

      } catch (err) {
        alert(err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Add Note';
      }
    }

    async function deleteNote(orderId, noteId, btnEl) {
      if (!confirm('Delete this note? This cannot be undone.')) return;

      btnEl.disabled = true;

      try {
        const response = await fetch(`/api/order/${currentStore}/${orderId}/notes/${noteId}`, {
          method: 'DELETE'
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to delete note');

        // Remove from cache
        if (orderDetailsCache[orderId]?.notes) {
          orderDetailsCache[orderId].notes = orderDetailsCache[orderId].notes.filter(n => n.id !== noteId);
        }

        // Remove from DOM
        const noteEl = document.getElementById(`note-item-${noteId}`);
        if (noteEl) noteEl.remove();

        // If no notes left, show empty state
        const notesList = document.getElementById(`preview-notes-${orderId}`);
        if (notesList && notesList.children.length === 0) {
          notesList.innerHTML = '<div class="no-notes">No notes yet</div>';
        }

        // Update badge
        if (orderDetailsCache[orderId]?.notes?.length === 0) {
          const badge = document.getElementById(`note-badge-${orderId}`);
          if (badge) badge.innerHTML = '';
        } else {
          updateNoteBadge(orderId, -1);
        }

      } catch (err) {
        alert(err.message);
        btnEl.disabled = false;
      }
    }

    function getStatusClass(status) {
      status = (status || '').toLowerCase();
      if (status.includes('complete')) return 'status-completed';
      if (status.includes('ship')) return 'status-shipped';
      if (status.includes('refund')) return 'status-refunded';
      return 'status-pending';
    }

    async function viewOrder(orderId) {
      const modal = document.getElementById('orderModal');
      const modalBody = document.getElementById('modalBody');

      document.getElementById('modalOrderId').textContent = orderId;
      modal.classList.add('active');

      if (orderDetailsCache[orderId]) {
        displayOrderDetail(orderDetailsCache[orderId]);
        return;
      }

      modalBody.innerHTML = '<div class="loading">Loading order details...</div>';

      try {
        const response = await fetch(`/api/order/${currentStore}/${orderId}`);
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Failed to load order');

        orderDetailsCache[orderId] = data;
        displayOrderDetail(data);

      } catch (err) {
        modalBody.innerHTML = `<div class="no-results error">${err.message}</div>`;
      }
    }

    // View Full Order — mirrors BC PrintableInvoice.html structure
    function displayOrderDetail(data) {
      const order = data.order || {};
      const products = data.products || [];
      const shippingAddresses = data.shippingAddresses || [];
      const shipments = data.shipments || [];

      const billing = order.billing_address || {};
      const shipping = shippingAddresses[0] || billing;

      const logoUrl = "https://cdn11.bigcommerce.com/s-9u5u1ss/content/banners/1ink-logo-trademark-invoice.png";

      const safe = (v) => (v == null ? '' : String(v));
      const fullName = (a) => `${safe(a.first_name)} ${safe(a.last_name)}`.trim();
      const money = (v) => `$${(parseFloat(v || 0)).toFixed(2)}`;
      const hideUS = (c) => {
        const v = (c || '').toLowerCase().trim();
        return (v === 'united states' || v === 'united states of america' || v === 'usa' || v === 'us') ? '' : c;
      };
      const addrLines = (a) => [
        `<strong>${fullName(a)}</strong>`,
        safe(a.company),
        safe(a.street_1),
        a.street_2 ? safe(a.street_2) : '',
        [safe(a.city), safe(a.state), safe(a.zip)].filter(Boolean).join(', '),
        hideUS(safe(a.country))
      ].filter(Boolean).join('<br>');

      const orderDate = order.date_created
        ? new Date(order.date_created).toLocaleDateString('en-US', { year:'numeric', month:'short', day:'2-digit' })
        : 'N/A';

      const subtotal     = parseFloat(order.subtotal_ex_tax || 0);
      const shippingCost = parseFloat(order.shipping_cost_ex_tax || 0);
      const tax          = parseFloat(order.total_tax || 0);
      const coupon       = parseFloat(order.coupon_discount || 0);
      const storeCredit  = parseFloat(order.store_credit_amount || 0);
      const grandTotal   = parseFloat(order.total_inc_tax || 0);

      // Try to get actual carrier name from tracking number detection
      const detectedCarrier = shipments[0]
        ? detectCarrierLabel(shipments[0].tracking_number, shipments[0].tracking_carrier)
        : '';
      const rawShippingMethod = (shipments[0] && (shipments[0].shipping_method || shipments[0].tracking_carrier)) || order.shipping_method || '';
      // Prefer detected carrier (e.g. "UPS", "USPS", "FedEx") over generic "Shipping" label
      const shippingMethod = detectedCarrier || (rawShippingMethod && rawShippingMethod.toLowerCase() !== 'shipping' ? rawShippingMethod : '') || 'Shipping';

      // Product rows (BC: SKU 22%, Name 50%, Qty 4%, Price 12%, Total 12%)
      let productRows = '';
      for (const p of products) {
        const qty = parseFloat(p.quantity || 0);
        const unit = parseFloat(p.price_ex_tax ?? p.base_price ?? 0);
        const lineTotal = parseFloat(p.total_ex_tax ?? (unit * qty));
        const nameHtml = p.product_url
          ? `<a href="${safe(p.product_url)}" target="_blank" rel="noopener noreferrer" class="product-link">${safe(p.name)}</a>`
          : safe(p.name);
        productRows += `<tr>
          <td class="sku" width="22%">${safe(p.sku) || 'N/A'}</td>
          <td width="50%">${nameHtml}</td>
          <td class="num" width="4%">${qty}</td>
          <td class="num" width="12%">${money(unit)}</td>
          <td class="num" width="12%">${money(lineTotal)}</td>
        </tr>`;
      }

      // Totals rows — second <tbody> spanning columns like BC's InvoiceTotals
      // Span first 3 cols, label col, value col
      const tRow = (label, value, cls = '') => `<tr class="totals-row ${cls}">
        <td colspan="3"></td>
        <td class="t-label">${label}</td>
        <td class="t-value">${value}</td>
      </tr>`;

      let totalsRows = tRow('Subtotal:', money(subtotal));
      totalsRows += tRow('Shipping:', money(shippingCost));
      if (coupon > 0) totalsRows += tRow(`Coupon${order.coupon_code ? ` (${order.coupon_code})` : ''}:`, `-${money(coupon)}`, 'coupon-row');
      totalsRows += tRow('Tax:', money(tax));
      if (storeCredit > 0) totalsRows += tRow('Store credit:', `-${money(storeCredit)}`, 'credit-row');
      totalsRows += `<tr class="grand-row">
        <td colspan="3"></td>
        <td class="t-label">Grand total:</td>
        <td class="t-value">${money(grandTotal)}</td>
      </tr>`;
      const refundedAmt = parseFloat(order.refunded_amount || 0);
      if (refundedAmt > 0) {
        totalsRows += `<tr class="totals-row" style="color:#B91C1C;font-weight:600;">
          <td colspan="3"></td>
          <td class="t-label">Refunded:</td>
          <td class="t-value">-${money(refundedAmt)}</td>
        </tr>`;
      }

      // Tracking
      let trackingHtml = '';
      if (shipments && shipments.length) {
        const links = shipments.map(sh => {
          const num = sh.tracking_number ? String(sh.tracking_number).trim() : '';
          if (!num) return '';
          const url = getTrackingUrl(sh.tracking_carrier, num) || '';
          return url ? `<a href="${url}" target="_blank" rel="noopener noreferrer" class="tracking-link">${num}</a>` : num;
        }).filter(Boolean).join(', ');
        if (links) trackingHtml = `<br><strong>Tracking:</strong> ${links}`;
      }

      const html = `
        <div class="invoice-wrap">

          <!-- Store address floats right 33% — then logo (BC structure) -->
          <div class="invoice-store-addr">
            1ink.com<br>
            21200 Oxnard St. #969<br>
            Woodland Hills, CA 91367-0969<br>
            Tel: 1-818-534-2660
          </div>
          <div class="invoice-logo-wrap">
            <img src="${logoUrl}" alt="1ink.com">
          </div>

          <!-- Title clears the float -->
          <div class="invoice-title">1ink.com invoice for order #${safe(order.id)}</div>

          <!-- Bill To / Ship To — plain text, no boxes -->
          <div class="invoice-addr-row">
            <div class="invoice-addr-col">
              <div class="invoice-addr-heading">Billing Details</div>
              ${addrLines(billing)}
              ${billing.email ? `<br><strong>Email:</strong> ${safe(billing.email)}` : ''}
              ${billing.phone ? `<br><strong>Phone:</strong> ${safe(billing.phone)}` : ''}
            </div>
            <div class="invoice-addr-col">
              <div class="invoice-addr-heading">Shipping Details</div>
              ${addrLines(shipping)}
              ${trackingHtml}
            </div>
          </div>

          <!-- Order details: 2-col grid with border lines (BC: InvoiceDetails) -->
          <div class="invoice-details">
            <div class="invoice-details-col">
              <div class="invoice-detail-row">
                <span class="invoice-detail-label">Order:</span>
                <span class="invoice-detail-value">#${safe(order.id)}</span>
              </div>
              <div class="invoice-detail-row">
                <span class="invoice-detail-label">Payment Method:</span>
                <span class="invoice-detail-value">${safe(order.payment_method) || 'N/A'}</span>
              </div>
            </div>
            <div class="invoice-details-col">
              <div class="invoice-detail-row">
                <span class="invoice-detail-label">Order Date:</span>
                <span class="invoice-detail-value">${orderDate}</span>
              </div>
              <div class="invoice-detail-row">
                <span class="invoice-detail-label">Shipping Method:</span>
                <span class="invoice-detail-value">${safe(shippingMethod)}</span>
              </div>
            </div>
          </div>

          <!-- Order Items heading -->
          <div class="invoice-items-heading">Order Items</div>

          <!-- Table: products in first tbody, totals in second tbody (BC: InvoiceTotals) -->
          <table class="invoice-table">
            <thead>
              <tr>
                <th width="22%">Code/SKU</th>
                <th width="50%">Product Name</th>
                <th class="num" width="4%">Qty</th>
                <th class="num" width="12%">Price</th>
                <th class="num" width="12%">Total</th>
              </tr>
            </thead>
            <tbody>
              ${productRows || '<tr><td colspan="5">No items</td></tr>'}
            </tbody>
            <tbody>
              ${totalsRows}
            </tbody>
          </table>

        </div>
      `;

      document.getElementById('modalBody').innerHTML = html;
    }

    // Get tracking URL (USPS/UPS/FedEx/DHL) with pattern detection fallback
    function getTrackingUrl(carrier, number) {
      if (!number) return null;

      const carrierHint = String(carrier || '').toLowerCase();
      const n = String(number).trim().replace(/\s+/g, '');
      const digitsOnly = /^\d+$/.test(n);

      const looksUps = carrierHint.includes('ups') || /^1Z[0-9A-Z]{16}$/i.test(n);

      const looksUsps =
        carrierHint.includes('usps') ||
        /^(94|93|92|95)\d{18,20}$/.test(n) ||
        /^420\d{5,}\d+$/.test(n);

      const looksFedex =
        carrierHint.includes('fedex') ||
        (digitsOnly && (n.length === 12 || n.length === 15)) ||
        (digitsOnly && (n.length === 20 || n.length === 22) && !/^(94|93|92|95)/.test(n));

      const looksDhl = carrierHint.includes('dhl') || /^JD\d+/i.test(n);

      if (looksUps) return 'https://www.ups.com/track?tracknum=' + encodeURIComponent(n);
      if (looksUsps) return 'https://tools.usps.com/go/TrackConfirmAction?tLabels=' + encodeURIComponent(n);
      if (looksFedex) return 'https://www.fedex.com/fedextrack/?trknbr=' + encodeURIComponent(n);
      if (looksDhl) return 'https://www.dhl.com/en/express/tracking.html?AWB=' + encodeURIComponent(n);

      return null;
    }

    function closeModal() {
      document.getElementById('orderModal').classList.remove('active');
    }

    document.getElementById('orderModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });


    const CSS_INVOICE_CSS = "/* Invoice layout — mirrors BC PrintableInvoice.html structure exactly */\n    .invoice-wrap { background:#fff; padding:24px; font-size:16px; color:#222; line-height:1.6; }\n    .invoice-store-addr { float:right; width:33%; font-size:16px; color:#333; line-height:1.8; text-align:right; }\n    .invoice-logo-wrap { height:56px; overflow:hidden; }\n    .invoice-logo-wrap img { height:46px; width:auto; display:block; }\n    .invoice-title { clear:both; font-size:20px; font-weight:700; margin:14px 0 14px 0; color:#222; }\n    .invoice-addr-row { display:flex; gap:0; margin-bottom:16px; }\n    .invoice-addr-col { flex:1; padding-right:24px; font-size:16px; line-height:1.4; }\n    .invoice-addr-col:last-child { padding-right:0; }\n    .invoice-addr-heading { font-weight:700; font-size:18px; margin-bottom:8px; color:#222; border-bottom:1px solid #ccc; padding-bottom:5px; }\n    .invoice-details { display:flex; margin-bottom:14px; border-top:1px solid #ccc; border-bottom:1px solid #ccc; padding:8px 0; }\n    .invoice-details-col { flex:1; }\n    .invoice-detail-row { display:flex; gap:10px; font-size:16px; padding:4px 0; }\n    .invoice-detail-label { font-weight:700; color:#222; white-space:nowrap; }\n    .invoice-detail-value { color:#444; }\n    .invoice-items-heading { font-weight:700; font-size:18px; margin:12px 0 6px 0; }\n    .invoice-table { width:100%; border-collapse:collapse; font-size:16px; }\n    .invoice-table th { text-align:left; border-top:1px solid #ccc; border-bottom:1px solid #ccc; padding:10px 8px; font-size:15px; font-weight:700; color:#222; }\n    .invoice-table th.num { text-align:right; }\n    .invoice-table td { border-bottom:1px solid #eee; padding:11px 8px; vertical-align:top; }\n    .invoice-table .num { text-align:right; white-space:nowrap; }\n    .invoice-table .sku { font-weight:normal; color:#222; word-break:break-word; overflow-wrap:anywhere; }\n    .invoice-table .totals-row td { border-bottom:1px solid #eee; padding:6px 8px; font-size:16px; }\n    .invoice-table .totals-row td.t-label { text-align:right; color:#555; padding-right:12px; }\n    .invoice-table .totals-row td.t-value { text-align:right; white-space:nowrap; width:120px; }\n    .invoice-table .grand-row td { border-top:2px solid #999; border-bottom:none; font-weight:600; font-size:16px; padding-top:9px; white-space:nowrap; }\n    .invoice-table .grand-row td.t-label { text-align:right; color:#222; padding-right:12px; }\n    .invoice-table .grand-row td.t-value { text-align:right; white-space:nowrap; }\n    .product-link { color:#007bff; text-decoration:underline; }\n    .product-link:hover { color:#0056b3; }\n    .tracking-link { color:#007bff; text-decoration:none; font-weight:600; }\n    .tracking-link:hover { text-decoration:underline; }\n\n    @media print {\n  @page { margin:0.5in; size:letter; }\n  html { zoom:1 !important; -webkit-text-size-adjust:100% !important; text-size-adjust:100% !important; }\n  html, body { font-size:12pt !important; line-height:1.6 !important; background:#fff !important; -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; width:100% !important; height:auto !important; margin:0 !important; padding:0 !important; }\n  .invoice-wrap { max-width:7.5in !important; width:100% !important; margin:0 !important; padding:0 !important; font-size:12pt !important; line-height:1.6 !important; color:#000 !important; }\n  .invoice-store-addr { font-size:11pt !important; line-height:1.6 !important; width:33% !important; }\n  .invoice-logo-wrap { height:auto !important; }\n  .invoice-logo-wrap img { height:32pt !important; width:auto !important; max-width:140pt !important; object-fit:contain !important; display:block !important; }\n  .invoice-title { font-size:15pt !important; margin:8pt 0 8pt 0 !important; }\n  .invoice-addr-heading { font-size:13pt !important; margin-bottom:4pt !important; padding-bottom:3pt !important; }\n  .invoice-items-heading { font-size:13pt !important; margin:6pt 0 4pt 0 !important; }\n  .invoice-addr-row { margin-bottom:8pt !important; }\n  .invoice-addr-col { font-size:12pt !important; line-height:1.5 !important; padding-right:16pt !important; }\n  .invoice-details { padding:5pt 0 !important; margin-bottom:8pt !important; }\n  .invoice-detail-row { font-size:11pt !important; padding:2pt 0 !important; }\n  .invoice-table { font-size:11pt !important; }\n  .invoice-table th { font-size:10pt !important; padding:5pt 5pt !important; }\n  .invoice-table td { font-size:11pt !important; padding:5pt 5pt !important; }\n  .invoice-table .totals-row td { font-size:11pt !important; padding:4pt 5pt !important; }\n  .invoice-table .grand-row td { font-size:12pt !important; padding-top:5pt !important; white-space:nowrap !important; }\n  .product-link { color:#000 !important; text-decoration:none !important; }\n  * { -webkit-print-color-adjust:exact !important; print-color-adjust:exact !important; }\n  .session-warning { display:none !important; }\n}\n      ";

    // Print Invoice (opens a clean invoice-only window like BigCommerce does)
    function printInvoice() {
      const modalBody = document.getElementById('modalBody');
      const invoiceEl = modalBody ? modalBody.querySelector('.invoice-wrap') : null;

      // Fallback: if invoice isn't rendered yet, print current page view
      if (!invoiceEl) {
        window.print();
        return;
      }

      const win = window.open('', '_blank');
      if (!win) {
        // Pop-up blocked
        window.print();
        return;
      }

      const css = CSS_INVOICE_CSS;

      const docHtml = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; background: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
  </style>
  <style>${css}</style>
</head>
<body>
  ${invoiceEl.outerHTML}
</body>
</html>`;

      win.document.open();
      win.document.write(docHtml);
      win.document.close();
      win.focus();

      // Wait for images (logo) to load so the printout is consistent
      const imgs = Array.from(win.document.images || []);
      let pending = imgs.length;

      const doPrint = () => {
        try { win.print(); } catch (e) {}
      };

      if (!pending) {
        setTimeout(doPrint, 50);
        return;
      }

      const t = setTimeout(doPrint, 800);
      imgs.forEach(img => {
        if (img.complete) {
          pending -= 1;
          if (pending <= 0) {
            clearTimeout(t);
            setTimeout(doPrint, 50);
          }
          return;
        }
        img.onload = img.onerror = () => {
          pending -= 1;
          if (pending <= 0) {
            clearTimeout(t);
            setTimeout(doPrint, 50);
          }
        };
      });
    }



    // ==================== EMAIL ACTIONS ====================

    async function resendEmail(orderId, type) {
      const btnId = type === 'confirmation' ? `btn-confirm-${orderId}` : `btn-tracking-${orderId}`;
      const btn = document.getElementById(btnId);
      const label = type === 'confirmation' ? 'Order Confirmation' : 'Tracking Email';

      if (!confirm(`Resend the ${label} for Order #${orderId} to the customer?`)) return;

      if (btn) { btn.disabled = true; btn.textContent = 'Sending...'; }

      try {
        const response = await fetch(`/api/order/${currentStore}/${orderId}/resend-${type}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Failed to send');

        alert(`${label} sent successfully to ${data.sentTo}`);
        loadEmailLog(orderId); // Refresh the log
      } catch (err) {
        alert(`Failed to send: ${err.message}`);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = type === 'confirmation'
            ? '&#9993; Resend Order Confirmation'
            : '&#128230; Resend Tracking Email';
        }
      }
    }

    async function loadEmailLog(orderId) {
      try {
        const response = await fetch(`/api/order/${currentStore}/${orderId}/email-log`);
        const data = await response.json();
        if (!response.ok || !data.emails) return;

        const section = document.getElementById(`email-log-section-${orderId}`);
        const list = document.getElementById(`email-log-list-${orderId}`);
        if (!section || !list) return;

        if (data.emails.length === 0) {
          section.style.display = 'none';
          return;
        }

        section.style.display = 'block';
        list.innerHTML = data.emails.map(e => {
          const date = new Date(e.sent_at).toLocaleString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric',
            hour: 'numeric', minute: '2-digit'
          });
          const typeLabel = e.email_type === 'confirmation' ? '&#9993; Confirmation' : '&#128230; Tracking';
          const statusClass = e.status === 'sent' ? 'email-log-status-sent' : 'email-log-status-failed';
          return `
            <div class="email-log-item">
              <div>
                <span class="email-log-type">${typeLabel}</span>
                <span class="email-log-meta"> &middot; to ${escapeHtml(e.sent_to)} &middot; by ${capitalize(e.sent_by)}</span>
              </div>
              <div>
                <span class="${statusClass}">${e.status === 'sent' ? '&#10003; Sent' : '&#10007; Failed'}</span>
                <span class="email-log-meta"> &middot; ${date}</span>
              </div>
            </div>`;
        }).join('');
      } catch (err) {
        // Silent fail — log is a nice-to-have
        console.error('Failed to load email log:', err);
      }
    }

    async function logout() {
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = '/login';
    }

    checkAuth();
  </script>


  <!-- ── Edit Address Modal ─────────────────────────────────── -->
  <div class="amodal-overlay" id="editAddressModal">
    <div class="amodal amodal-sm">
      <div class="amodal-hd">
        <h3 id="edit-address-title">Edit Address</h3>
        <button class="amodal-close" onclick="closeEditAddress()">&times;</button>
      </div>
      <div class="amodal-body">
        <div class="aresult" id="edit-address-result"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div class="afield">
            <label>First Name</label>
            <input type="text" id="ea-first-name" placeholder="First name">
          </div>
          <div class="afield">
            <label>Last Name</label>
            <input type="text" id="ea-last-name" placeholder="Last name">
          </div>
        </div>
        <div class="afield">
          <label>Company <span style="font-weight:400;color:var(--color-text-muted)">(optional)</span></label>
          <input type="text" id="ea-company" placeholder="Company name">
        </div>
        <div class="afield">
          <label>Street Address</label>
          <input type="text" id="ea-street-1" placeholder="Street line 1">
        </div>
        <div class="afield">
          <label>Street Line 2 <span style="font-weight:400;color:var(--color-text-muted)">(optional)</span></label>
          <input type="text" id="ea-street-2" placeholder="Apt, suite, unit, etc.">
        </div>
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:10px;">
          <div class="afield">
            <label>City</label>
            <input type="text" id="ea-city" placeholder="City">
          </div>
          <div class="afield">
            <label>State</label>
            <input type="text" id="ea-state" placeholder="CA">
          </div>
          <div class="afield">
            <label>ZIP</label>
            <input type="text" id="ea-zip" placeholder="90210">
          </div>
        </div>
        <div class="afield">
          <label>Country</label>
          <input type="text" id="ea-country" placeholder="United States">
        </div>
        <div class="afield">
          <label>Phone</label>
          <input type="text" id="ea-phone" placeholder="Phone number">
        </div>
        <div class="afield" id="ea-email-field">
          <label>Email <span style="font-weight:400;color:var(--color-text-muted)">(billing only)</span></label>
          <input type="email" id="ea-email" placeholder="customer@email.com">
        </div>
        <p class="anote" style="margin-top:4px;">&#9888; Changes save directly to BigCommerce and are permanent.</p>
      </div>
      <div class="amodal-ft">
        <button class="action-btn action-btn-neutral" onclick="closeEditAddress()">Cancel</button>
        <button class="action-btn action-btn-ship" id="ea-save-btn" onclick="submitEditAddress()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- ── Shipment Modal ─────────────────────────────────────── -->
  <div class="amodal-overlay" id="shipmentModal">
    <div class="amodal amodal-sm">
      <div class="amodal-hd">
        <h3>&#128230; Add Tracking / Create Shipment</h3>
        <button class="amodal-close" onclick="closeActionModal('shipmentModal')">&times;</button>
      </div>
      <div class="amodal-body">
        <div class="aresult" id="shipment-result"></div>
        <div class="afield"><label>Carrier</label>
          <select id="shipment-carrier">
            <option value="ups">UPS</option><option value="fedex">FedEx</option>
            <option value="usps">USPS</option><option value="dhl">DHL</option><option value="other">Other</option>
          </select>
        </div>
        <div class="afield"><label>Tracking Number</label>
          <input type="text" id="shipment-tracking" placeholder="e.g. 1Z999AA10123456784" autocomplete="off">
        </div>
        <div class="afield"><label>Items in this shipment</label>
          <div class="item-check-list" id="shipment-items-list"></div>
        </div>
      </div>
      <div class="amodal-ft">
        <button class="action-btn action-btn-neutral" onclick="closeActionModal('shipmentModal')">Cancel</button>
        <button class="action-btn action-btn-ship" id="shipment-submit-btn" onclick="submitShipment()">&#10003; Create Shipment</button>
      </div>
    </div>
  </div>

  <!-- ── Cancel Modal ───────────────────────────────────────── -->
  <div class="amodal-overlay" id="cancelModal">
    <div class="amodal amodal-sm">
      <div class="amodal-hd">
        <h3>&#10006; Cancel Order</h3>
        <button class="amodal-close" onclick="closeActionModal('cancelModal')">&times;</button>
      </div>
      <div class="amodal-body">
        <div class="aresult" id="cancel-result"></div>
        <div class="adanger-box"><strong>Warning:</strong> This will cancel order <strong id="cancel-order-id"></strong> in BigCommerce. This action cannot be undone.</div>
        <div class="afield"><label>Reason (optional)</label>
          <textarea id="cancel-reason" rows="2" placeholder="Customer requested cancellation..."></textarea>
        </div>
      </div>
      <div class="amodal-ft">
        <button class="action-btn action-btn-neutral" onclick="closeActionModal('cancelModal')">Go Back</button>
        <button class="action-btn action-btn-cancel" id="cancel-submit-btn" onclick="submitCancel()">Cancel Order</button>
      </div>
    </div>
  </div>

  <!-- ── Refund Modal — BC-style ─────────────────────────────── -->
  <div class="amodal-overlay" id="refundModal">
    <div class="amodal amodal-lg">
      <div class="amodal-hd">
        <h3>Refund Order <span id="refund-order-num" class="refund-order-num"></span></h3>
        <button class="amodal-close" onclick="closeActionModal('refundModal')">&times;</button>
      </div>
      <div class="amodal-body">
        <div class="aresult" id="refund-result"></div>

        <!-- Step 1: Item selection -->
        <div id="refund-step1">
          <!-- Order summary line -->
          <p class="refund-order-summary">
            Order total: <strong id="refund-order-total-lbl"></strong>
          </p>

          <!-- Tabs — mirrors BC exactly -->
          <div class="refund-tabs">
            <button class="rtab active" id="rtab-items"  onclick="refundSwitchTab('items')">Refund individual items</button>
            <button class="rtab"        id="rtab-entire" onclick="refundSwitchTab('entire')">Refund entire order</button>
            <button class="rtab"        id="rtab-custom" onclick="refundSwitchTab('custom')">Apply an order level refund</button>
          </div>

          <!-- Tab: Refund individual items -->
          <div id="refund-tab-items">
            <div class="refund-table-wrap">
              <table class="refund-table">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>SKU</th>
                    <th class="num">Qty ordered</th>
                    <th class="price">Unit price</th>
                    <th class="num">Units to refund</th>
                    <th class="price">Refund item total</th>
                  </tr>
                </thead>
                <tbody id="refund-items-tbody"></tbody>
              </table>
            </div>
            <div class="refund-estimated">
              Estimated refund: <strong id="refund-items-subtotal">$0.00</strong>
              <span class="refund-estimated-tax"> (tax calculated on continue)</span>
            </div>
          </div>

          <!-- Tab: Refund entire order -->
          <div id="refund-tab-entire" style="display:none;">
            <div class="refund-note warn">
              This will refund all items and shipping for the full order amount including tax. Click <strong>Continue</strong> to see the exact amount and choose a payment method.
            </div>
          </div>

          <!-- Tab: Apply an order level refund (custom amount) -->
          <div id="refund-tab-custom" style="display:none;">
            <div class="afield afield-narrow">
              <label>Refund Amount ($)</label>
              <input type="number" id="refund-custom-amount" min="0.01" step="0.01" placeholder="0.00">
              <p class="anote">Order total: <strong id="refund-custom-order-total"></strong> — tax-exempt custom amount</p>
            </div>
          </div>

          <div class="afield afield-mt">
            <label>Reason for refund (optional)</label>
            <textarea id="refund-reason" rows="2" placeholder="Defective item, customer return, wrong item shipped..."></textarea>
          </div>
        </div>

        <!-- Step 2: Summary + payment method -->
        <div id="refund-step2" style="display:none;">
          <!-- Refund summary table -->
          <p class="refund-section-title">Refund summary</p>
          <div class="refund-table-wrap">
            <table class="refund-table">
              <thead>
                <tr>
                  <th>Item</th><th>SKU</th>
                  <th class="num">Qty ordered</th><th class="price">Unit price</th>
                  <th class="num">Units to refund</th><th class="price">Refund item total</th>
                </tr>
              </thead>
              <tbody id="refund-summary-tbody"></tbody>
            </table>
          </div>
          <div class="refund-subtotals">
            <table>
              <tr><td>Refund subtotal</td><td id="refund-sum-subtotal">$0.00</td></tr>
              <tr><td>Tax refund</td><td id="refund-sum-tax">$0.00</td></tr>
              <tr class="refund-total-row"><td>Refund total</td><td id="refund-sum-total">$0.00</td></tr>
            </table>
          </div>

          <!-- Refund method -->
          <div class="refund-method-section">
            <p class="refund-section-title">Refund method</p>
            <p class="refund-section-sub">Select one of the methods below to complete your refund</p>
            <div id="refund-payment-methods"></div>
          </div>
        </div>
      </div>

      <div class="amodal-ft">
        <button class="action-btn action-btn-neutral" onclick="closeActionModal('refundModal')">Cancel</button>
        <button class="action-btn action-btn-neutral" id="refund-btn-back"     onclick="refundBack()"     style="display:none;">&#8592; Back</button>
        <button class="action-btn action-btn-ship"    id="refund-btn-continue" onclick="refundContinue()">Continue</button>
        <button class="action-btn action-btn-refund"  id="refund-btn-submit"   onclick="submitRefund()"   style="display:none;">Process refund</button>
      </div>
    </div>
  </div>

  <!-- ── Bulk Tracking Modal ──────────────────────────────────── -->
  <div class="bulk-overlay" id="bulkImportModal">
    <div class="bulk-modal">
      <div class="bulk-hd">
        <h3>&#128230; Import Tracking Numbers</h3>
        <button class="bulk-close" onclick="closeBulkModal()">&times;</button>
      </div>
      <div class="bulk-body">

        <!-- STEP 1: Upload CSV -->
        <div id="bulk-step-upload">
          <div class="bulk-drop" id="bulk-drop-zone"
               onclick="document.getElementById('bulk-file-input').click()"
               ondragover="bulkDragOver(event)" ondragleave="bulkDragLeave(event)" ondrop="bulkDrop(event)">
            <div class="bulk-drop-icon">&#128196;</div>
            <strong>Click to choose CSV or drag &amp; drop</strong>
            <p>Any CSV format — you'll map the columns in the next step</p>
            <input type="file" id="bulk-file-input" accept=".csv" style="display:none" onchange="bulkFileSelected(this.files[0])">
          </div>
          <div class="bulk-fname" id="bulk-file-name"></div>
        </div>

        <!-- STEP 2: Map fields -->
        <div id="bulk-step-map" style="display:none;">
          <div class="bulk-map-header">
            <p class="bulk-map-intro">Use the form below to define which import fields should map to which tracking number fields.</p>
            <p class="bulk-map-title">Link import fields</p>
            <div class="bulk-map-row">
              <label class="bulk-map-label">Match "Order number" with:</label>
              <select class="bulk-map-sel" id="bulk-col-order"></select>
            </div>
            <div class="bulk-map-row">
              <label class="bulk-map-label">Match "Tracking number" with:</label>
              <select class="bulk-map-sel" id="bulk-col-tracking"></select>
            </div>
            <div class="bulk-map-row">
              <label class="bulk-map-label">Match "Tracking carrier" with:</label>
              <select class="bulk-map-sel" id="bulk-col-carrier"></select>
            </div>
          </div>
          <select class="bulk-store-sel" id="bulk-store-select">
            <option value="1ink">1ink.com</option>
            <option value="needink">needink.com</option>
          </select>
          <div class="bulk-preview-count" id="bulk-preview-count"></div>
          <table class="bulk-preview-table" id="bulk-preview-table">
            <thead><tr><th>Order #</th><th>Tracking Number</th><th>Carrier</th></tr></thead>
            <tbody id="bulk-preview-body"></tbody>
          </table>
        </div>

        <!-- STEP 3: Progress -->
        <div class="bulk-prog-wrap" id="bulk-progress-wrap">
          <div class="bulk-prog-lbl">
            <span id="bulk-progress-text">Processing...</span>
            <span id="bulk-progress-pct">0%</span>
          </div>
          <div class="bulk-prog-bar"><div class="bulk-prog-fill" id="bulk-progress-fill"></div></div>
        </div>

        <!-- STEP 4: Results -->
        <div class="bulk-results" id="bulk-results">
          <div class="bulk-stats">
            <div class="bstat ok">  <span class="bstat-n" id="bulk-res-success">0</span><span class="bstat-l">Shipped</span></div>
            <div class="bstat skip"><span class="bstat-n" id="bulk-res-skipped">0</span><span class="bstat-l">Skipped</span></div>
            <div class="bstat fail"><span class="bstat-n" id="bulk-res-failed">0</span> <span class="bstat-l">Failed</span></div>
          </div>
          <div id="bulk-fail-section" style="display:none;">
            <p class="bulk-section-label danger">Failed orders:</p>
            <div class="bulk-fail-list" id="bulk-fail-list"></div>
          </div>
          <div id="bulk-skip-section" style="display:none;margin-top:10px;">
            <p class="bulk-section-label warning">Skipped orders:</p>
            <div class="bulk-fail-list" id="bulk-skip-list"></div>
          </div>
        </div>
      </div>
      <div class="bulk-ft">
        <button class="action-btn action-btn-neutral" id="bulk-back-btn" onclick="bulkGoBack()" style="display:none;">&#8592; Back</button>
        <button class="action-btn action-btn-neutral" onclick="closeBulkModal()">Close</button>
        <button class="action-btn action-btn-ship" id="bulk-import-btn" onclick="submitBulkImport()" disabled>&#128230; Import Tracking</button>
      </div>
    </div>
  </div>

  <script>
// ── Order Actions ────────────────────────────────────────────────
let _actionOrderId = null, _actionStore = null, _actionProducts = [], _actionOrderTotal = 0;

const ACTION_STATUS_OPTIONS = [
  { id: 11, label: 'Awaiting Fulfillment', perm: 'orders.status.update' },
  { id: 9,  label: 'Awaiting Shipment',    perm: 'orders.status.update' },
  { id: 10, label: 'Completed',            perm: 'orders.status.update' },
  { id: 2,  label: 'Shipped',              perm: 'orders.ship'          },
  { id: 3,  label: 'Partially Shipped',    perm: 'orders.ship'          },
  { id: 5,  label: 'Cancelled',            perm: 'orders.cancel'        },
  { id: 4,  label: 'Refunded',             perm: 'orders.refund'        },
  { id: 14, label: 'Partially Refunded',   perm: 'orders.refund'        },
];

function injectOrderActionsBar(orderId, order, data) {
  var perms = currentUserPermissions || [];
  var allowedStatuses = ACTION_STATUS_OPTIONS.filter(function(s) { return perms.includes(s.perm); });
  var hasTracking = perms.includes('orders.tracking.add');
  var hasCancel   = perms.includes('orders.cancel');
  var hasRefund   = perms.includes('orders.refund');

  if (allowedStatuses.length === 0 && !hasTracking && !hasCancel && !hasRefund) return;

  var previewContent = document.getElementById('preview-content-' + orderId);
  if (!previewContent) return;

  // Remove existing bar if refreshing
  var existing = document.getElementById('order-actions-' + orderId);
  if (existing) existing.remove();

  var bar = document.createElement('div');
  bar.className = 'order-actions';
  bar.id = 'order-actions-' + orderId;

  var label = document.createElement('span');
  label.className = 'order-actions-label';
  label.textContent = 'Actions';
  bar.appendChild(label);

  if (allowedStatuses.length > 0) {
    var sel = document.createElement('select');
    sel.className = 'action-status-select';
    sel.id = 'status-select-' + orderId;
    var defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = '\u2014 Update Status \u2014';
    sel.appendChild(defaultOpt);
    allowedStatuses.forEach(function(s) {
      var opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.label;
      sel.appendChild(opt);
    });
    bar.appendChild(sel);

    var setBtn = document.createElement('button');
    setBtn.className = 'action-status-btn';
    setBtn.textContent = '\u2713 Set';
    setBtn.onclick = function() { submitStatusUpdate(orderId); };
    bar.appendChild(setBtn);
  }

  if (hasTracking) {
    var btn = document.createElement('button');
    btn.className = 'action-btn action-btn-ship';
    btn.innerHTML = '&#128230; Add Tracking';
    btn.onclick = function() { openShipmentModal(orderId, data); };
    bar.appendChild(btn);
  }

  if (hasCancel) {
    var btn2 = document.createElement('button');
    btn2.className = 'action-btn action-btn-cancel';
    btn2.innerHTML = '&#10006; Cancel';
    btn2.onclick = function() { openCancelModal(orderId); };
    bar.appendChild(btn2);
  }

  if (hasRefund) {
    var btn3 = document.createElement('button');
    btn3.className = 'action-btn action-btn-refund';
    btn3.innerHTML = '&#36; Refund';
    btn3.onclick = function() { openRefundModal(orderId, data); };
    bar.appendChild(btn3);
  }

  var result = document.createElement('span');
  result.id = 'action-result-' + orderId;
  result.className = 'action-inline-result';
  bar.appendChild(result);

  previewContent.insertBefore(bar, previewContent.firstChild);
}

// ── Status update ────────────────────────────────────────────────
async function submitStatusUpdate(orderId) {
  var select   = document.getElementById('status-select-' + orderId);
  var statusId = parseInt(select && select.value);
  var resultEl = document.getElementById('action-result-' + orderId);
  if (!statusId) { showInlineResult(resultEl, 'Please select a status', 'error'); return; }
  var btn = select.nextElementSibling;
  btn.disabled = true; btn.textContent = 'Updating...';
  try {
    var res  = await fetch('/api/order/' + currentStore + '/' + orderId + '/status', {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ statusId: statusId })
    });
    var data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Update failed');
    showInlineResult(resultEl, '\u2713 Status set to "' + data.statusLabel + '"', 'success');
    select.value = '';
  } catch (err) {
    showInlineResult(resultEl, '\u2717 ' + err.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = '\u2713 Set';
  }
}

// ── Edit Address modal ────────────────────────────────────────────
var _editAddrType    = '';   // 'billing' or 'shipping'
var _editAddrOrderId = 0;
var _editAddrStore   = '';
var _editAddrId      = 0;    // shipping address id (0 for billing)

function openEditAddress(type, orderId, store, addressId, addrData) {
  _editAddrType    = type;
  _editAddrOrderId = orderId;
  _editAddrStore   = store;
  _editAddrId      = addressId || 0;

  document.getElementById('edit-address-title').textContent =
    type === 'billing' ? 'Edit Billing Address' : 'Edit Shipping Address';

  // Show/hide email field — billing only
  document.getElementById('ea-email-field').style.display = type === 'billing' ? '' : 'none';

  // Pre-fill all fields from the live address data passed in
  var a = addrData || {};
  document.getElementById('ea-first-name').value = a.first_name || '';
  document.getElementById('ea-last-name').value  = a.last_name  || '';
  document.getElementById('ea-company').value    = a.company    || '';
  document.getElementById('ea-street-1').value   = a.street_1   || '';
  document.getElementById('ea-street-2').value   = a.street_2   || '';
  document.getElementById('ea-city').value       = a.city       || '';
  document.getElementById('ea-state').value      = a.state      || '';
  document.getElementById('ea-zip').value        = a.zip        || '';
  document.getElementById('ea-country').value    = a.country    || '';
  document.getElementById('ea-phone').value      = a.phone      || '';
  if (type === 'billing') {
    document.getElementById('ea-email').value    = a.email      || '';
  }

  // Clear any previous result message
  var r = document.getElementById('edit-address-result');
  r.className = 'aresult'; r.textContent = '';

  document.getElementById('editAddressModal').classList.add('active');
}

function closeEditAddress() {
  document.getElementById('editAddressModal').classList.remove('active');
  // Clear all fields
  ['first-name','last-name','company','street-1','street-2','city','state','zip','country','phone','email'].forEach(function(f) {
    var el = document.getElementById('ea-' + f);
    if (el) el.value = '';
  });
}

async function submitEditAddress() {
  var btn = document.getElementById('ea-save-btn');
  var result = document.getElementById('edit-address-result');
  result.className = 'aresult'; result.textContent = '';

  var body = {
    first_name: document.getElementById('ea-first-name').value.trim(),
    last_name:  document.getElementById('ea-last-name').value.trim(),
    company:    document.getElementById('ea-company').value.trim(),
    street_1:   document.getElementById('ea-street-1').value.trim(),
    street_2:   document.getElementById('ea-street-2').value.trim(),
    city:       document.getElementById('ea-city').value.trim(),
    state:      document.getElementById('ea-state').value.trim(),
    zip:        document.getElementById('ea-zip').value.trim(),
    country:    document.getElementById('ea-country').value.trim(),
    phone:      document.getElementById('ea-phone').value.trim(),
  };
  if (_editAddrType === 'billing') {
    body.email = document.getElementById('ea-email').value.trim();
  }

  // Remove empty optional fields (company, street_2) so we don't overwrite with blanks
  if (!body.company)  delete body.company;
  if (!body.street_2) delete body.street_2;

  if (!body.first_name || !body.last_name || !body.street_1 || !body.city || !body.state || !body.zip) {
    result.className = 'aresult error';
    result.textContent = 'First name, last name, street, city, state, and ZIP are required.';
    return;
  }

  var url = _editAddrType === 'billing'
    ? '/api/order/' + _editAddrStore + '/' + _editAddrOrderId + '/billing-address'
    : '/api/order/' + _editAddrStore + '/' + _editAddrOrderId + '/shipping-address/' + _editAddrId;

  btn.disabled = true;
  btn.textContent = 'Saving…';

  try {
    var res = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    var data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Save failed');

    result.className = 'aresult success';
    result.textContent = (_editAddrType === 'billing' ? 'Billing' : 'Shipping') + ' address updated in BigCommerce.';

    // Refresh the order preview to show new address
    setTimeout(function() {
      closeEditAddress();
      var panel = document.getElementById('preview-' + _editAddrOrderId);
      if (panel && panel.classList.contains('show')) {
        loadPreview(_editAddrOrderId, _editAddrStore);
      }
    }, 1200);
  } catch (err) {
    result.className = 'aresult error';
    result.textContent = err.message;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save Changes';
  }
}


// ── Shipment modal ───────────────────────────────────────────────
function openShipmentModal(orderId, data) {
  _actionOrderId  = orderId;
  _actionStore    = currentStore;
  _actionProducts = (data && data.products) ? data.products :
                    (orderDetailsCache[orderId] && orderDetailsCache[orderId].products ? orderDetailsCache[orderId].products : []);

  var listEl = document.getElementById('shipment-items-list');
  if (_actionProducts.length === 0) {
    listEl.innerHTML = '<p class="no-results">No items found.</p>';
  } else {
    listEl.innerHTML = _actionProducts.map(function(p) {
      return '<div class="item-check-row">' +
        '<input type="checkbox" id="ship-item-' + p.id + '" checked>' +
        '<input type="number" id="ship-qty-' + p.id + '" min="1" max="' + p.quantity + '" value="' + p.quantity + '">' +
        '<label for="ship-item-' + p.id + '" class="item-label">' + (p.sku ? p.sku + ' \u2014 ' : '') + p.name + '</label>' +
        '</div>';
    }).join('');
  }
  document.getElementById('shipment-tracking').value = '';
  document.getElementById('shipment-carrier').value  = 'ups';
  clearModalResult('shipment-result');
  document.getElementById('shipmentModal').classList.add('active');
}

async function submitShipment() {
  var tracking = document.getElementById('shipment-tracking').value.trim();
  var carrier  = document.getElementById('shipment-carrier').value;
  if (!tracking) { showModalResult('shipment-result', 'Tracking number is required', 'error'); return; }

  var items = _actionProducts.filter(function(p) {
    var cb = document.getElementById('ship-item-' + p.id);
    return cb && cb.checked;
  }).map(function(p) {
    var qtyEl = document.getElementById('ship-qty-' + p.id);
    return { order_product_id: p.id, quantity: parseInt(qtyEl ? qtyEl.value : p.quantity) };
  });
  if (_actionProducts.length > 0 && items.length === 0) {
    showModalResult('shipment-result', 'Select at least one item', 'error'); return;
  }

  var btn = document.getElementById('shipment-submit-btn');
  btn.disabled = true; btn.textContent = 'Creating...';
  try {
    var res  = await fetch('/api/order/' + _actionStore + '/' + _actionOrderId + '/shipment', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trackingNumber: tracking, carrier: carrier, items: items })
    });
    var data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Failed');
    showModalResult('shipment-result', '\u2713 Shipment created! Tracking: ' + tracking, 'success');
    setTimeout(function() {
      delete orderDetailsCache[_actionOrderId];
      closeActionModal('shipmentModal');
      togglePreview(null, _actionOrderId);
    }, 1500);
  } catch (err) {
    showModalResult('shipment-result', '\u2717 ' + err.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = '\u2713 Create Shipment';
  }
}

// ── Cancel modal ─────────────────────────────────────────────────
function openCancelModal(orderId) {
  _actionOrderId = orderId;
  _actionStore   = currentStore;
  document.getElementById('cancel-order-id').textContent = '#' + orderId;
  document.getElementById('cancel-reason').value = '';
  clearModalResult('cancel-result');
  document.getElementById('cancelModal').classList.add('active');
}

async function submitCancel() {
  var btn = document.getElementById('cancel-submit-btn');
  btn.disabled = true; btn.textContent = 'Cancelling...';
  try {
    var res  = await fetch('/api/order/' + _actionStore + '/' + _actionOrderId + '/status', {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ statusId: 5 })
    });
    var data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Failed');
    showModalResult('cancel-result', '\u2713 Order #' + _actionOrderId + ' cancelled', 'success');
    setTimeout(function() { closeActionModal('cancelModal'); }, 2000);
  } catch (err) {
    showModalResult('cancel-result', '\u2717 ' + err.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'Cancel Order';
  }
}

// ── Modal helpers ─────────────────────────────────────────────────
function closeActionModal(id) {
  var el = document.getElementById(id);
  if (el) el.classList.remove('active');
}
function showModalResult(id, msg, type) {
  var el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = msg; el.className = 'action-result ' + type;
}
function clearModalResult(id) {
  var el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = ''; el.className = 'action-result';
}
function showInlineResult(el, msg, type) {
  if (!el) return;
  el.textContent = msg; el.className = 'action-inline-result ' + type;
}

['shipmentModal','cancelModal','refundModal'].forEach(function(id) {
  var el = document.getElementById(id);
  if (el) el.addEventListener('click', function(e) { if (e.target === this) closeActionModal(id); });
});

// ── Bulk Tracking ────────────────────────────────────────────────
var _bulkFile = null, _bulkRows = [], _bulkHeaders = [], _bulkCsvText = '';

function openBulkImportModal() {
  _bulkFile = null; _bulkRows = []; _bulkHeaders = [];
  document.getElementById('bulk-step-upload').style.display = '';
  document.getElementById('bulk-step-map').style.display = 'none';
  document.getElementById('bulk-progress-wrap').style.display = 'none';
  document.getElementById('bulk-results').style.display = 'none';
  document.getElementById('bulk-file-name').style.display = 'none';
  document.getElementById('bulk-preview-table').style.display = 'none';
  document.getElementById('bulk-preview-count').style.display = 'none';
  document.getElementById('bulk-preview-body').innerHTML = '';
  document.getElementById('bulk-fail-section').style.display = 'none';
  document.getElementById('bulk-skip-section').style.display = 'none';
  document.getElementById('bulk-import-btn').disabled = true;
  document.getElementById('bulk-import-btn').textContent = '⬆ Import Tracking';
  document.getElementById('bulk-import-btn').onclick = submitBulkImport;
  document.getElementById('bulk-back-btn').style.display = 'none';
  document.getElementById('bulk-file-input').value = '';
  document.getElementById('bulk-store-select').value = currentStore || '1ink';
  document.getElementById('bulkImportModal').classList.add('active');
}
function closeBulkModal() { document.getElementById('bulkImportModal').classList.remove('active'); }
function bulkGoBack() {
  document.getElementById('bulk-step-upload').style.display = '';
  document.getElementById('bulk-step-map').style.display = 'none';
  document.getElementById('bulk-back-btn').style.display = 'none';
  document.getElementById('bulk-import-btn').disabled = true;
}
function bulkDragOver(e)  { e.preventDefault(); document.getElementById('bulk-drop-zone').classList.add('dragover'); }
function bulkDragLeave()  { document.getElementById('bulk-drop-zone').classList.remove('dragover'); }
function bulkDrop(e) {
  e.preventDefault(); document.getElementById('bulk-drop-zone').classList.remove('dragover');
  var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) bulkFileSelected(f);
}
function bulkFileSelected(file) {
  if (!file || !file.name.toLowerCase().endsWith('.csv')) { alert('Please select a CSV file.'); return; }
  _bulkFile = file;
  document.getElementById('bulk-file-name').textContent = '\u2705 ' + file.name;
  document.getElementById('bulk-file-name').style.display = 'block';
  var reader = new FileReader();
  reader.onload = function(e) { bulkReadHeaders(e.target.result); };
  reader.readAsText(file);
}

// Parse CSV headers and move to step 2
function bulkReadHeaders(text) {
  var lines = text.split(/\r?\n/);
  var firstLine = '';
  for (var i = 0; i < lines.length; i++) {
    if (lines[i].trim()) { firstLine = lines[i]; break; }
  }
  // Parse header columns
  var headers = [], cur = '', inQ = false;
  for (var j = 0; j < firstLine.length; j++) {
    var ch = firstLine[j];
    if (ch === '"') { inQ = !inQ; continue; }
    if (ch === ',' && !inQ) { headers.push(cur.trim()); cur = ''; continue; }
    cur += ch;
  }
  headers.push(cur.trim());
  _bulkHeaders = headers;
  _bulkCsvText = text;

  // Build dropdown options — "Ignore" + each column with its header name
  var ignoreOpt = '<option value="-1">-- Ignore --</option>';
  var opts = ignoreOpt + headers.map(function(h, i) {
    return '<option value="' + i + '">' + (h || 'Column ' + (i+1)) + '</option>';
  }).join('');

  document.getElementById('bulk-col-order').innerHTML = opts;
  document.getElementById('bulk-col-tracking').innerHTML = opts;
  document.getElementById('bulk-col-carrier').innerHTML = opts;

  // Auto-detect columns by common header names
  headers.forEach(function(h, i) {
    var hl = h.toLowerCase().replace(/[\s_#]/g,'');
    if (/order|ordernumber|orderid|order#/.test(hl))   document.getElementById('bulk-col-order').value = i;
    if (/track|trackingnumber|trackingnumbers|tracking#/.test(hl)) document.getElementById('bulk-col-tracking').value = i;
    if (/carrier|shippingcarrier|courier|shipper/.test(hl)) document.getElementById('bulk-col-carrier').value = i;
  });

  // Wire dropdowns to update preview live
  ['bulk-col-order','bulk-col-tracking','bulk-col-carrier'].forEach(function(id) {
    document.getElementById(id).onchange = bulkUpdatePreview;
  });

  // Show step 2
  document.getElementById('bulk-step-upload').style.display = 'none';
  document.getElementById('bulk-step-map').style.display = '';
  document.getElementById('bulk-back-btn').style.display = '';
  bulkUpdatePreview();
}

function bulkParseCsv(text) {
  var lines = text.split(/\r?\n/);
  var result = [];
  var headerSkipped = false;
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim(); if (!line) continue;
    var fields = [], cur = '', inQ = false;
    for (var j = 0; j < line.length; j++) {
      var ch = line[j];
      if (ch === '"') { inQ = !inQ; continue; }
      if (ch === ',' && !inQ) { fields.push(cur); cur = ''; continue; }
      cur += ch;
    }
    fields.push(cur);
    if (!headerSkipped) { headerSkipped = true; result.push(fields); continue; } // first row = headers
    result.push(fields);
  }
  return result; // first element is header row
}

function bulkUpdatePreview() {
  var orderCol    = parseInt(document.getElementById('bulk-col-order').value);
  var trackingCol = parseInt(document.getElementById('bulk-col-tracking').value);
  var carrierCol  = parseInt(document.getElementById('bulk-col-carrier').value);

  if (orderCol < 0 || trackingCol < 0) {
    document.getElementById('bulk-preview-table').style.display = 'none';
    document.getElementById('bulk-preview-count').style.display = 'none';
    document.getElementById('bulk-import-btn').disabled = true;
    return;
  }

  var allRows = bulkParseCsv(_bulkCsvText);
  var dataRows = allRows.slice(1); // skip header row
  var rows = [];
  dataRows.forEach(function(fields) {
    var orderId  = (fields[orderCol]    || '').replace(/[\r\n\s"#]+/g,'').trim();
    var tracking = (fields[trackingCol] || '').replace(/[\r\n\s"]+/g,'').trim();
    var carrier  = carrierCol >= 0 ? (fields[carrierCol] || '').trim() : '';
    if (orderId && tracking && /^\d+$/.test(orderId)) rows.push({ orderId, tracking, carrier });
  });
  _bulkRows = rows;

  var tbody = document.getElementById('bulk-preview-body');
  var html = rows.slice(0,10).map(function(r) {
    return '<tr><td>#' + r.orderId + '</td><td class="bulk-preview-table-tracking">' + r.tracking + '</td><td>' + (r.carrier || '—') + '</td></tr>';
  }).join('');
  if (rows.length > 10) html += '<tr><td colspan="3" class="bulk-more-rows">...and ' + (rows.length-10) + ' more rows</td></tr>';
  tbody.innerHTML = html;
  document.getElementById('bulk-preview-table').style.display = rows.length ? 'table' : 'none';
  document.getElementById('bulk-preview-count').style.display = rows.length ? 'block' : 'none';
  document.getElementById('bulk-preview-count').textContent = rows.length + ' orders ready to import';
  document.getElementById('bulk-import-btn').disabled = rows.length === 0;
}

async function submitBulkImport() {
  if (!_bulkFile || _bulkRows.length === 0) return;
  var store = document.getElementById('bulk-store-select').value;
  var orderCol    = document.getElementById('bulk-col-order').value;
  var trackingCol = document.getElementById('bulk-col-tracking').value;
  var carrierCol  = document.getElementById('bulk-col-carrier').value;
  document.getElementById('bulk-step-map').style.display = 'none';
  document.getElementById('bulk-back-btn').style.display = 'none';
  document.getElementById('bulk-progress-wrap').style.display = 'block';
  document.getElementById('bulk-import-btn').disabled = true;
  var fakeP = 0;
  var interval = setInterval(function() {
    if (fakeP < 85) { fakeP += Math.random() * 3; setBulkProgress(Math.min(fakeP,85), _bulkRows.length); }
  }, 400);
  var fd = new FormData();
  fd.append('csvFile', _bulkFile);
  fd.append('store', store);
  fd.append('orderCol', orderCol);
  fd.append('trackingCol', trackingCol);
  fd.append('carrierCol', carrierCol);
  try {
    var res  = await fetch('/api/bulk-tracking', { method: 'POST', body: fd });
    var data = await res.json();
    clearInterval(interval); setBulkProgress(100, _bulkRows.length);
    await new Promise(function(r) { setTimeout(r, 500); });
    document.getElementById('bulk-progress-wrap').style.display = 'none';
    if (!res.ok) throw new Error(data.error || 'Import failed');
    var results = data.results;
    document.getElementById('bulk-res-success').textContent = results.success.length;
    document.getElementById('bulk-res-skipped').textContent = results.skipped.length;
    document.getElementById('bulk-res-failed').textContent  = results.failed.length;
    if (results.failed.length > 0) {
      document.getElementById('bulk-fail-section').style.display = 'block';
      document.getElementById('bulk-fail-list').innerHTML = results.failed.map(function(f) {
        return '<div class="bulk-fail-row"><span class="bulk-fail-order">#' + f.orderId + '</span><span class="bulk-fail-reason">' + f.reason + '</span></div>';
      }).join('');
    }
    if (results.skipped.length > 0) {
      document.getElementById('bulk-skip-section').style.display = 'block';
      document.getElementById('bulk-skip-list').innerHTML = results.skipped.map(function(f) {
        return '<div class="bulk-fail-row"><span class="bulk-fail-order">#' + f.orderId + '</span><span class="bulk-fail-reason">' + f.reason + '</span></div>';
      }).join('');
    }
    document.getElementById('bulk-results').style.display = 'block';
    document.getElementById('bulk-import-btn').disabled = false;
    document.getElementById('bulk-import-btn').textContent = 'Import Another';
    document.getElementById('bulk-import-btn').onclick = openBulkImportModal;
  } catch (err) {
    clearInterval(interval);
    document.getElementById('bulk-progress-wrap').style.display = 'none';
    document.getElementById('bulk-step-map').style.display = '';
    document.getElementById('bulk-back-btn').style.display = '';
    document.getElementById('bulk-import-btn').disabled = false;
    alert('Import failed: ' + err.message);
  }
}
function setBulkProgress(pct, total) {
  var p = Math.round(pct);
  document.getElementById('bulk-progress-fill').style.width = p + '%';
  document.getElementById('bulk-progress-pct').textContent  = p + '%';
  document.getElementById('bulk-progress-text').textContent = p < 100 ? 'Processing ' + total + ' orders...' : 'Finalizing...';
}
var bulkModalEl = document.getElementById('bulkImportModal');
if (bulkModalEl) bulkModalEl.addEventListener('click', function(e) { if (e.target === this) closeBulkModal(); });
// ═══════════════════════════════════════════════════════════════
// REFUND MODAL — mirrors BigCommerce refund UI exactly
// Step 1: Select items / method  →  Step 2: Summary + payment
// ═══════════════════════════════════════════════════════════════

var _ref = {
  orderId: null, store: null, order: null, products: [],
  addressId: null, shippingCost: 0, tab: 'items',
  quoteItems: null, payments: [],
};

function openRefundModal(orderId, data) {
  var cache       = orderDetailsCache[orderId] || {};
  _ref.orderId    = orderId;
  _ref.store      = currentStore;
  _ref.order      = (data && data.order)    || cache.order    || null;
  _ref.products   = (data && data.products) || cache.products || [];
  var addresses   = (data && data.shippingAddresses) || cache.shippingAddresses || [];
  _ref.addressId  = addresses.length ? addresses[0].id : null;
  _ref.shippingCost = parseFloat(
    (_ref.order && (_ref.order.shipping_cost_inc_tax || _ref.order.shipping_cost_ex_tax)) || 0
  );
  _ref.quoteItems = null;
  _ref.payments   = [];

  var totalStr = '$' + parseFloat((_ref.order && _ref.order.total_inc_tax) || 0).toFixed(2);
  document.getElementById('refund-order-num').textContent       = '#' + orderId;
  document.getElementById('refund-order-total-lbl').textContent = totalStr;
  var custLbl = document.getElementById('refund-custom-order-total');
  if (custLbl) custLbl.textContent = totalStr;

  refundSwitchTab('items');
  refundGoStep(1);
  clearModalResult('refund-result');
  document.getElementById('refundModal').classList.add('active');
}

// ── Tabs ─────────────────────────────────────────────────────────
function refundSwitchTab(tab) {
  _ref.tab = tab;
  ['items','entire','custom'].forEach(function(t) {
    document.getElementById('rtab-' + t).classList.toggle('active', t === tab);
  });
  document.getElementById('refund-tab-items').style.display  = tab === 'items'  ? '' : 'none';
  document.getElementById('refund-tab-entire').style.display = tab === 'entire' ? '' : 'none';
  document.getElementById('refund-tab-custom').style.display = tab === 'custom' ? '' : 'none';
  if (tab === 'items') refundBuildItemsTable();
  clearModalResult('refund-result');
}

function refundBuildItemsTable() {
  var tbody = document.getElementById('refund-items-tbody');
  var rows = _ref.products.map(function(p) {
    var unit = parseFloat(p.base_price || p.price_inc_tax || 0);
    return '<tr data-pid="' + p.id + '" data-unit="' + unit + '" data-maxqty="' + p.quantity + '">' +
      '<td class="rtd-item"><div class="ri-name">' + _esc(p.name) + '</div></td>' +
      '<td class="rtd-sku">'  + (p.sku ? _esc(p.sku) : '—') + '</td>' +
      '<td class="rtd-num">'  + p.quantity + '</td>' +
      '<td class="rtd-price">$' + unit.toFixed(2) + '</td>' +
      '<td class="rtd-num">' +
        '<input type="number" class="ri-qty" id="rqty-' + p.id + '" ' +
          'min="0" max="' + p.quantity + '" value="0" oninput="refundQtyChanged()">' +
      '</td>' +
      '<td class="rtd-price ri-linetotal" id="rline-' + p.id + '">$0.00</td>' +
    '</tr>';
  });
  if (_ref.shippingCost > 0 && _ref.addressId) {
    var addr = (_ref.order && _ref.order.billing_address)
      ? [_ref.order.billing_address.street_1, _ref.order.billing_address.city,
         _ref.order.billing_address.state].filter(Boolean).join(', ') : '';
    rows.push(
      '<tr id="refund-ship-row">' +
        '<td class="rtd-item"><div class="ri-name">Shipping cost</div>' +
          (addr ? '<div class="ri-subname">' + _esc(addr) + '</div>' : '') +
        '</td>' +
        '<td class="rtd-sku">—</td>' +
        '<td class="rtd-num">—</td>' +
        '<td class="rtd-price">$' + _ref.shippingCost.toFixed(2) + '</td>' +
        '<td class="rtd-num">' +
          '<input type="number" id="rship-amt" min="0" max="' + _ref.shippingCost + '" ' +
            'step="0.01" value="0" class="ri-qty ri-ship" placeholder="0.00" oninput="refundQtyChanged()">' +
        '</td>' +
        '<td class="rtd-price ri-linetotal" id="rline-ship">$0.00</td>' +
      '</tr>'
    );
  }
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="6" class="table-empty-cell">No items found</td></tr>';
  } else {
    tbody.innerHTML = rows.join('');
  }
  refundQtyChanged();
}

function refundQtyChanged() {
  var subtotal = 0;
  _ref.products.forEach(function(p) {
    var inp  = document.getElementById('rqty-' + p.id);
    var qty  = inp ? Math.max(0, Math.min(parseInt(inp.value) || 0, p.quantity)) : 0;
    var unit = parseFloat(p.base_price || p.price_inc_tax || 0);
    var lt   = qty * unit;
    subtotal += lt;
    var cell = document.getElementById('rline-' + p.id);
    if (cell) cell.textContent = '$' + lt.toFixed(2);
  });
  var ship     = document.getElementById('rship-amt');
  var shipAmt  = ship ? Math.max(0, parseFloat(ship.value) || 0) : 0;
  var shipCell = document.getElementById('rline-ship');
  if (shipCell) shipCell.textContent = '$' + shipAmt.toFixed(2);
  var lbl = document.getElementById('refund-items-subtotal');
  if (lbl) lbl.textContent = '~$' + (subtotal + shipAmt).toFixed(2);
}

// ── Step navigation ───────────────────────────────────────────────
function refundGoStep(n) {
  document.getElementById('refund-step1').style.display = n === 1 ? '' : 'none';
  document.getElementById('refund-step2').style.display = n === 2 ? '' : 'none';
  document.getElementById('refund-btn-continue').style.display = n === 1 ? '' : 'none';
  document.getElementById('refund-btn-back').style.display     = n === 2 ? '' : 'none';
  document.getElementById('refund-btn-submit').style.display   = n === 2 ? '' : 'none';
}

async function refundContinue() {
  clearModalResult('refund-result');
  var quoteBody = {};

  if (_ref.tab === 'items') {
    var products = [];
    _ref.products.forEach(function(p) {
      var inp = document.getElementById('rqty-' + p.id);
      var qty = inp ? Math.max(0, Math.min(parseInt(inp.value) || 0, p.quantity)) : 0;
      if (qty > 0) products.push({ order_product_id: p.id, quantity: qty });
    });
    var shipInp = document.getElementById('rship-amt');
    var shipAmt = shipInp ? parseFloat(shipInp.value) || 0 : 0;
    var shipping = (shipAmt > 0 && _ref.addressId)
      ? { order_address_id: _ref.addressId, amount: shipAmt } : null;
    if (!products.length && !shipping) {
      showModalResult('refund-result', 'Select at least one item or a shipping amount to refund', 'error');
      return;
    }
    quoteBody = { products: products, shipping: shipping };

  } else if (_ref.tab === 'entire') {
    var allProds = _ref.products.map(function(p) {
      return { order_product_id: p.id, quantity: p.quantity };
    });
    if (!allProds.length) {
      showModalResult('refund-result', 'No items found on this order', 'error'); return;
    }
    var allShip = (_ref.shippingCost > 0 && _ref.addressId)
      ? { order_address_id: _ref.addressId, amount: _ref.shippingCost } : null;
    quoteBody = { products: allProds, shipping: allShip };

  } else {
    var amt = parseFloat(document.getElementById('refund-custom-amount').value);
    if (!amt || amt <= 0) {
      showModalResult('refund-result', 'Enter a valid refund amount', 'error'); return;
    }
    var maxAmt = parseFloat((_ref.order && _ref.order.total_inc_tax) || 0);
    if (maxAmt > 0 && amt > maxAmt) {
      showModalResult('refund-result', 'Amount exceeds order total ($' + maxAmt.toFixed(2) + ')', 'error'); return;
    }
    quoteBody = { customAmount: amt };
  }

  var btn = document.getElementById('refund-btn-continue');
  btn.disabled = true; btn.textContent = 'Calculating…';

  try {
    var res  = await fetch('/api/order/' + _ref.store + '/' + _ref.orderId + '/refund-quote', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(quoteBody)
    });
    var data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Could not get refund quote');

    _ref.quoteItems = data.quoteItems;
    _ref.payments   = data.payments || [];

    // ── Summary table ─────────────────────────────────────────────
    var sumRows = '';
    if (_ref.tab !== 'custom') {
      _ref.products.forEach(function(p) {
        var qty = _ref.tab === 'entire' ? p.quantity
          : (function() { var i = document.getElementById('rqty-' + p.id); return i ? parseInt(i.value) || 0 : 0; })();
        if (qty <= 0) return;
        var unit = parseFloat(p.base_price || p.price_inc_tax || 0);
        sumRows += '<tr>' +
          '<td class="rtd-item"><div class="ri-name">' + _esc(p.name) + '</div></td>' +
          '<td class="rtd-sku">' + (p.sku ? _esc(p.sku) : '—') + '</td>' +
          '<td class="rtd-num">' + p.quantity + '</td>' +
          '<td class="rtd-price">$' + unit.toFixed(2) + '</td>' +
          '<td class="rtd-num">' + qty + '</td>' +
          '<td class="rtd-price">$' + (qty * unit).toFixed(2) + '</td>' +
        '</tr>';
      });
      var s2 = document.getElementById('rship-amt');
      var sA = _ref.tab === 'entire' ? _ref.shippingCost : (s2 ? parseFloat(s2.value) || 0 : 0);
      if (sA > 0) {
        sumRows += '<tr>' +
          '<td class="rtd-item"><div class="ri-name">Shipping cost</div></td>' +
          '<td class="rtd-sku">—</td><td class="rtd-num">—</td>' +
          '<td class="rtd-price">$' + _ref.shippingCost.toFixed(2) + '</td>' +
          '<td class="rtd-num">—</td>' +
          '<td class="rtd-price">$' + sA.toFixed(2) + '</td>' +
        '</tr>';
      }
    } else {
      sumRows = '<tr><td colspan="4" class="refund-custom-label">Custom refund</td>' +
        '<td class="rtd-num">—</td>' +
        '<td class="rtd-price">$' + parseFloat(document.getElementById('refund-custom-amount').value).toFixed(2) + '</td></tr>';
    }
    document.getElementById('refund-summary-tbody').innerHTML = sumRows;

    var tax = parseFloat(data.total_tax || 0);
    var total = parseFloat(data.total_amount || 0);
    document.getElementById('refund-sum-subtotal').textContent = '$' + Math.max(0, total - tax).toFixed(2);
    document.getElementById('refund-sum-tax').textContent      = '$' + tax.toFixed(2);
    document.getElementById('refund-sum-total').textContent    = '$' + total.toFixed(2);

    // ── Payment methods ───────────────────────────────────────────
    var methodsHtml = '';
    var hasOnline = _ref.payments.some(function(p) { return !p.offline && p.provider_id !== 'storecredit'; });
    if (hasOnline) {
      methodsHtml += '<div class="refund-note warn">Please note: your online payment provider may have a settlement period before refunds can be processed.</div>';
    }

    if (_ref.payments.length === 0) {
      methodsHtml += '<div class="refund-note warn">No payment methods are available. The payment may not have settled yet.</div>';
    } else {
      _ref.payments.forEach(function(p, i) {
        var isCard   = !p.offline && p.provider_id !== 'storecredit';
        var isCredit = p.provider_id === 'storecredit';
        var title, desc, extra = '';
        if (isCredit) {
          title = 'Store Credit: <strong>$' + parseFloat(p.amount).toFixed(2) + '</strong>';
          desc  = 'This amount will be credited to customer\'s account.';
        } else if (p.offline) {
          title = 'Refund customer through third party provider: <strong>$' + parseFloat(p.amount).toFixed(2) + '</strong>';
          desc  = 'Refund processed external to BigCommerce.';
        } else {
          title = 'Debit / Credit Card: <strong>$' + parseFloat(p.amount).toFixed(2) + '</strong>';
          desc  = 'Funds will be returned via this payment provider.';
          extra = '<div class="refund-external-wrap" id="refund-ext-' + i + '" style="display:none;">' +
            '<label class="refund-external-label">' +
              '<input type="checkbox" id="refund-extcb-' + i + '" onchange="refundToggleExternal(' + i + ')">' +
              '<div>' +
                '<div class="refund-external-title">Refund transaction processed external to BigCommerce</div>' +
                '<div class="refund-external-desc">BigCommerce will not perform the refund because the amount was refunded directly through the payment provider.</div>' +
              '</div>' +
            '</label>' +
          '</div>';
        }
        methodsHtml +=
          '<div class="refund-method-card" id="rmethod-' + i + '">' +
            '<label class="refund-method-row">' +
              '<input type="radio" name="refund-payment" value="' + i + '" ' + (i === 0 ? 'checked' : '') +
                ' onchange="refundSelectMethod(' + i + ')">' +
              '<div><div class="rm-title">' + title + '</div><div class="rm-desc">' + desc + '</div></div>' +
            '</label>' +
            extra +
          '</div>';
      });
    }
    document.getElementById('refund-payment-methods').innerHTML = methodsHtml;
    document.getElementById('refund-btn-submit').disabled = _ref.payments.length === 0;

    if (_ref.payments.length > 0) refundSelectMethod(0);
    refundGoStep(2);
  } catch (err) {
    showModalResult('refund-result', '✗ ' + err.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'Continue';
  }
}

function refundSelectMethod(idx) {
  _ref.payments.forEach(function(p, i) {
    var card = document.getElementById('rmethod-' + i);
    if (card) card.classList.toggle('selected', i === idx);
    var ext = document.getElementById('refund-ext-' + i);
    if (ext) ext.style.display = (i === idx) ? '' : 'none';
  });
}

function refundToggleExternal(idx) {
  var cb = document.getElementById('refund-extcb-' + idx);
  if (cb && _ref.payments[idx]) _ref.payments[idx]._ext = cb.checked;
}

function refundBack() {
  refundGoStep(1);
  clearModalResult('refund-result');
  var btn = document.getElementById('refund-btn-submit');
  btn.disabled = false; btn.textContent = 'Process refund';
}

async function submitRefund() {
  if (!_ref.quoteItems || !_ref.payments.length) return;
  var reason = document.getElementById('refund-reason').value.trim();
  var selIdx = 0;
  document.querySelectorAll('input[name="refund-payment"]').forEach(function(r) {
    if (r.checked) selIdx = parseInt(r.value);
  });
  var payment = Object.assign({}, _ref.payments[selIdx]);
  if (payment._ext) { payment.offline = true; }
  delete payment._ext;

  var btn = document.getElementById('refund-btn-submit');
  btn.disabled = true; btn.textContent = 'Processing…';
  clearModalResult('refund-result');

  try {
    var res  = await fetch('/api/order/' + _ref.store + '/' + _ref.orderId + '/refund', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ quoteItems: _ref.quoteItems, selectedPayment: payment, reason: reason })
    });
    var data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Refund failed');
    showModalResult('refund-result', '✓ Refund of $' + parseFloat(payment.amount).toFixed(2) + ' processed successfully', 'success');
    setTimeout(function() {
      closeActionModal('refundModal');
      delete orderDetailsCache[_ref.orderId];
    }, 2500);
  } catch (err) {
    showModalResult('refund-result', '✗ ' + err.message, 'error');
    btn.disabled = false; btn.textContent = 'Process refund';
  }
}

function _esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

  </script>

</body>
</html>